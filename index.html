<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>FLOORPLANNER, BASED ON HOME ROUGH EDITOR v0.95</title>
  <!--
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="all.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  -->
  <link rel="stylesheet" href="css/style.css">
</head>

<body style="background:#f2eee5;margin:0;padding:0;" class="developerX">

<div id="extension-floorplanner-content">
    
  <div id="extension-floorplanner-content-container">
		<!--
		<div id="extension-floorplanner-first-run-hint">
			<div>
				<h1>üè† Floorplanner</h1>
				<p>This design tool allows you to draw a floorplan for your home. Start by clicking on the wall button to the left, and drawing the first room.</p>
				<div style="text-align:right">
					<button class="text-button" id="extension-floorplanner-accept-limitations-button">I understand</button>
				</div>
			</div>
		</div>
		-->
    <div id="extension-floorplanner-main">
	    <div id="extension-floorplanner-tool-root" class="extension-floorplanner-view-mode">
		    <header>Floorplanner</header>
				<div id="extension-floorplanner-svg-container-bg-image"></div>
			  <div id="extension-floorplanner-svg-container">
			    <svg id="extension-floorplanner-lin" class="extension-floorplanner-current-svg" viewBox="0 0 1100 700" preserveAspectRatio="xMidYMin slice" xmlns="http://www.w3.org/2000/svg">

			      <defs>
			        <linearGradient id="extension-floorplanner-gradientRed" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#e65d5e" stop-opacity="1" />
			          <stop offset="100%" stop-color="#e33b3c" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientYellow" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#FDEB71" stop-opacity="1" />
			          <stop offset="100%" stop-color="#F8D800" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientGreen" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#c0f7d9" stop-opacity="1" />
			          <stop offset="100%" stop-color="#6ce8a3" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientSky" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#c4e0f4" stop-opacity="1" />
			          <stop offset="100%" stop-color="#87c8f7" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientOrange" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#f9ad67" stop-opacity="1" />
			          <stop offset="100%" stop-color="#f97f00" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientWhite" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#ffffff" stop-opacity="1" />
			          <stop offset="100%" stop-color="#f0f0f0" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientGrey" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#666" stop-opacity="1" />
			          <stop offset="100%" stop-color="#aaa" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientBlue" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#4f72a6" stop-opacity="1" />
			          <stop offset="100%" stop-color="#365987" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientPurple" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#E2B0FF" stop-opacity="1" />
			          <stop offset="100%" stop-color="#9F44D3" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientPink" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#f6c4dd" stop-opacity="1" />
			          <stop offset="100%" stop-color="#f699c7" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientBlack" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#3c3b3b" stop-opacity="1" />
			          <stop offset="100%" stop-color="#000000" stop-opacity="1" />
			        </linearGradient>
			        <linearGradient id="extension-floorplanner-gradientNeutral" x1="0%" y1="0%" x2="100%" y2="100%" spreadMethod="pad">
			          <stop offset="0%" stop-color="#dbc6a0" stop-opacity="1" />
			          <stop offset="100%" stop-color="#c69d56" stop-opacity="1" />
			        </linearGradient>

			        <pattern id="extension-floorplanner-grass" patternUnits="userSpaceOnUse" width="256" height="256">
			          <image
			            src="/extensions/floorplanner/images/grass.jpg"
			            x="0" y="0" width="256" height="256" />
			        </pattern>
			        <pattern id="extension-floorplanner-wood" patternUnits="userSpaceOnUse" width="32" height="256">
			          <image
			  		  src="/extensions/floorplanner/images/planks.jpg"
			            x="0" y="0" width="256" height="256" />
			        </pattern>
			        <pattern id="extension-floorplanner-tiles" patternUnits="userSpaceOnUse" width="25" height="25">
			          <image
			            src="/extensions/floorplanner/images/tiles.jpg"
			            x="0" y="0" width="256" height="256" />
			        </pattern>
			        <pattern id="extension-floorplanner-granite" patternUnits="userSpaceOnUse" width="256" height="256">
			          <image
			            src="/extensions/floorplanner/images/granite.jpg"
			            x="0" y="0" width="256" height="256" />
			        </pattern>
			        <pattern id="extension-floorplanner-smallGrid" width="60" height="60" patternUnits="userSpaceOnUse">
			          <path d="M 60 0 L 0 0 0 60" fill="none" stroke="#777" stroke-width="0.25" />
			        </pattern>
			        <pattern id="extension-floorplanner-grid" width="180" height="180" patternUnits="userSpaceOnUse">
			          <rect width="180" height="180" fill="url(#extension-floorplanner-smallGrid)" />
			          <path d="M 200 10 L 200 0 L 190 0 M 0 10 L 0 0 L 10 0 M 0 190 L 0 200 L 10 200 M 190 200 L 200 200 L 200 190"
			            fill="none" stroke="#999" stroke-width="0.8" />
			        </pattern>
			        <pattern id="extension-floorplanner-hatch" width="5" height="5" patternTransform="rotate(50 0 0)" patternUnits="userSpaceOnUse">
			          <path d="M 0 0 L 0 5 M 10 0 L 10 10 Z" style="stroke:#666;stroke-width:5;" />
			        </pattern>
			      </defs>
			      <g id="extension-floorplanner-boxgrid">
			        <rect width="8000" height="5000" x="-3500" y="-2000" fill="url(#extension-floorplanner-grid)" />
			      </g>
			      <g id="extension-floorplanner-boxpath"></g>
			      <g id="extension-floorplanner-boxSurface"></g>
			      <g id="extension-floorplanner-boxRoom"></g>
			      <g id="extension-floorplanner-boxwall"></g>
			      <g id="extension-floorplanner-boxcarpentry"></g>
			      <g id="extension-floorplanner-boxEnergy"></g>
			      <g id="extension-floorplanner-boxFurniture"></g>
			      <g id="extension-floorplanner-boxbind"></g>
			      <g id="extension-floorplanner-boxArea"></g>
			      <g id="extension-floorplanner-boxRib"></g>
			      <g id="extension-floorplanner-boxScale"></g>
			      <g id="extension-floorplanner-boxText"></g>
						<g id="extension-floorplanner-boxMeasure"></g>
			      <g id="extension-floorplanner-boxDebug"></g>
			    </svg>
		    </div>

		    <div id="extension-floorplanner-areaValue"></div>

		    <div id="extension-floorplanner-reportTools" class="extension-floorplanner-leftBox" style="width:500px;overflow-y: scroll;overflow-x: hidden;position:fixed;left:0;top:0;height:100vh;z-index:100">
		      <h2>CALCULATOR Report plan.</h2>
		      <br /><br />
		      <h2 class="extension-floorplanner-toHide" id="extension-floorplanner-reportTotalSurface" style="display:none"></h2>
		      <h2 class="extension-floorplanner-toHide" id="extension-floorplanner-reportNumberSurface" style="display:none"></h2>
		      <hr />
		      <section id="extension-floorplanner-reportRooms" class="extension-floorplanner-toHide" style="display:none">
		      </section>
		      <button class="extension-floorplanner-btn extension-floorplanner-btn-info extension-floorplanner-btn-done extension-floorplanner-fully" id="extension-floorplanner-reportTools-done-button" style="margin-top:50px"
		            onclick="document.querySelector('#extension-floorplanner-reportTools').style.display='none';document.querySelector('#extension-floorplanner-panel').style.display='block';mode = 'select_mode';">DONE</button>
		    </div>

		    <div id="extension-floorplanner-wallTools" class="extension-floorplanner-leftBox">
					<div class="extension-floorplanner-vertical-flex-between">
						<div>
				      <h2 id="extension-floorplanner-titleWallTools">Modify the wall</h2>
				      <hr />
				      <section id="extension-floorplanner-rangeThick">
				        <p style="text-align:center"><span style="font-weight:bold">Width</span><span class="extension-floorplanner-show-if-developer"><br/>(<span id="extension-floorplanner-wallWidthScale"></span>)</span> </span></p>
				        <div id="extension-floorplanner-wall-slider-container">
									<input type="range" id="extension-floorplanner-wallWidth" step="0.1" class="extension-floorplanner-range" />
								</div>
								<p style="text-align:center"><span id="extension-floorplanner-wallWidthVal" style="font-weight:bold"></span> cm</p>
				      </section>
				      <ul class="extension-floorplanner-list-unstyled extension-floorplanner-show-if-developer">
				        <section id="extension-floorplanner-cutWall">
				          <p>Cut the wall :<br /><small>A cut will be made at each wall encountered.</small></p>
				          <li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" onclick="floorplanEditor.splitWall();">CUT</button></li>
				        </section>

				        <section id="extension-floorplanner-separate">
				          <p>Separation wall :<br /><small>Transform the wall into simple separation line.</small></p>
				          <li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" onclick="floorplanEditor.invisibleWall();" id="extension-floorplanner-wallInvisible">CROP</button></li>
				        </section>
				        <section id="extension-floorplanner-recombine">
				          <p>Transform to wall :<br /><small>The thickness will be identical to the last known.</small></p>
				          <li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" onclick="floorplanEditor.visibleWall();" id="extension-floorplanner-wallVisible">CROP</button></li>
				        </section>
				        
				      </ul>
							<ul class="extension-floorplanner-list-unstyled">
				        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-info extension-floorplanner-btn-done extension-floorplanner-fully" style="margin-top:2rem"
				            onclick="fonc_button('select_mode');document.querySelector('#extension-floorplanner-boxinfo').innerHTML='Selection mode';document.querySelector('#extension-floorplanner-wallTools').style.display='none';document.querySelector('#extension-floorplanner-panel').style.display='block'">DONE</button></li>
							</ul>
						</div>
						<div>
							<ul class="extension-floorplanner-list-unstyled">
				        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-danger extension-floorplanner-fully" id="extension-floorplanner-wallTrash"><span class="extension-floorplanner-unicode-icon-large">üóë</span></button></li>
							</ul>
						</div>
					</div>
		    </div>

		    <div id="extension-floorplanner-objBoundingBox" class="extension-floorplanner-leftBox">
		      <div class="extension-floorplanner-vertical-flex-between">
						<div>
							<h2>Modify object</h2>
				      
				      <section id="extension-floorplanner-objBoundingBoxScale" class="extension-floorplanner-menu-area">
				        <p>Width </p>
				        <input type="range" id="extension-floorplanner-bboxWidth" step="1" class="extension-floorplanner-range" />
				        <div class="extension-floorplanner-flex-between extension-floorplanner-scale-slider-min-max"><span id="extension-floorplanner-bboxWidthScale-min"></span><span id="extension-floorplanner-bboxWidthScale-max"></span></div>
								<div style="text-align:center"><span id="extension-floorplanner-bboxWidthVal" class="extension-floorplanner-slider-value"></span> cm</div>
				        
								<div id="extension-floorplanner-scale-link-toggle-button-container"><div id="extension-floorplanner-scale-link-toggle-button"><span class="extension-floorplanner-scale-linked-true">üîó</span><span class="extension-floorplanner-scale-linked-false">‚îä</span></div></div>
								<div>
									<p>Length</p>
					        <input type="range" id="extension-floorplanner-bboxHeight" step="1" class="extension-floorplanner-range" />
									<div class="extension-floorplanner-flex-between extension-floorplanner-scale-slider-min-max"><span id="extension-floorplanner-bboxHeightScale-min"></span><span id="extension-floorplanner-bboxHeightScale-max"></span></div>
									<div style="text-align:center"><span id="extension-floorplanner-bboxHeightVal" class="extension-floorplanner-slider-value"></span> cm</div>
								</div>
				      </section>
					
							<hr />
				      <section id="extension-floorplanner-objBoundingBoxRotation" class="extension-floorplanner-menu-area">
				        <p>Rotation</p>
				        <input type="range" id="extension-floorplanner-bboxRotation" step="1" class="extension-floorplanner-range" min="-180" max="180" />
								<div class="extension-floorplanner-flex-between extension-floorplanner-scale-slider-min-max"><span>-180</span><span>180</span></div>
								<div style="text-align:center"><span id="extension-floorplanner-bboxRotationVal" class="extension-floorplanner-slider-value"></span> ¬∞</div>
				      </section>

							<div class="extension-floorplanner-show-if-developer">
					      <div id="extension-floorplanner-stepsCounter" style="display:none;">
					        <p><span id="extension-floorplanner-bboxSteps">Steps (2-15): <span id="extension-floorplanner-bboxStepsVal">0</span></span></p>
									<div class="extension-floorplanner-flex-between">
					        	<button class="extension-floorplanner-btn extension-floorplanner-btn-info" id="extension-floorplanner-bboxStepsAdd">+</button>
					        	<button class="extension-floorplanner-btn extension-floorplanner-btn-info" id="extension-floorplanner-bboxStepsMinus">-</button>
									</div>
					      </div>
							</div>

				      <div id="extension-floorplanner-objBoundingBoxColor" style="display:none">
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientRed"
				          style="color:#f55847;background:linear-gradient(30deg, #f55847, #f00);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientYellow"
				          style="color:#e4c06e;background:linear-gradient(30deg,#e4c06e, #ffb000);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientGreen"
				          style="color:#88cc6c;background:linear-gradient(30deg,#88cc6c, #60c437);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientSky"
				          style="color:#77e1f4;background:linear-gradient(30deg,#77e1f4, #00d9ff);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientBlue"
				          style="color:#4f72a6;background:linear-gradient(30deg,#4f72a6, #284d7e);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientGrey"
				          style="color:#666666;background:linear-gradient(30deg,#666666, #aaaaaa);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientWhite"
				          style="color:#fafafa;background:linear-gradient(30deg,#fafafa, #eaeaea);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientOrange"
				          style="color:#f9ad67;background:linear-gradient(30deg, #f9ad67, #f97f00);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientPurple"
				          style="color:#a784d9;background:linear-gradient(30deg,#a784d9, #8951da);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientPink"
				          style="color:#df67bd;background:linear-gradient(30deg,#df67bd, #e22aae);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientBlack"
				          style="color:#3c3b3b;background:linear-gradient(30deg,#3c3b3b, #000000);"></div>
				        <div class="extension-floorplanner-color textEditorColor" data-type="gradientNeutral"
				          style="color:#e2c695;background:linear-gradient(30deg,#e2c695, #c69d56);"></div>
				        <div style="clear:both"></div>
				      </div>

				      <br /><br />
		
				      <button class="extension-floorplanner-btn extension-floorplanner-btn-info extension-floorplanner-btn-done"
				        onclick="save_object();">DONE</button>
						</div>
					
						<div>
							<ul class="extension-floorplanner-list-unstyled">
				        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-danger extension-floorplanner-fully" id="extension-floorplanner-bboxTrash"><span class="extension-floorplanner-unicode-icon-large">üóë</span></button></li>
							</ul>
						</div>
						
					</div>
					
		    </div>




		    <div id="extension-floorplanner-objTools" class="extension-floorplanner-leftBox">
		      <div class="extension-floorplanner-vertical-flex-between">
						<div>
							<h2>Modify door/window</h2>
							<br />
				      <ul class="extension-floorplanner-list-unstyled">
								<li>
				        	<p style="text-align:center;font-weight:bold">Width</p>
				        	<input type="range" id="extension-floorplanner-doorWindowWidth" step="1" class="extension-floorplanner-range" />
									<div class="extension-floorplanner-flex-between extension-floorplanner-scale-slider-min-max"><span id="extension-floorplanner-doorWindowWidthScale-min"></span><span id="extension-floorplanner-doorWindowWidthScale-max"></span></div>
									<div style="text-align:center"><span id="extension-floorplanner-doorWindowWidthVal" class="extension-floorplanner-slider-value"></span> cm</div>
								<li>
									
								<li><br/><br/><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-objToolsHinge">Reverse hinges</button></li>
			        
				        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-info extension-floorplanner-btn-done" style="margin-top:100px"
				            onclick="fonc_button('select_mode');document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Selection mode';document.querySelector('#extension-floorplanner-objTools').style.display='none';document.querySelector('#extension-floorplanner-panel').style.display='block';binder.graph.remove();bye_binder();rib();">DONE</button></li>
				      </ul>
						</div>
						<div>
							<ul class="extension-floorplanner-list-unstyled">
				        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-danger extension-floorplanner-fully extension-floorplanner-objTrash"><span class="extension-floorplanner-unicode-icon-large">üóë</span></button>
				        </li>
							</ul>
						</div>
					</div>
		    </div>


		    <div id="extension-floorplanner-roomTools" class="extension-floorplanner-leftBox">
					<div class="extension-floorplanner-vertical-flex-between">
		      	<div>
							<h2>Room</h2>
							
				      <input type="hidden" id="extension-floorplanner-roomName" value="" />
				      Name:
							<br />
				      <select class="extension-floorplanner-form-select" aria-label="Default select example" id="extension-floorplanner-roomLabel">
				        <option selected value="0">None</option>
				        <option value="1">Lounge</option>
								<option value="51">Living room</option>
				        <option value="2">Lunchroom</option>
				        <option value="3">Kitchen</option>
								<option value="23">Pantry</option>
								<option value="52">Dining room</option>
				        <option value="4">Toilet</option>
								<option value="14">Toilet 2</option>
				        <option value="5">Bathroom</option>
								<option value="13">Bathroom 2</option>
				        <option value="6">Bedroom</option>
				        <option value="7">Bedroom 2</option>
				        <option value="8">Bedroom 3</option>
				        <option value="15">Bedroom 4</option>
				        <option value="16">Bedroom 5</option>
				        <option value="9">Locker</option>
				        <option value="10">Office</option>
				        <option value="11">Hall</option>
								<option value="19">Corridor</option>
				        <option value="12">Loggia</option>
				        <option value="17">Balcony</option>
								<option value="21">Balcony 2</option>
				        <option value="18">Terrace</option>
								<option value="46">Shed</option>
				        <option value="20">Garage</option>
								<option value="21">Garden</option>
				        <option value="22">Clearance</option>
								<option value="24">Porch</option>
								<option value="25">Playroom</option>
								<option value="26">Mezzanine</option>
								<option value="27">Cellar</option>
								<option value="28">Doghouse</option>
								<option value="29">Treehouse</option>
								<option value="30">Dock</option>
								<option value="31">Utility room</option>
								<option value="32">Heating</option>
								<option value="33">Pool</option>
								<option value="34">Serre</option>
								<option value="35">Waiting room</option>
								<option value="36">Guest room</option>
								<option value="48">Foyer</option>
								<option value="37">Bar</option>
								<option value="38">Cinema</option>
								<option value="63">Game room</option>
								<option value="39">Storage</option>
								<option value="40">Storage 2</option>
								<option value="47">Cold storage</option>
								<option value="41">Veranda</option>
								<option value="42">Front garden</option>
								<option value="43">Rear garden</option>
								<option value="44">Firepit</option>
								<option value="45">Playground</option>
								<option value="46">Parking</option>
								<option value="49">Workshop</option>
								<option value="50">Kitchenette</option>
								<option value="53">Reception</option>
								<option value="54">Family room</option>
								<option value="55">Sun room</option>
								<option value="56">Library</option>
								<option value="57">Closet</option>
								<option value="58">Laundry room</option>
								<option value="59">Attic</option>
								<option value="60">Broom closet</option>
								<option value="61">Linnen closet</option>
								<option value="62">Nursery</option>
								<option value="64">Meeting room</option>
								<option value="65">Loft</option>
								<option value="66">Gym</option>
								<option value="67">Den</option>
								<option value="68">Staircase</option>
								<option value="69">Elevator</option>
								<option value="70">Powder room</option>
								<option value="71">Dressing room</option>
								<option value="72">En suite</option>
								<option value="73">Meditation space</option>
								<option value="74">Billiards Room</option>
								<option value="75">Spa</option>
								<option value="76">Media room</option>
								<option value="77">Studio</option>
								<option value="78">Study</option>
								<option value="79">Nook</option>
								<option value="80">Cave</option>
								<option value="81">Pet room</option>
								<option value="82">Safe room</option>
								<option value="83">Conservatory</option>
								<option value="84">Observatory</option>
								<option value="85">Shrine</option>
								<option value="86">Crawl space</option>
								<option value="87">Keeping room</option>
								<option value="88">Great room</option>
								<option value="89">Music room</option>
								<option value="90">Mud room</option>
								<option value="91">Server room</option>
								<option value="92">Solarium</option>
								<option value="93">Sauna</option>
								<option value="94">Dark room</option>
								<option value="95">Deck</option>
								<option value="96">Greenhouse</option>
								<option value="97">Gazebo</option>
								<option value="98">Wood shed</option>
								<option value="99">Dry room</option>
								<option value="100">Boiler room</option>
								<option value="101">Classroom</option>
								<option value="102">Observation room</option>
								<option value="103">Observation deck</option>
								<option value="104">Boat house</option>
								<option value="105">Back room</option>
								<option value="106">Patio</option>
								<option value="107">Bike shed</option>
								<option value="108">Smoking room</option>
								<option value="109">Garbage room</option>
								<option value="110">Freezer</option>
								<option value="111">Breakfast room</option>
								<option value="112">Guest suite</option>
								<option value="113">Rooftop</option>
								<option value="114">Crafts room</option>
								<option value="115">Panic room</option>
								<option value="116">Half bath</option>
								<option value="117">Ritual room</option>
								<option value="118">Shoe closet</option>
								<option value="119">Outdoor seating</option>
								<option value="120">Orchard</option>
								<option value="121">Driveway</option>
								<option value="122">Secret room</option>
								<option value="123">Vegetable garden</option>
								<option value="124">Outhouse</option>
								<option value="125">Composting</option>
								<option value="126">Kennel</option>
								<option value="127">Stable</option>
								<option value="128">Kennel</option>
								<option value="129">Minarette</option>
								<option value="130">Cupola</option>
								<option value="131">Enfilade</option>
								<option value="132">Fireplace</option>
								<option value="133">Tower</option>
								<option value="134">Dormer</option>
								<option value="135">Nook</option>
								<option value="136">Guard house</option>
								
				      </select>
							
							<div class="extension-floorplanner-show-if-developer">
								<span style="color:#08d">Room</span>
								<br/>
								Estimated a surface of:<br /><b><span class="extension-floorplanner-size"></span></b>
					      <br />
								<br />
					      <p>If you know the actual area, enter it here</p>
					      <div class="extension-floorplanner-input-group">
					        <input type="text" class="extension-floorplanner-form-control" id="extension-floorplanner-roomSurface" placeholder="Real surface area" aria-describedby="basic-addon2">
					        <span class="extension-floorplanner-input-group-addon" id="extension-floorplanner-basic-addon2">m¬≤</span>
					      </div>
					      <br />
					      <br />
					      <br />
					      Meter:
					      <div class="extension-floorplanner-funkyradio">
					        <div class="extension-floorplanner-funkyradio-success">
					          <input type="checkbox" name="roomShow" value="showSurface" id="extension-floorplanner-seeArea" checked />
					          <label for="extension-floorplanner-seeArea">Show the surface</label>
					        </div>
					      </div>
					      <div class="extension-floorplanner-funkyradio">
					        <div class="extension-floorplanner-funkyradio-success">
					          <input type="radio" name="roomAction" id="extension-floorplanner-addAction" value="add" checked />
					          <label for="extension-floorplanner-addAction">Add the surface</label>
					        </div>
					        <div class="extension-floorplanner-funkyradio-warning">
					          <input type="radio" name="roomAction" id="extension-floorplanner-passAction" value="pass" />
					          <label for="extension-floorplanner-passAction">Ignore the surface</label>
					        </div>
					      </div>
					      <hr />
							</div>

				      <p>Room Colors</p>
								<div class="extension-floorplanner-flex-between extension-floorplanner-flex-wrap">
					      <div class="extension-floorplanner-roomColor" data-type="gradientRed" style="background:linear-gradient(30deg, #f55847, #f00);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientYellow" style="background:linear-gradient(30deg,#e4c06e, #ffb000);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientGreen" style="background:linear-gradient(30deg,#88cc6c, #60c437);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientSky" style="background:linear-gradient(30deg,#77e1f4, #00d9ff);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientBlue" style="background:linear-gradient(30deg,#4f72a6, #284d7e);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientGrey" style="background:linear-gradient(30deg,#666666, #aaaaaa);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientWhite" style="background:linear-gradient(30deg,#fafafa, #eaeaea);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientOrange" style="background:linear-gradient(30deg, #f9ad67, #f97f00);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientPurple" style="background:linear-gradient(30deg,#a784d9, #8951da);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientPink" style="background:linear-gradient(30deg,#df67bd, #e22aae);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientBlack" style="background:linear-gradient(30deg,#3c3b3b, #000000);"></div>
					      <div class="extension-floorplanner-roomColor" data-type="gradientNeutral" style="background:linear-gradient(30deg,#e2c695, #c69d56);"></div>
							</div>
							
							<div class="extension-floorplanner-show-if-developer">
								<br /><br />
					      <p>Materials</p>
					      <div class="extension-floorplanner-roomColor" data-type="wood"
					        style="background: url('/extensions/floorplanner/images/planks.jpg');">
					      </div>
					      <div class="extension-floorplanner-roomColor" data-type="tiles"
					        style="background: url('/extensions/floorplanner/images/tiles.jpg');">
					      </div>
					      <div class="extension-floorplanner-roomColor" data-type="granite"
					        style="background: url('/extensions/floorplanner/images/granite.jpg');">
					      </div>
					      <div class="extension-floorplanner-roomColor" data-type="grass"
					        style="background: url('/extensions/floorplanner/images/grass.jpg');">
					      </div>
					      <div data-type="#ff008a" style="clear:both"></div>
					      <br /><br />
					      <input type="hidden" id="extension-floorplanner-roomBackground" value="gradientNeutral" />
					      <input type="hidden" id="extension-floorplanner-roomIndex" value="" />
								
					      <button type="button" class="extension-floorplanner-btn extension-floorplanner-btn-primary extension-floorplanner-btn-done" id="extension-floorplanner-applySurface">Apply</button><br/><br/>
							</div>
							
							<br/>
							<br/>
				      <br />
						</div>
						<div>
							<button type="button" class="extension-floorplanner-btn extension-floorplanner-btn-danger" id="extension-floorplanner-resetRoomTools">Cancel</button>
						</div>
					</div>
		    </div>


		    <div id="extension-floorplanner-panel" class="extension-floorplanner-leftBox">
					<div id="extension-floorplanner-panel-scrollerX">
			      <ul class="extension-floorplanner-list-unstyled">
			        <li class="extension-floorplanner-flex-between"><button class="extension-floorplanner-btn extension-floorplanner-disabled extension-floorplanner-halfy" id="extension-floorplanner-undo" title="undo"><span>‚Ü∫</span></button>
			            <button class="extension-floorplanner-btn extension-floorplanner-disabled extension-floorplanner-halfy extension-floorplanner-pull-right" id="extension-floorplanner-redo" title="redo"><span>‚Üª</span></button>
			        </li>

			        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-success extension-floorplanner-fully" id="extension-floorplanner-select_mode" title="Select objects"><span>‚óÑ</span></button></li>

			        <li id="extension-floorplanner-wall-buttons">
								<div class="extension-floorplanner-vertical-shrinker2">
				          <!--<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" style="margin-bottom:0px" id="extension-floorplanner-line_mode" data-toggle="tooltip"
				            data-placement="right" title="Make walls"><span class="extension-floorplanner-unicode-icon-large">üß±</span></button>-->
									<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" style="margin-bottom:0px" id="extension-floorplanner-line_mode" data-toggle="tooltip"
													            data-placement="right" title="Make walls"><img src="img/wall.svg" alt="Wall" title="Wall" style="opacity:.85;width:70%"/></button>
				          <button class="extension-floorplanner-mt-2 expansion-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-show-if-room extension-floorplanner-shadow extension-floorplanner-fully" style="margin-bottom:0px" id="extension-floorplanner-partition_mode"
				            data-toggle="tooltip" data-placement="right" title="Make room dividers (small walls)"><span class="extension-floorplanner-unicode-icon-medium">‚îÅ</span></button>
								</div>
								<div id="extension-floorplanner-multi-container" class="extension-floorplanner-funkyradio extension-floorplanner-flex-between" title="Draw multiple lines in a row">
									<div id="extension-floorplanner-multi-container-zigzag"><span>‚¶ö</span></div>
			            <div class="extension-floorplanner-funkyradio-success">
			              <input type="checkbox" id="extension-floorplanner-multi" checked />
			              <label for="extension-floorplanner-multi"></label>
			            </div>
			          </div>
			        </li>

							<li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-node_mode" title="Cut walls, giving them an extra joint to move"><span class="extension-floorplanner-unicode-icon-medium">‚úÇ</span></button></li>
							<!--
			        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-distance_mode" data-toggle="tooltip" data-placement="right"
			            title="Add a measurement"><span class="extension-floorplanner-unicode-icon-medium">üìè</span></button></li>
							-->
			        <li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-distance_mode" data-toggle="tooltip" data-placement="right"
			                 title="Add a measurement"><div class="extension-floorplanner-tape-measure-icon"></div><div class="extension-floorplanner-tape-measure-icon-end"></div></button></li>
							
							
							
			        <li class="extension-floorplanner-show-if-room">
								<div class="extension-floorplanner-vertical-shrinker">
									<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-door_mode"
			                  onclick="hide_submenus();document.getElementById('extension-floorplanner-door_list').style.display='block'" title="Add a door to a wall"><span class="extension-floorplanner-unicode-icon-large">üö™</span></button>

			        		<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-window_mode"
			                  onclick="hide_submenus();document.getElementById('extension-floorplanner-window_list').style.display='block'" title="Add a window to a wall"><span class="extension-floorplanner-unicode-icon-large">ü™ü</span></button>
								</div>
							</li>
	        
							<li class="extension-floorplanner-show-if-room">
								<div class="extension-floorplanner-vertical-shrinker">
									<!--<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-stair_mode"
					              onclick="hide_submenus();" title="Add a staircase"><span class="extension-floorplanner-unicode-icon-large">ü™ú</span></button>-->
									<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-stair_mode"
					              onclick="hide_submenus();" title="Add a staircase"><img src="img/stairs.svg" alt="Stairs" title="Stairs" style="opacity:.85;width:70%"></button>
					        <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-room_mode" title="Give rooms a background color"><span class="extension-floorplanner-unicode-icon-large">üé®</span></button>
								</div>
							</li>
							
			        <li class="extension-floorplanner-show-if-room">
								<div class="extension-floorplanner-vertical-shrinker3">
									<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-object_mode"
			            	   onclick="toggle_furniture();"><span class="extension-floorplanner-unicode-icon-large">üõã</span></button>
									<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-text_mode" data-toggle="tooltip" data-placement="right"
										   title="Add text"><span class="extension-floorplanner-unicode-icon-large" style="font-family:'serif'">A</span></button>
								</div>
							</li>
			        <!-- <li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-object_mode" onclick="hide_submenus();document.querySelector('#extension-floorplanner-object_list').style.display='block';">FURNITURE</button></li> -->


			    		<li class="extension-floorplanner-show-if-room"><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-layer_mode"
			                onclick="toggle_layers();"><span style="display:inline-block;transform:rotate(90deg)">„Ä£</span> Layers</button></li>
			

			        <li class="extension-floorplanner-show-if-room"><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-show-if-developer" id="extension-floorplanner-report_mode" title="Show report">üìä Report</button></li>
					
			        <li class="extension-floorplanner-flex-between">
								<label id="extension-floorplanner-upload-background-image-label" for="extension-floorplanner-upload-background-image">
								  <input type="file" id="extension-floorplanner-upload-background-image" name="background-image" style="display:none"/>
								  <span class="extension-floorplanner-unicode-icon-medium" >‚§í</span>
								</label>
								<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow" id="extension-floorplanner-svg-download-button" title="Download"><!--<span class="extension-floorplanner-unicode-icon-medium" style="font-weight:bold">‚§ì</span>--><u class="extension-floorplanner-unicode-icon-medium" >‚§ì</u></button>
			        <li>
						
						
			        <li class="extension-floorplanner-show-if-room">
								<div class="extension-floorplanner-vertical-shrinker4">
									<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-save-to-server"
			            	   onclick="save_to_floorplans();" style="margin-bottom:0"><span class="extension-floorplanner-unicode-icon-large">üíæ</span></button>
									<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-new-file-button"
														            onclick="save_floorplan_as();">Save as</button>
								</div>
							</li>
						
					    <li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-new-file-button"
					            onclick="new_floorplan();"><span>üìÅ</span> New</button></li>
								
							<li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully extension-floorplanner-show-if-developer" id="extension-floorplanner-clear-button"
								      onclick="clear_floorplan();"><span>‚ùå</span> Clear</button></li>

							<li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-delete-button"
								      onclick="delete_floorplan();"><span>üóë</span> Delete</button></li>
											
								  

							
							<li>
								<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully extension-floorplanner-pull-right"
			                onclick="fullscreen();this.style.display='none';document.querySelector('#extension-floorplanner-nofull_mode').style.display='block';" id="extension-floorplanner-full_mode"
			                title="Full screen"><span class="extension-floorplanner-unicode-icon-medium"><sup>‚á±</sup><sub>‚á≤</sub></span></button>
			          <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-halfy extension-floorplanner-pull-right" style="display:none"
			                onclick="outFullscreen();this.style.display='none';document.querySelector('#extension-floorplanner-full_mode').style.display='block';" id="extension-floorplanner-nofull_mode"
			                data-toggle="tooltip" data-placement="right" title="Full screen"><span class="extension-floorplanner-unicode-icon-medium" style="transform:rotate(-90deg);display:inline-block"><sup>‚á≤</sup><sub>‚á±</sub></span></button>
							</li>

							<li><button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-fully" id="extension-floorplanner-stop-floorplanner"
	            	   onclick="stop_floorplanner();"><span class="extension-floorplanner-unicode-icon-large">üèÅ</span> Stop</button>
							</li>


			      </ul>
		      </div>
					
		    </div>



				<div id="extension-floorplanner-panel-level2">
	        <div id="extension-floorplanner-door_list" class="extension-floorplanner-list-unstyled extension-floorplanner-sub">
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-door" data-type="aperture" id="extension-floorplanner-aperture">Opening</button>
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-door" data-type="simple" id="extension-floorplanner-simple">Simple</button>
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-door" data-type="double" id="extension-floorplanner-double">Double</button>
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-door" data-type="pocket" id="extension-floorplanner-pocket">Pocket</button>
	        </div>
					
	        <div id="extension-floorplanner-window_list" class="extension-floorplanner-list-unstyled extension-floorplanner-sub">
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-window" id="extension-floorplanner-fix">Fix</button>
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-window" id="extension-floorplanner-flap">Simple</button>
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-window" id="extension-floorplanner-twin">Double</button>
	          <button class="extension-floorplanner-btn extension-floorplanner-fully extension-floorplanner-window" id="extension-floorplanner-bay">Slide</button>
	        </div>
					
	        <div id="extension-floorplanner-energy_list" class="extension-floorplanner-list-unstyled extension-floorplanner-sub">

            <h2 style="text-align:center"><span class="extension-floorplanner-unicode-icon-large">üõãÔ∏è</span> Add items</h2>
				
            <div>
							<p>Geometric shapes</p>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-circle">‚óå Circle</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-half-circle">‚óñ Half circle</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-square">‚ñ° Square</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-crossed-square">‚ä† Crossed square</button>
							
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-rounded-square">‚ñ° Rounded square</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-dome">·ëé Dome</button>
					
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-triangle">‚ñ≤ Triangle</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-star">‚òÖ Star</button>
							
							<!--
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-button1">‚óò Button</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-button2">‚óô Button</button>
							-->
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-pill">üíä Pill shape</button>
            </div>
				
						<div>
							<p>Specific shapes</p>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-eye">üëÅ Eye</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-flower">‚úø Flower</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-paw">üêæ Paw</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-note">‚ô™ Audio</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-wifi">‚åî Wifi</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-heart">‚ô• Heart</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-lock">üîí Lock</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-droplet">üíß Water</button>
						</div>
						
						
						<div>
							<p>Furniture</p>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-bed">üõè Single bed</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-double-bed">üõè Double bed</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-couch">üõãÔ∏è Couch</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-tv">üì∫ TV</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-leaf">üåø Plant</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-sink">üö∞ Sink</button>
							<button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-toilet">üöΩ Toilet</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-rooflight">üí° Ceiling lamp</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-walllight">üí° Wall light</button>
						</div>
				
            <div>
              <p>Wall plugs</p>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-www">üåê Internet access</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-rj45">‚ßà RJ45 plug</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-tv-plug">·õâ Antenna plug</button>
            </div>
				
            <div>
              <p>Energy</p>
              <div>
                <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-gtl">Switchboard</button>
                <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-switch">Switch</button>
                <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-doubleSwitch">Multiways</button>
                <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-dimmer">‚óå Variator</button>
              </div>
              <div>
                <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-plug">üîå Electrical outlet</button>
                <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-plug20">Outlet 20A</button>
                <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-plug32">Outlet 32A</button>
              </div>
            </div>
            

            <div>
              <p>Heating & Cooling</p>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object extension-floorplanner-hidden" id="extension-floorplanner-boiler">Boiler</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-heater">‚óç Boiler</button>
              <button class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-fully extension-floorplanner-object" id="extension-floorplanner-radiator">‚ñ• Radiator</button>
            </div>

	        </div>
					
					
	        <div id="extension-floorplanner-layer_list">
	          
						<div id="extension-floorplanner-object_list" class="extension-floorplanner-list-unstyled extension-floorplanner-subx">
							
						</div>
						
						<div id="extension-floorplanner-layer_list-checkboxes" class="extension-floorplanner-list-unstyled extension-floorplanner-subx">
							<div class="extension-floorplanner-funkyradio">
		            <div class="extension-floorplanner-funkyradio-info">
		              <input type="checkbox" id="extension-floorplanner-showRib" checked />
		              <label for="extension-floorplanner-showRib"></label>
		            </div>
								<div class="extension-floorplanner-funkyradio-info-icon"><span class="extension-floorplanner-unicode-icon-medium">üìê</span></div>
		          </div>
							<!--
		          <div class="extension-floorplanner-funkyradio" style="font-size:0.8em">
		            <div class="extension-floorplanner-funkyradio-info">
		              <input type="checkbox" id="extension-floorplanner-showArea" checked />
		              <label for="extension-floorplanner-showArea">Surface area</label>
		            </div>
		          </div>
							-->
		          <div class="extension-floorplanner-funkyradio" title="Show or hide Background colors">
		            <div class="extension-floorplanner-funkyradio-info">
		              <input type="checkbox" id="extension-floorplanner-showLayerRoom" checked />
		              <label for="extension-floorplanner-showLayerRoom"></label>
		            </div>
								<div class="extension-floorplanner-funkyradio-info-icon"><span class="extension-floorplanner-unicode-icon-medium">üé®</span></div>
		          </div>
		          <div class="extension-floorplanner-funkyradio">
		            <div class="extension-floorplanner-funkyradio-info">
		              <input type="checkbox" id="extension-floorplanner-showLayerEnergy" checked />
		              <label for="extension-floorplanner-showLayerEnergy"></label>
		            </div>
								<div class="extension-floorplanner-funkyradio-info-icon"><span class="extension-floorplanner-unicode-icon-medium">üõã</span></div>
		          </div>
						</div>
						
	        </div>
											
				</div>


				<ul id="extension-floorplanner-floorplans-list">
				
				</ul>
				


				<div id="extension-floorplanner-modals-container">
			    <div class="extension-floorplanner-modal extension-floorplanner-fade " id="extension-floorplanner-myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			      <div class="extension-floorplanner-modal-dialog modal-lg  modal-dialog-centered" role="document">
			        <div class="extension-floorplanner-modal-content" style="text-align:center">
			          <div class="extension-floorplanner-modal-header">
			            <h2 class="extension-floorplanner-modal-title" id="extension-floorplanner-myModalLabel">üìÉ Start a new floorplan</h2>
									<p id="extension-floorplanner-plan-exists-warning">This will remove your current floorplan!</p>
			          </div>
			          <div class="extension-floorplanner-modal-body m-2">
			            <div id="extension-floorplanner-recover">
										Select a plan type:
										<!--
			              <p>Would you like to continue working on your last plan?</p>
			              <button class="extension-floorplanner-btn extension-floorplanner-btn-success extension-floorplanner-shadow" data-bs-dismiss="modal"
			                onclick="initHistory('recovery');">YES</button>
			              <hr />
			              <p>Or do you prefer start a new plan ?<br/></p>
										-->
			            </div>
			            <div class="extension-floorplanner-w-100 extension-floorplanner-d-flex extension-floorplanner-justify-content-center">
			              <div class="extension-floorplanner-boxMouseOver"><img src="img/newPlanEmpty.jpg" class="extension-floorplanner-img-fluid" onclick="clear_floorplan();initHistory('boot');"
			                    data-bs-dismiss="modal" /></div>
			              <div class="extension-floorplanner-boxMouseOver"><img src="img/newPlanSquare.jpg" class="extension-floorplanner-img-fluid"
			                    onclick="clear_floorplan();initHistory('newSquare');" data-bs-dismiss="modal" /></div>
			              <div class="extension-floorplanner-boxMouseOver"><img src="img/newPlanL.jpg" class="extension-floorplanner-img-fluid" onclick="clear_floorplan();initHistory('newL');"
			                    data-bs-dismiss="modal" /></div>
			            </div>
			          </div>
			          <!-- <div class="extension-floorplanner-modal-footer">
			            <button type="button" class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow" data-dismiss="modal">CLOSE</button>
			            <button type="button" class="extension-floorplanner-btn extension-floorplanner-btn-primary">YES</button>
			          </div> -->
			        </div>
			      </div>
			    </div>


			    <div class="extension-floorplanner-modal extension-floorplanner-fade extension-floorplanner-hide-emojis-list" id="extension-floorplanner-textToLayer" tabindex="-1" role="dialog" aria-labelledby="textToLayerLabel">
			      <div class="extension-floorplanner-modal-dialog" role="document">
			        <div class="extension-floorplanner-modal-content">
			          <div class="extension-floorplanner-modal-header">
			            <!--<button type="button" class="extension-floorplanner-btn-close" onclick="cancel_adding_text();" data-bs-dismiss="modal" aria-label="Close"><span
			                aria-hidden="true">&times;</span></button>-->
			            <h2 class="extension-floorplanner-modal-title" id="extension-floorplanner-textToLayerLabel">Add text</h2>
			          </div>
			          <div class="extension-floorplanner-modal-body">
								
			            <div style="display:flex;align-items:center;min-height:9rem">
										<input type="text" id="extension-floorplanner-labelBox" placeholder="Your text"> <!-- onfocus="this.value='';"  -->
										<button id="extension-floorplanner-text-toggle-emojis-button">üòÄ</button>
									</div>
									<div id="extension-floorplanner-text-emojis-list">
										Loading emojis...
									</div>
								
									<div style="display:flex;justify-content:flex-end;margin-bottom:1rem">
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientRed"
				              style="color:#f55847;background:linear-gradient(30deg, #f55847, #f00);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientYellow"
				              style="color:#e4c06e;background:linear-gradient(30deg,#e4c06e, #ffb000);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientGreen"
				              style="color:#88cc6c;background:linear-gradient(30deg,#88cc6c, #60c437);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientSky"
				              style="color:#77e1f4;background:linear-gradient(30deg,#77e1f4, #00d9ff);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientBlue"
				              style="color:#4f72a6;background:linear-gradient(30deg,#4f72a6, #284d7e);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientGrey"
				              style="color:#666666;background:linear-gradient(30deg,#666666, #aaaaaa);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientWhite"
				              style="color:#fafafa;background:linear-gradient(30deg,#fafafa, #eaeaea);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientOrange"
				              style="color:#f9ad67;background:linear-gradient(30deg, #f9ad67, #f97f00);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientPurple"
				              style="color:#a784d9;background:linear-gradient(30deg,#a784d9, #8951da);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientPink"
				              style="color:#df67bd;background:linear-gradient(30deg,#df67bd, #e22aae);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientBlack"
				              style="color:#3c3b3b;background:linear-gradient(30deg,#3c3b3b, #000000);"></div>
				            <div class="extension-floorplanner-color extension-floorplanner-textEditorColor" data-type="gradientNeutral"
				              style="color:#e2c695;background:linear-gradient(30deg,#e2c695, #c69d56);"></div>
									</div>
								
			            <div style="display:flex; align-items:center;justify-content:flex-end;margin-bottom:2rem">
										<p style="display:inline-block;margin-right:1rem;font-weight:bold">Size </p>
			            	<input type="range" list="tickmarks" id="extension-floorplanner-text-size-slider" step="0.1" min="10" max="60" value="15" class="extension-floorplanner-range" style="width:200px" />
									</div>
								
			          </div>
							
			          <div class="extension-floorplanner-modal-footer" style="text-align:right">
			            <button id="extension-floorplanner-cancel-text" type="button" class="extension-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow" data-bs-dismiss="modal">Cancel</button>&nbsp;&nbsp;
			            <button id="extension-floorplanner-save-text" type="button" class="extension-floorplanner-btn extension-floorplanner-btn-primary">Apply</button>
			          </div>
							
			        </div>
			      </div>
			    </div>
				</div>

		    
				<div id="extension-floorplanner-current-filename-container"><span id="extension-floorplanner-current-filename"></span></div>

		    <div style="position:absolute;bottom:10px;left:210px;font-size:1.5em;color:#08d" id="extension-floorplanner-boxinfo"></div>

		    <div id="extension-floorplanner-moveBox">
		      
					<p id="extension-floorplanner-title">
		        <span class="extension-floorplanner-unicode-icon-medium">‚åÇ</span> Floorplanner
		      </p>
		      <div class="extension-floorplanner-pull-right" style="margin:10px">
		        <p style="margin:0">
							<button class="extension-floorplanner-btn btn-xs extension-floorplanner-btn-info extension-floorplanner-zoom" data-zoom="zoomtop">‚Üë</button>
						</p>
		        <p style="margin:0">
		          <button class="extension-floorplanner-btn btn-xs extension-floorplanner-btn-info extension-floorplanner-zoom" data-zoom="zoomleft">‚Üê</button>
		          <button class="extension-floorplanner-btn btn-xs extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-zoom" data-zoom="zoomreset">‚äô</button>
		          <button class="extension-floorplanner-btn btn-xs extension-floorplanner-btn-info extension-floorplanner-zoom" data-zoom="zoomright">‚Üí</button>
		        </p>
		        <p style="margin:0">
							<button class="extension-floorplanner-btn btn-xs extension-floorplanner-btn-info extension-floorplanner-zoom" data-zoom="zoombottom">‚Üì</button>
						</p>
		      </div>
		    </div>

		    <div id="extension-floorplanner-zoomBox">
		      <div class="extension-floorplanner-pull-right" style="margin-right:10px">
						<p>
		        	<button class="extension-floorplanner-btn expansion-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-zoom" data-zoom="zoomin">+</button>
		        	<button class="extension-floorplanner-btn expansion-floorplanner-btn extension-floorplanner-btn-light extension-floorplanner-shadow extension-floorplanner-zoom" data-zoom="zoomout">-</button>
						</p>
		      </div>
		    </div>
				
		    <div id="extension-floorplanner-zoomBox2">
					<div id="extension-floorplanner-scaleVal" class="extension-floorplanner-pull-right">
						1m
					</div>
				</div>
				
		    <div id="extension-floorplanner-start-floorplanner-button-container">
					<button id="extension-floorplanner-start-floorplanner-button">üè† EDIT</button>
				</div>
				
	    </div>
			
    </div>
			
  </div>
	
</div>
</body>
<!--
<script src="jquery-3.6.1.slim.min.js"></script>

<script src="bootstrap.min.js"></script>
-->
<!--
<script src="mousewheel.js"></script>
<script src="func.js"></script>-->
<script src="qSVG.js"></script>
<script src="floorplanEditor.js"></script>
<!--
<script src="engine.js"></script>
-->

<script>
	
	var currently_editing = true;
	if(localStorage.getItem('extension-floorplanner-currently-editing') != null){
		currently_editing = localStorage.getItem('extension-floorplanner-currently-editing');
	}
	else{
		localStorage.setItem('extension-floorplanner-currently-editing',true);
	}
	
	let touch_ui = false;
	function is_touch_device() {  
	  try {  
	    document.createEvent("TouchEvent");  
	    return true;  
	  } catch (e) {  
	    return false;  
	  }  
	}
	touch_ui = is_touch_device();
	
	// Additions
	
	let floorplanner_started = false;
	
	let bg_image_el = document.getElementById('extension-floorplanner-svg-container-bg-image');
	let floorplans_list_el = document.getElementById('extension-floorplanner-floorplans-list');
	let root_el = document.getElementById('extension-floorplanner-tool-root');
	let linElement = document.querySelector('#extension-floorplanner-lin');
	//let layers_list_el = document.querySelector('#extension-floorplanner-layer_list');
	let myModal = document.querySelector('#extension-floorplanner-myModal');
	
	
	let emojis = ['üíò','üíù','üíñ','üíó','üíì','üíû','üíï','üíü','‚ù£Ô∏è','üíî','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','ü§é','üñ§','ü§ç','‚ù§Ô∏è‚Äç','üî•','‚ù§Ô∏è‚Äç','ü©π','üíØ','‚ô®Ô∏è','üí¢','üí¨','üëÅÔ∏è‚Äçüó®Ô∏è','üó®Ô∏è','üóØÔ∏è','üí≠','üí§','üåê','‚ô†Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è','üÉè','üÄÑÔ∏è','üé¥','üé≠Ô∏è','üîá','üîàÔ∏è','üîâ','üîä','üîî','üîï','üéº','üéµ','üé∂','üíπ','üèß','üöÆ','üö∞','‚ôøÔ∏è','üöπÔ∏è','üö∫Ô∏è','üöª','üöºÔ∏è','üöæ','üõÇ','üõÉ','üõÑ','üõÖ','‚ö†Ô∏è','üö∏','‚õîÔ∏è','üö´','üö≥','üö≠Ô∏è','üöØ','üö±','üö∑','üìµ','üîû','‚ò¢Ô∏è','‚ò£Ô∏è','‚¨ÜÔ∏è','‚ÜóÔ∏è','‚ÜïÔ∏è','‚ÜîÔ∏è','‚Ü©Ô∏è','‚Ü™Ô∏è','‚§¥Ô∏è','‚§µÔ∏è','üîÉ','üîÑ','üîô','üîö','üîõ','üîú','üîù','üõê','‚öõÔ∏è','üïâÔ∏è','‚ú°Ô∏è','‚ò∏Ô∏è','‚òØÔ∏è','‚úùÔ∏è','‚ò¶Ô∏è','‚ò™Ô∏è','‚òÆÔ∏è','üïé','üîØ','‚ôàÔ∏è','‚ôâÔ∏è','‚ôäÔ∏è','‚ôãÔ∏è','‚ôåÔ∏è','‚ôçÔ∏è','‚ôéÔ∏è','‚ôèÔ∏è','‚ôêÔ∏è','‚ôëÔ∏è','‚ôíÔ∏è','‚ôìÔ∏è','‚õé','üîÄ','üîÅ','‚ñ∂Ô∏è','‚è©Ô∏è','‚è≠Ô∏è','‚èØÔ∏è','‚è∏Ô∏è','‚èπÔ∏è','‚è∫Ô∏è','‚èèÔ∏è','üé¶','üîÖ','üîÜ','üì∂','üì≥','üì¥','‚ôÄÔ∏è','‚ôÇÔ∏è','‚öß','‚ôæÔ∏è','„Ä∞Ô∏è','üí±','‚öïÔ∏è','‚ôªÔ∏è','‚öúÔ∏è','üî±','üìõ','üî∞','‚≠ïÔ∏è','‚úÖ','‚òëÔ∏è','‚úîÔ∏è','‚ùå','‚ùé','‚û∞','‚ûø','„ÄΩÔ∏è','‚ú≥Ô∏è','‚ú¥Ô∏è','‚ùáÔ∏è','¬©Ô∏è','¬ÆÔ∏è','‚Ñ¢Ô∏è','#Ô∏è‚É£','*Ô∏è‚É£','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü','üî†','üî°','üî¢','üî£','üî§','üÖ∞Ô∏è','üÜé','üÖ±Ô∏è','üÜë','üÜí','üÜì','‚ÑπÔ∏è','üÜî','‚ìÇÔ∏è','üÜï','üÜñ','üÖæÔ∏è','üÜó','üÖøÔ∏è','üÜò','üÜô','üÜö','üàÅ','üàÇÔ∏è','üà∑Ô∏è','üà∂','üàØÔ∏è','üâê','üàπ','üàöÔ∏è','üà≤','üâë','üà∏','üà¥','üà≥','„äóÔ∏è','„äôÔ∏è','üà∫','üàµ','üî¥','üü†','üü°','üü¢','üîµ','üü£','üü§','‚ö´Ô∏è','‚ö™Ô∏è','üü•','üüß','üü®','üü©','üü¶','üü™','üü´','‚¨õÔ∏è','‚¨úÔ∏è','‚óºÔ∏è','‚óªÔ∏è','‚óæÔ∏è','‚óΩÔ∏è','‚ñ™Ô∏è','‚ñ´Ô∏è','üî∂','üî∑','üî∏','üîπ','üî∫','üîª','üí†','üîò','üî≥','üî≤','üõéÔ∏è','üß≥','‚åõÔ∏è','‚è≥Ô∏è','‚åöÔ∏è','‚è∞','üïîÔ∏è','‚è±Ô∏è','‚è≤Ô∏è','üï∞Ô∏è','üå°Ô∏è','üó∫Ô∏è','üß≠','üéÉ','üéÑ','üß®','üéà','üéâ','üéä','üéé','üéè','üéê','üéÄ','üéÅ','üéóÔ∏è','üéüÔ∏è','üé´','üîÆ','üßø','üéÆÔ∏è','üïπÔ∏è','üé∞','üé≤','‚ôüÔ∏è','üß©','üß∏','üñºÔ∏è','üé®','üßµ','üß∂','üëìÔ∏è','üï∂Ô∏è','ü•Ω','ü•º','ü¶∫','üëî','üëï','üëñ','üß£','üß§','üß•','üß¶','üëó','üëò','ü•ª','ü©±','ü©≤','ü©≥','üëô','üëö','üëõ','üëú','üëù','üõçÔ∏è','üéí','üëû','üëü','ü•æ','ü•ø','üë†','üë°','ü©∞','üë¢','üëë','üëí','üé©','üéìÔ∏è','üß¢','‚õëÔ∏è','üìø','üíÑ','üíç','üíé','üì¢','üì£','üìØ','üéôÔ∏è','üéöÔ∏è','üéõÔ∏è','üé§','üéßÔ∏è','üìªÔ∏è','üé∑','üé∏','üéπ','üé∫','üéª','ü™ï','ü•Å','üì±','üì≤','‚òéÔ∏è','üìû','üìüÔ∏è','üì†','üîã','üîå','üíªÔ∏è','üñ•Ô∏è','üñ®Ô∏è','‚å®Ô∏è','üñ±Ô∏è','üñ≤Ô∏è','üíΩ','üíæ','üíøÔ∏è','üìÄ','üßÆ','üé•','üéûÔ∏è','üìΩÔ∏è','üé¨Ô∏è','üì∫Ô∏è','üì∑Ô∏è','üì∏','üìπÔ∏è','üìº','üîçÔ∏è','üîé','üïØÔ∏è','üí°','üî¶','üèÆ','ü™î','üìî','üìï','üìñ','üìó','üìò','üìô','üìöÔ∏è','üìì','üìí','üìÉ','üìú','üìÑ','üì∞','üóûÔ∏è','üìë','üîñ','üè∑Ô∏è','üí∞Ô∏è','üí¥','üíµ','üí∂','üí∑','üí∏','üí≥Ô∏è','üßæ','‚úâÔ∏è','üíå','üìß','üßß','üì®','üì©','üì§Ô∏è','üì•Ô∏è','üì¶Ô∏è','üì´Ô∏è','üì™Ô∏è','üì¨Ô∏è','üì≠Ô∏è','üìÆ','üó≥Ô∏è','‚úèÔ∏è','‚úíÔ∏è','üñãÔ∏è','üñäÔ∏è','üñåÔ∏è','üñçÔ∏è','üìù','üíº','üìÅ','üìÇ','üóÇÔ∏è','üìÖ','üìÜ','üóíÔ∏è','üóìÔ∏è','üìá','üìà','üìâ','üìä','üìãÔ∏è','üìå','üìç','üìé','üñáÔ∏è','üìè','üìê','‚úÇÔ∏è','üóÉÔ∏è','üóÑÔ∏è','üóëÔ∏è','üîíÔ∏è','üîìÔ∏è','üîè','üîê','üîë','üóùÔ∏è','üî®','ü™ì','‚õèÔ∏è','‚öíÔ∏è','üõ†Ô∏è','üó°Ô∏è','‚öîÔ∏è','üí£Ô∏è','üèπ','üõ°Ô∏è','üîß','üî©','‚öôÔ∏è','üóúÔ∏è','‚öñÔ∏è','ü¶Ø','üîó','‚õìÔ∏è','üß∞','üß≤','‚öóÔ∏è','üß™','üß´','üß¨','üî¨','üî≠','üì°','üíâ','ü©∏','üíä','ü©π','ü©∫','üö™','üõèÔ∏è','üõãÔ∏è','ü™ë','üöΩ','üöø','üõÅ','ü™í','üß¥','üß∑','üßπ','üß∫','üßª','üßº','üßΩ','üßØ','üõí','üö¨','‚ö∞Ô∏è','‚ö±Ô∏è','üè∫','üï≥Ô∏è','üèîÔ∏è','‚õ∞Ô∏è','üåã','üóª','üèïÔ∏è','üèñÔ∏è','üèúÔ∏è','üèùÔ∏è','üèüÔ∏è','üèõÔ∏è','üèóÔ∏è','üß±','üèòÔ∏è','üèöÔ∏è','üè†Ô∏è','üè°','üè¢','üè£','üè§','üè•','üè¶','üè®','üè©','üè™','üè´','üè¨','üè≠Ô∏è','üèØ','üè∞','üíí','üóº','üóΩ','‚õ™Ô∏è','üïå','üõï','üïç','‚õ©Ô∏è','üïã','‚õ≤Ô∏è','‚õ∫Ô∏è','üåÅ','üåÉ','üèôÔ∏è','üåÑ','üåÖ','üåÜ','üåá','üåâ','üóæ','üèûÔ∏è','üé†','üé°','üé¢','üíà','üé™','üöÇ','üöÉ','üöÑ','üöÖ','üöÜ','üöáÔ∏è','üöà','üöâ','üöä','üöù','üöû','üöã','üöå','üöçÔ∏è','üöé','üöê','üöëÔ∏è','üöí','üöì','üöîÔ∏è','üöï','üöñ','üöó','üöòÔ∏è','üöô','üöö','üöõ','üöú','üèéÔ∏è','üèçÔ∏è','üõµ','ü¶Ω','ü¶º','üõ∫','üö≤Ô∏è','üõ¥','üõπ','üöè','üõ£Ô∏è','üõ§Ô∏è','üõ¢Ô∏è','‚õΩÔ∏è','üö®','üö•','üö¶','üõë','üöß','‚öìÔ∏è','‚õµÔ∏è','üõ∂','üö§','üõ≥Ô∏è','‚õ¥Ô∏è','üõ•Ô∏è','üö¢','‚úàÔ∏è','üõ©Ô∏è','üõ´','üõ¨','ü™Ç','üí∫','üöÅ','üöü','üö†','üö°','üõ∞Ô∏è','üöÄ','üõ∏','üéÜ','üéá','üéë','üóø','‚öΩÔ∏è','‚öæÔ∏è','ü•é','üèÄ','üèê','üèà','üèâ','üéæ','ü•è','üé≥','üèè','üèë','üèí','ü•ç','üèì','üè∏','ü•ä','ü•ã','ü•Ö','‚õ≥Ô∏è','‚õ∏Ô∏è','üé£','ü§ø','üéΩ','üéø','üõ∑','ü•å','üéØ','ü™Ä','ü™Å','üé±','üéñÔ∏è','üèÜÔ∏è','üèÖ','ü•á','ü•à','ü•â','üçá','üçà','üçâ','üçä','üçã','üçå','üçç','ü•≠','üçé','üçè','üçê','üçë','üçí','üçì','ü•ù','üçÖ','ü••','ü•ë','üçÜ','ü•î','ü•ï','üåΩ','üå∂Ô∏è','ü•í','ü•¨','ü•¶','üßÑ','üßÖ','üçÑ','ü•ú','üå∞','üçû','ü•ê','ü•ñ','ü•®','ü•Ø','ü•û','üßá','üßÄ','üçñ','üçó','ü•©','ü•ì','üçî','üçü','üçï','üå≠','ü•™','üåÆ','üåØ','ü•ô','üßÜ','ü•ö','üç≥','ü•ò','üç≤','ü•£','ü•ó','üçø','üßà','üßÇ','ü•´','üç±','üçò','üçô','üçö','üçõ','üçú','üçù','üç†','üç¢','üç£','üç§','üç•','ü•Æ','üç°','ü•ü','ü•†','ü•°','üç¶','üçß','üç®','üç©','üç™','üéÇ','üç∞','üßÅ','ü•ß','üç´','üç¨','üç≠','üçÆ','üçØ','üçº','ü•õ','‚òïÔ∏è','üçµ','üç∂','üçæ','üç∑','üç∏Ô∏è','üçπ','üç∫','üçª','ü•Ç','ü•É','ü•§','üßÉ','üßâ','üßä','ü•¢','üçΩÔ∏è','üç¥','ü•Ñ','üî™','üêµ','üêí','ü¶ç','ü¶ß','üê∂','üêàÔ∏è','üêïÔ∏è','ü¶Æ','ü¶∫','üê©','üê∫','ü¶ä','ü¶ù','üê±','ü¶Å','üêØ','üêÖ','üêÜ','üê¥','üêé','ü¶Ñ','ü¶ì','ü¶å','üêÆ','üêÇ','üêÉ','üêÑ','üê∑','üêñ','üêó','üêΩ','üêè','üêë','üêê','üê™','üê´','ü¶ô','ü¶í','üêò','ü¶è','ü¶õ','üê≠','üêÅ','üêÄ','üêπ','üê∞','üêá','üêøÔ∏è','ü¶î','ü¶á','üêª','üêª‚Äç','‚ùÑÔ∏è','üê®','üêº','ü¶•','ü¶¶','ü¶®','ü¶ò','ü¶°','üêæ','ü¶É','üêî','üêì','üê£','üê§','üê•','üê¶Ô∏è','üêß','üïäÔ∏è','ü¶Ö','ü¶Ü','ü¶¢','ü¶â','ü¶©','ü¶ö','ü¶ú','üê∏','üêä','üê¢','ü¶é','üêç','üê≤','üêâ','ü¶ï','ü¶ñ','üê≥','üêã','üê¨','üêüÔ∏è','üê†','üê°','ü¶à','üêô','ü¶ë','ü¶Ä','ü¶û','ü¶ê','ü¶™','üêö','üêå','ü¶ã','üêõ','üêú','üêù','üêû','ü¶ó','üï∑Ô∏è','üï∏Ô∏è','ü¶Ç','ü¶ü','ü¶†','üíê','üå∏','üíÆ','üèµÔ∏è','üåπ','ü•Ä','üå∫','üåª','üåº','üå∑','üå±','üå≤','üå≥','üå¥','üåµ','üéã','üéç','üåæ','üåø','‚òòÔ∏è','üçÄ','üçÅ','üçÇ','üçÉ','üåçÔ∏è','üåéÔ∏è','üåèÔ∏è','üåë','üåí','üåì','üåî','üåïÔ∏è','üåñ','üåó','üåò','üåô','üåö','üåõ','üåúÔ∏è','‚òÄÔ∏è','üåù','üåû','ü™ê','üí´','‚≠êÔ∏è','üåü','‚ú®','üå†','üåå','‚òÅÔ∏è','‚õÖÔ∏è','‚õàÔ∏è','üå§Ô∏è','üå•Ô∏è','üå¶Ô∏è','üåßÔ∏è','üå®Ô∏è','üå©Ô∏è','üå™Ô∏è','üå´Ô∏è','üå¨Ô∏è','üåÄ','üåà','üåÇ','‚òÇÔ∏è','‚òîÔ∏è','‚õ±Ô∏è','‚ö°Ô∏è','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑÔ∏è','‚òÑÔ∏è','üî•','üíß','üåä','üí•','üí¶','üí®','üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','‚ò∫Ô∏è','üòö','üòô','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòêÔ∏è','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','üòÆ‚Äç','üí®','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','üò∂‚Äç','üå´Ô∏è','ü•¥','üòµ‚Äç','üí´','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩÔ∏è','üëæ','ü§ñ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','üôà','üôâ','üôä','üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëàÔ∏è','üëâÔ∏è','üëÜÔ∏è','üñï','üëáÔ∏è','‚òùÔ∏è','üëçÔ∏è','üëéÔ∏è','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇÔ∏è','ü¶ª','üëÉ','üß†','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ','üíã','üë∂','üßí','üë¶','üëß','üßë','üë®','üë©','üßî','üßî‚Äç‚ôÄÔ∏è','üßî‚Äç‚ôÇÔ∏è','üßë','üë®‚Äç','ü¶∞','üë©‚Äç','ü¶∞','üßë','üë®‚Äç','ü¶±','üë©‚Äç','ü¶±','üßë','üë®‚Äç','ü¶≥','üë©‚Äç','ü¶≥','üßë','üë®‚Äç','ü¶≤','üë©‚Äç','ü¶≤','üë±','üë±‚Äç‚ôÇÔ∏è','üë±‚Äç‚ôÄÔ∏è','üßì','üë¥','üëµ','üôç','üôç‚Äç‚ôÇÔ∏è','üôç‚Äç‚ôÄÔ∏è','üôé','üôé‚Äç‚ôÇÔ∏è','üôé‚Äç‚ôÄÔ∏è','üôÖ','üôÖ‚Äç‚ôÇÔ∏è','üôÖ‚Äç‚ôÄÔ∏è','üôÜ','üôÜ‚Äç‚ôÇÔ∏è','üôÜ‚Äç‚ôÄÔ∏è','üíÅ','üíÅ‚Äç‚ôÇÔ∏è','üíÅ‚Äç‚ôÄÔ∏è','üôã','üôã‚Äç‚ôÇÔ∏è','üôã‚Äç‚ôÄÔ∏è','üßè','üßè‚Äç‚ôÇÔ∏è','üßè‚Äç‚ôÄÔ∏è','üôá','üôá‚Äç‚ôÇÔ∏è','üôá‚Äç‚ôÄÔ∏è','ü§¶','ü§¶‚Äç‚ôÇÔ∏è','ü§¶‚Äç‚ôÄÔ∏è','ü§∑','ü§∑‚Äç‚ôÇÔ∏è','ü§∑‚Äç‚ôÄÔ∏è','üßë‚Äç‚öïÔ∏è','üë®‚Äç‚öïÔ∏è','üë©‚Äç‚öïÔ∏è','üßë‚Äçüéì','üë®‚Äçüéì','üë©‚Äçüéì','üßë‚Äçüè´','üë®‚Äçüè´','üë©‚Äçüè´','üßë‚Äç‚öñÔ∏è','üë®‚Äç‚öñÔ∏è','üë©‚Äç‚öñÔ∏è','üßë‚Äçüåæ','üë®‚Äçüåæ','üë©‚Äçüåæ','üßë‚Äçüç≥','üë®‚Äçüç≥','üë©‚Äçüç≥','üßë‚Äçüîß','üë®‚Äçüîß','üë©‚Äçüîß','üßë‚Äçüè≠','üë®‚Äçüè≠','üë©‚Äçüè≠','üßë‚Äçüíº','üë®‚Äçüíº','üë©‚Äçüíº','üßë‚Äçüî¨','üë®‚Äçüî¨','üë©‚Äçüî¨','üßë‚Äçüíª','üë®‚Äçüíª','üë©‚Äçüíª','üßë‚Äçüé§','üë®‚Äçüé§','üë©‚Äçüé§','üßë‚Äçüé®','üë®‚Äçüé®','üë©‚Äçüé®','üßë‚Äç‚úàÔ∏è','üë®‚Äç‚úàÔ∏è','üë©‚Äç‚úàÔ∏è','üßë‚ÄçüöÄ','üë®‚ÄçüöÄ','üë©‚ÄçüöÄ','üßë‚Äçüöí','üë®‚Äçüöí','üë©‚Äçüöí','üëÆ','üëÆ‚Äç‚ôÇÔ∏è','üëÆ‚Äç‚ôÄÔ∏è','üïµÔ∏è','üïµÔ∏è‚Äç‚ôÇÔ∏è','üïµÔ∏è‚Äç‚ôÄÔ∏è','üíÇ','üíÇ‚Äç‚ôÇÔ∏è','üíÇ‚Äç‚ôÄÔ∏è','üë∑','üë∑‚Äç‚ôÇÔ∏è','üë∑‚Äç‚ôÄÔ∏è','ü§¥','üë∏','üë≥','üë≥‚Äç‚ôÇÔ∏è','üë≥‚Äç‚ôÄÔ∏è','üë≤','üßï','ü§µ','ü§µ‚Äç‚ôÇÔ∏è','ü§µ‚Äç‚ôÄÔ∏è','üë∞','üë∞‚Äç‚ôÇÔ∏è','üë∞‚Äç‚ôÄÔ∏è','ü§∞','ü§±','üë©‚Äç','üçº','üë®‚Äç','üçº','üßë‚Äç','üçº','üëº','üéÖ','ü§∂','üßë‚Äç','üéÑ','ü¶∏','ü¶∏‚Äç‚ôÇÔ∏è','ü¶∏‚Äç‚ôÄÔ∏è','ü¶π','ü¶π‚Äç‚ôÇÔ∏è','ü¶π‚Äç‚ôÄÔ∏è','üßô','üßô‚Äç‚ôÇÔ∏è','üßô‚Äç‚ôÄÔ∏è','üßö','üßö‚Äç‚ôÇÔ∏è','üßö‚Äç‚ôÄÔ∏è','üßõ','üßõ‚Äç‚ôÇÔ∏è','üßõ‚Äç‚ôÄÔ∏è','üßú','üßú‚Äç‚ôÇÔ∏è','üßú‚Äç‚ôÄÔ∏è','üßù','üßù‚Äç‚ôÇÔ∏è','üßù‚Äç‚ôÄÔ∏è','üßû','üßû‚Äç‚ôÇÔ∏è','üßû‚Äç‚ôÄÔ∏è','üßü','üßü‚Äç‚ôÇÔ∏è','üßü‚Äç‚ôÄÔ∏è','üíÜ','üíÜ‚Äç‚ôÇÔ∏è','üíÜ‚Äç‚ôÄÔ∏è','üíá','üíá‚Äç‚ôÇÔ∏è','üíá‚Äç‚ôÄÔ∏è','üö∂','üö∂‚Äç‚ôÇÔ∏è','üö∂‚Äç‚ôÄÔ∏è','üßç','üßç‚Äç‚ôÇÔ∏è','üßç‚Äç‚ôÄÔ∏è','üßé','üßé‚Äç‚ôÇÔ∏è','üßé‚Äç‚ôÄÔ∏è','üßë‚Äç','ü¶Ø','üë®‚Äç','ü¶Ø','üë©‚Äç','ü¶Ø','üßë‚Äç','ü¶º','üë®‚Äç','ü¶º','üë©‚Äç','ü¶º','üßë‚Äç','ü¶Ω','üë®‚Äç','ü¶Ω','üë©‚Äç','ü¶Ω','üèÉ','üèÉ‚Äç‚ôÇÔ∏è','üèÉ‚Äç‚ôÄÔ∏è','üíÉ','üï∫','üï¥Ô∏è','üëØ','üëØ‚Äç‚ôÇÔ∏è','üëØ‚Äç‚ôÄÔ∏è','üßñ','üßñ‚Äç‚ôÇÔ∏è','üßñ‚Äç‚ôÄÔ∏è','üßó','üßó‚Äç‚ôÇÔ∏è','üßó‚Äç‚ôÄÔ∏è','ü§∫','üèá','‚õ∑Ô∏è','üèÇÔ∏è','üèåÔ∏è','üèåÔ∏è‚Äç‚ôÇÔ∏è','üèåÔ∏è‚Äç‚ôÄÔ∏è','üèÑÔ∏è','üèÑ‚Äç‚ôÇÔ∏è','üèÑ‚Äç‚ôÄÔ∏è','üö£','üö£‚Äç‚ôÇÔ∏è','üö£‚Äç‚ôÄÔ∏è','üèäÔ∏è','üèä‚Äç‚ôÇÔ∏è','üèä‚Äç‚ôÄÔ∏è','‚õπÔ∏è','‚õπÔ∏è‚Äç‚ôÇÔ∏è','‚õπÔ∏è‚Äç‚ôÄÔ∏è','üèãÔ∏è','üèãÔ∏è‚Äç‚ôÇÔ∏è','üèãÔ∏è‚Äç‚ôÄÔ∏è','üö¥','üö¥‚Äç‚ôÇÔ∏è','üö¥‚Äç‚ôÄÔ∏è','üöµ','üöµ‚Äç‚ôÇÔ∏è','üöµ‚Äç‚ôÄÔ∏è','ü§∏','ü§∏‚Äç‚ôÇÔ∏è','ü§∏‚Äç‚ôÄÔ∏è','ü§º','ü§º‚Äç‚ôÇÔ∏è','ü§º‚Äç‚ôÄÔ∏è','ü§Ω','ü§Ω‚Äç‚ôÇÔ∏è','ü§Ω‚Äç‚ôÄÔ∏è','ü§æ','ü§æ‚Äç‚ôÇÔ∏è','ü§æ‚Äç‚ôÄÔ∏è','ü§π','ü§π‚Äç‚ôÇÔ∏è','ü§π‚Äç‚ôÄÔ∏è','üßò','üßò‚Äç‚ôÇÔ∏è','üßò‚Äç‚ôÄÔ∏è','üõÄ','üõå','üßë‚Äç','ü§ù‚Äç','üßë','üë≠','üë´','üë¨','üíè','üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®','üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®','üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë©','üíë','üë©‚Äç‚ù§Ô∏è‚Äçüë®','üë®‚Äç‚ù§Ô∏è‚Äçüë®','üë©‚Äç‚ù§Ô∏è‚Äçüë©','üë™Ô∏è','üë®‚Äçüë©‚Äçüë¶','üë®‚Äçüë©‚Äçüëß','üë®‚Äçüë©‚Äçüëß‚Äçüë¶','üë®‚Äçüë©‚Äçüë¶‚Äçüë¶','üë®‚Äçüë©‚Äçüëß‚Äçüëß','üë®‚Äçüë®‚Äçüë¶','üë®‚Äçüë®‚Äçüëß','üë®‚Äçüë®‚Äçüëß‚Äçüë¶','üë®‚Äçüë®‚Äçüë¶‚Äçüë¶','üë®‚Äçüë®‚Äçüëß‚Äçüëß','üë©‚Äçüë©‚Äçüë¶','üë©‚Äçüë©‚Äçüëß','üë©‚Äçüë©‚Äçüëß‚Äçüë¶','üë©‚Äçüë©‚Äçüë¶‚Äçüë¶','üë©‚Äçüë©‚Äçüëß‚Äçüëß','üë®‚Äçüë¶','üë®‚Äçüë¶‚Äçüë¶','üë®‚Äçüëß','üë®‚Äçüëß‚Äçüë¶','üë®‚Äçüëß‚Äçüëß','üë©‚Äçüë¶','üë©‚Äçüë¶‚Äçüë¶','üë©‚Äçüëß','üë©‚Äçüëß‚Äçüë¶','üë©‚Äçüëß‚Äçüëß','üó£Ô∏è','üë§','üë•','üë£','‚à•','‚®ª','‚üÅ','‚ñ¢','‚¨®','‚ä†','‚ñ§','‚ñ•','‚ñ¶','‚ñ¶','‚ñ¶','‚ñ¶','‚ßá','‚ä°','‚äû','‚ßÑ','‚ó´','‚ó∞','‚ùë','‚õã','‚åë','‚ü§','‚óô','‚¨ü','‚¨°','‚è£','‚óâ','‚åæ','‚äï','‚ó¥','‚éâ','‚éä','‚óå','‚åΩ','‚äñ','‚äú','‚¨¨','‚¨≠','‚åÇ','‚ñ±','‚ñ∞','‚ûü','‚ûû','‚≠§','‚ÆÇ','·≠ö']; 
	// '
	
	let current_filename = JSON.parse(localStorage.getItem('extension-floorplanner-current-filename'));
	if(current_filename != null){
		document.getElementById('extension-floorplanner-current-filename').textContent = current_filename;
	}
	
	
	
	
	
	let floorplans = JSON.parse(localStorage.getItem('extension-floorplanner-floorplans'));
	if(floorplans == null){floorplans = {};}else{console.log("FLOORPLANS FROM LOCAL STORAGE: ", floorplans)}
	generate_floorplans_list();
	
	
	let bounding_padding = -10;
	let rotation_snappyness = 5;
	let linked_scaling = false;
	let unsaved = false;
	let manual_bg_upload = false;
	
	
	
	
	const linked_scaling_container_el = document.querySelector('#extension-floorplanner-scale-link-toggle-button-container');
	document.querySelector('#extension-floorplanner-scale-link-toggle-button').addEventListener("click", function (event) {
		if(linked_scaling){
			root_el.classList.remove('extension-floorplanner-scale-linked');
			linked_scaling = false;
		}
		else{
			root_el.classList.add('extension-floorplanner-scale-linked');
			linked_scaling = true;
		}
		console.log("linked scaling is now: ", linked_scaling);
	});
	
	const text_modal_el = document.getElementById('extension-floorplanner-textToLayer');
	
	document.querySelector('#extension-floorplanner-text-toggle-emojis-button').addEventListener("click", function (event) {
		if(text_modal_el.classList.contains('extension-floorplanner-hide-emojis-list')){
			text_modal_el.classList.remove('extension-floorplanner-hide-emojis-list');
		}
		else{
			text_modal_el.classList.add('extension-floorplanner-hide-emojis-list');
		}
	});
	
	const emojis_list_el = document.getElementById('extension-floorplanner-text-emojis-list');
	emojis_list_el.innerHTML = '';
	for (var e = 0; e < emojis.length; e++) {
		const emoji_el = document.createElement('span');
		emoji_el.textContent = emojis[e];
		emoji_el.addEventListener("click", function (event) {
			//emoji_el.innerText();
			document.getElementById('extension-floorplanner-labelBox').value = document.getElementById('extension-floorplanner-labelBox').value + emoji_el.textContent;
		});
		emojis_list_el.appendChild(emoji_el);
	}
	
	
	
	function getOffset(element){
	    var bound = element.getBoundingClientRect();
	    var html = document.documentElement;

	    return {
	        top: bound.top + window.pageYOffset - html.clientTop,
	        left: bound.left + window.pageXOffset - html.clientLeft
	    };
	}
	
	document.querySelector('#extension-floorplanner-title').addEventListener("click", function (event) {
		floorplanner_debug();
	});
	
	
	
	
	
	
	//
	//   ENGINE
	//
	
	
	
	
	// Make compatible with touch UI's
	if(touch_ui){
		linElement.addEventListener("touchend", _MOUSEUP);
		linElement.addEventListener("touchmove", throttle(function (event) { _MOUSEMOVE(event); }, 30));
		linElement.addEventListener("touchstart", _TOUCH_START, true);
	}
	else{
		linElement.addEventListener("mouseup", _MOUSEUP);
		linElement.addEventListener("mousemove", throttle(function (event) { _MOUSEMOVE(event); }, 30));
		linElement.addEventListener("mousedown", _MOUSEDOWN, true);
	}
	
	
	linElement.addEventListener("click", function (event) {
	  event.preventDefault();
		clear_selection();
	});
 

	document.querySelector('#extension-floorplanner-panel').addEventListener('mousemove', function (event) {
	  if ((mode == 'line_mode' || mode == 'partition_mode') && action == 1) {
	    action = 0;
	    if (typeof (binder) != 'undefined') {
		    //binder.remove();
	      //delete binder;
				bye_binder();
	    }
		// TODO: this check shouldn't be here
		if(document.querySelector('#extension-floorplanner-linetemp')){
		    document.querySelector('#extension-floorplanner-linetemp').remove();
		    document.querySelector('#extension-floorplanner-line_construc').remove();
		}
	    lengthTemp.remove();
	    //delete lengthTemp;
	  }
	});

	if(typeof window.floorplan_listeners_added == 'undefined'){
		//console.log("floorplan: engine.js: adding resize listeners");
		window.floorplan_listeners_added = true;

		window.addEventListener('resize', function (event) {
			
		  var rect = linElement.getBoundingClientRect(); // get the bounding rectangle

		  //console.log( rect.width );
		  //console.log( rect.height);
		  
		  //const lin_offset = getOffset(document.querySelector('#extension-floorplanner-lin'));
		  //width_viewbox = linElement.getBBox().width; //document.querySelector('#extension-floorplanner-lin').offsetWidth;
		  //height_viewbox = linElement.getBBox().height; //document.querySelector('#extension-floorplanner-lin').offsetHeight;
		  width_viewbox = rect.width;
		  height_viewbox = rect.height;
		  //console.error("!!! SETTING VIEWBOX 3: ", originX_viewbox, originY_viewbox, width_viewbox,height_viewbox);
		  //console.error("window resized.  originX_viewbox,width_viewbox: ", originX_viewbox, width_viewbox, originY_viewbox, height_viewbox);
		  document.querySelector('#extension-floorplanner-lin').setAttribute('viewBox', originX_viewbox + ' ' + originY_viewbox + ' ' + width_viewbox + ' ' + height_viewbox);
		});

		// *****************************************************************************************************
		// ******************************        KEYPRESS on KEYBOARD          *********************************
		// *****************************************************************************************************
		document.addEventListener("keydown", (event) => {
		  if (mode != "text_mode") {
		    if (event.keyCode == '37') {
		      //LEFT
		      zoom_maker('zoomleft', 100, 30);
		    }
		    if (event.keyCode == '38') {
		      //UP
		      zoom_maker('zoomtop', 100, 30);
		    }
		    if (event.keyCode == '39') {
		      //RIGHT
		      zoom_maker('zoomright', 100, 30);
		    }
		    if (event.keyCode == '40') {
		      //DOWN
		      zoom_maker('zoombottom', 100, 30);
		    }
		    if (event.keyCode == '107') {
		      //+
		      zoom_maker('zoomin', 20, 50);
		    }
		    if (event.keyCode == '109') {
		      //-
		      zoom_maker('zoomout', 20, 50);
		    }
				
			  if (event.key === 'Escape') {
					console.log("Escape keyboard press detected");
					do_select_mode();
			  }
				
			  if (event.ctrlKey && event.key === 'z') {
					console.log("CTRL Z keyboard press detected");
			    floorplanner_undo();
			  }
				
				
		  }
		  // else {
		  //   if (action == 1) {
		  //     binder.textContent = binder.textContent + event.key;
		  //     console.log(field.value);
		  //   }
		  // }
		});
	}




	function _TOUCH_START(event){
		console.log("in _TOUCH_START.  event: ", event);
		_MOUSEMOVE(event);
		_MOUSEDOWN(event);
	}


	// *****************************************************************************************************
	// ******************************        MOUSE MOVE          *******************************************
	// *****************************************************************************************************

	function _MOUSEMOVE(event) {
		//console.log("in _MOUSEMOVE. event, mode: ", event, mode);
	  event.preventDefault();
	  document.querySelector('.extension-floorplanner-sub').style.display='none';

		//console.log("ROOM: ", ROOM);
		if(typeof binder != 'undefined'){
			//console.log("mousemove -> mode, binder: ", mode, binder);
		}
		else{
			//console.log("mousemove -> mode (no binder): ", mode);
		}
		if(drag == 'on'){
			//root_el.classList.add('extension-floorplanner-do-not-pulsate');
		}
		else{
			//root_el.classList.remove('extension-floorplanner-do-not-pulsate');
		}
		
		

	  //**************************************************************************
	  //********************   MOUSE MOVE:   TEXT   MODE   *************************************
	  //**************************************************************************
	  if (mode == 'text_mode') {
			console.log("in text_mode. action: ", action);
	    snap = calcul_snap(event, grid_snap);
	    if (action == 0) cursor('text');
	    else {
	      cursor('none');
	    }
	  }

	  //**************************************************************************
	  //*******************   MOUSE MOVE:   OBJECT   MODE   ************************************
	  //**************************************************************************
	  if (mode == 'object_mode') {
			console.log("---> in object mode");
	    snap = calcul_snap(event, grid_snap);
	    if (typeof (binder) != 'undefined') {
				if(typeof binder.family != 'undefined'){
		      if ((binder.family != 'stick' && binder.family != 'collision') || WALLS.length == 0) {
						console.log("object mode: not stick/collision type, and walls length is 0")
				    console.log("binder: ", binder);
		        binder.x = snap.x;
		        binder.y = snap.y;
		        binder.oldX = binder.x;
		        binder.oldY = binder.y;
		        binder.update();
		      }
					
		      if (binder.family == 'collision') {
		        var found = false;

		        if (floorplanEditor.rayCastingWalls({ x: binder.bbox.left, y: binder.bbox.top })) found = true;
		        if (!found && floorplanEditor.rayCastingWalls({ x: binder.bbox.left, y: binder.bbox.bottom })) found = true;
		        if (!found && floorplanEditor.rayCastingWalls({ x: binder.bbox.right, y: binder.bbox.top })) found = true;
		        if (!found && floorplanEditor.rayCastingWalls({ x: binder.bbox.right, y: binder.bbox.bottom })) found = true;

		        if (!found) {
		          binder.x = snap.x;
		          binder.y = snap.y;
		          binder.oldX = binder.x;
		          binder.oldY = binder.y;
		          binder.update();
		        }
		        else {
		          binder.x = binder.oldX;
		          binder.y = binder.oldY;
		          binder.update();
		        }
		      }
		      if (binder.family == 'stick') {
		        pos = floorplanEditor.stickOnWall(snap);
		        binder.oldX = pos.x;
		        binder.oldY = pos.y;
		        var angleWall = qSVG.angleDeg(pos.wall.start.x, pos.wall.start.y, pos.wall.end.x, pos.wall.end.y);
		        var v1 = qSVG.vectorXY({ x: pos.wall.start.x, y: pos.wall.start.y }, { x: pos.wall.end.x, y: pos.wall.end.y });
		        var v2 = qSVG.vectorXY({ x: pos.wall.end.x, y: pos.wall.end.y }, snap);
		        binder.x = pos.x - Math.sin(pos.wall.angle * (360 / 2 * Math.PI)) * binder.thick / 2;
		        binder.y = pos.y - Math.cos(pos.wall.angle * (360 / 2 * Math.PI)) * binder.thick / 2;
		        var newAngle = qSVG.vectorDeter(v1, v2);
		        if (Math.sign(newAngle) == 1) {
		          angleWall += 180;
		          binder.x = pos.x + Math.sin(pos.wall.angle * (360 / 2 * Math.PI)) * binder.thick / 2;
		          binder.y = pos.y + Math.cos(pos.wall.angle * (360 / 2 * Math.PI)) * binder.thick / 2;
		        }
		        binder.angle = angleWall;
		        binder.update();
		      }
				}
				else{
					console.log("binder, but no family");
				}
	      
	    }
	    else {
				/*
				if(document.querySelector('#extension-floorplanner-object_list')){
					document.querySelector('#extension-floorplanner-object_list').style.display='none';
				}
				*/
	      if (modeOption == 'simpleStair') binder = new floorplanEditor.obj2D("free", "stair", "simpleStair", snap, 0, 0, 0, "normal", 0, 15);
	      else {
	        var typeObj = modeOption;
	        binder = new floorplanEditor.obj2D("free", "energy", typeObj, snap, 0, 0, 0, "normal", 0);
	      }
				
	      document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
				
	    }
	  }

	  //**************************************************************************
	  //**************        MOUSE MOVE:   DISTANCE MODE   ************************************
	  //**************************************************************************
	  if (mode == 'distance_mode') {
			console.log("distance_mode");
	    snap = calcul_snap(event, grid_snap);
	    if (typeof (binder) == 'undefined') {
	      cross = qSVG.create("boxbind", "path", {
	        d: "M-3000,0 L3000,0 M0,-3000 L0,3000",
	        "stroke-width": 0.5,
	        "stroke-opacity": "0.8",
	        stroke: "#e2b653",
	        fill: "#e2b653"
	      });
	      binder = new floorplanEditor.obj2D("free", "measure", "", { x: 0, y: 0 }, 0, 0, 0, "normal", 0, "");
	      labelMeasure = qSVG.create("none", "text", {
	        x: 0,
	        y: - 10,
	        'font-size': '1.2em',
	        stroke: "#ffffff",
	        "stroke-width": "0.4px",
	        'font-family': 'sans-serif',
	        'text-anchor': 'middle',
	        fill: "#3672d9"
	      });
	      binder.graph.append(labelMeasure);
	      document.querySelector('g#extension-floorplanner-boxbind').append(binder.graph);
				//document.querySelector('#extension-floorplanner-boxMeasure').append(cross);
				//document.querySelector('#extension-floorplanner-boxMeasure').append(binder.graph);
	    }
	    else {
				console.log("distance_mode: binder was already defined. cross,labelMeasure: ", cross,labelMeasure);
	      x = snap.x;
	      y = snap.y;
	      cross.setAttribute(
	        "transform", "translate(" + (snap.x) + "," + (snap.y) + ")"
	      );
	      if (action == 1) {
	        var startText = qSVG.middle(pox, poy, x, y);
	        var angleText = qSVG.angle(pox, poy, x, y);
	        var valueText = qSVG.measure({
	          x: pox,
	          y: poy
	        }, {
	          x: x,
	          y: y
	        });
					console.log("measure: valueText: ", valueText);
	        binder.size = valueText;
	        binder.x = startText.x;
	        binder.y = startText.y;
	        binder.angle = angleText.deg;
	        valueText = (valueText / meter).toFixed(2) + ' m';
	        //labelMeasure.context.textContent = valueText;
	        labelMeasure.textContent = valueText;

	        binder.update();
	      }
	    }
	  }

	  //**************************************************************************
	  //**************      MOUSE MOVE:     ROOM MODE *****************************************
	  //**************************************************************************

	  if (mode == 'room_mode') {
		  console.log("in room_mode");
	    snap = calcul_snap(event, grid_snap);
	    var roomTarget;
	    if (roomTarget = floorplanEditor.rayCastingRoom(snap)) {
	      if (typeof (binder) != 'undefined') {
	        //binder.remove();
	        //delete binder;
					bye_binder();
	      }

	      var pathSurface = roomTarget.coords;
	      var pathCreate = "M" + pathSurface[0].x + "," + pathSurface[0].y;
	      for (var p = 1; p < pathSurface.length - 1; p++) {
	        pathCreate = pathCreate + " " + "L" + pathSurface[p].x + "," + pathSurface[p].y;
	      }
	      pathCreate = pathCreate + "Z";

	      if (roomTarget.inside.length > 0) {
	        for (var ins = 0; ins < roomTarget.inside.length; ins++) {
	          pathCreate = pathCreate + " M" + Rooms.polygons[roomTarget.inside[ins]].coords[Rooms.polygons[roomTarget.inside[ins]].coords.length - 1].x + "," + Rooms.polygons[roomTarget.inside[ins]].coords[Rooms.polygons[roomTarget.inside[ins]].coords.length - 1].y;
	          for (var free = Rooms.polygons[roomTarget.inside[ins]].coords.length - 2; free > -1; free--) {
	            pathCreate = pathCreate + " L" + Rooms.polygons[roomTarget.inside[ins]].coords[free].x + "," + Rooms.polygons[roomTarget.inside[ins]].coords[free].y;
	          }
	        }
	      }
		  console.warn("room_mode: SETTING BINDER AS SVG..");
	      binder = qSVG.create('boxbind', 'path', {
	        id: "extension-floorplanner-roomSelected",
	        d: pathCreate,
	        fill: '#c9c14c',
	        'fill-opacity': 0.5,
	        stroke: '#c9c14c',
	        'fill-rule': 'evenodd',
	        'stroke-width': 3
	      });
	      binder.type = 'room';
	      binder.area = roomTarget.area;
	      binder.id = ROOM.indexOf(roomTarget);
	    }
	    else {
	      if (typeof (binder) != 'undefined') {
	        //binder.remove();
	        //delete binder;
					bye_binder();
	      }
	    }
	  }

	  //**************************************************************************
	  //**************        MOUSE MOVE:   DOOR/WINDOW MODE   *********************************
	  //**************************************************************************

	  if (mode == 'door_mode') {
		  //console.log("in door_mode");
			
			if (typeof (binder) != 'undefined' && typeof binder.update != 'undefined') {
				if (binder.class == "boundingBox"){
					bye_binder();
				}
			}
			
	    snap = calcul_snap(event, grid_snap);
		  //console.log("--snap: ", snap)
	    if (wallSelect = floorplanEditor.nearWall(snap)) {
		  console.log("--door_mode: got wall to snap to: ", wallSelect);
	      var wall = wallSelect.wall;
	      if (wall.type != 'separate') {
			  	console.log("-- wall type is not separate: ", wall.type);
	        if (typeof (binder) != 'undefined' && typeof binder.update != 'undefined') {
  			  	console.log("--door_mode: binder already existed: ", binder);
	          var angleWall = qSVG.angleDeg(wall.start.x, wall.start.y, wall.end.x, wall.end.y);
	          var v1 = qSVG.vectorXY({ x: wall.start.x, y: wall.start.y }, { x: wall.end.x, y: wall.end.y });
	          var v2 = qSVG.vectorXY({ x: wall.end.x, y: wall.end.y }, snap);
	          var newAngle = qSVG.vectorDeter(v1, v2);
	          binder.angleSign = 0;
	          if (Math.sign(newAngle) == 1) {
	            binder.angleSign = 1;
	            angleWall += 180;
	          }

	          var limits = limitObj(wall.equations.base, binder.size, wallSelect);
	          if (qSVG.btwn(limits[0].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[0].y, wall.start.y, wall.end.y) && qSVG.btwn(limits[1].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[1].y, wall.start.y, wall.end.y)) {
	            binder.x = wallSelect.x;
	            binder.y = wallSelect.y;
	            binder.angle = angleWall;
	            binder.thick = wall.thick;
	            binder.limit = limits;
	            binder.update();
	          }

	          if ((wallSelect.x == wall.start.x && wallSelect.y == wall.start.y) || (wallSelect.x == wall.end.x && wallSelect.y == wall.end.y)) {
	            if (qSVG.btwn(limits[0].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[0].y, wall.start.y, wall.end.y)) {
	              binder.x = limits[0].x;
	              binder.y = limits[0].y;
	            }
	            if (qSVG.btwn(limits[1].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[1].y, wall.start.y, wall.end.y)) {
	              binder.x = limits[1].x;
	              binder.y = limits[1].y;
	            }
	            binder.limit = limits;
	            binder.angle = angleWall;
	            binder.thick = wall.thick;
	            binder.update();
	          }
	        }
	        else {
  			  	console.log("-- binder is undefined, making doorWindow object.  modeOption, wallSelect,wall.thick:", modeOption, wallSelect,wall.thick);
	          // family, classe, type, pos, angle, angleSign, size, hinge, thick 
	          binder = new floorplanEditor.obj2D("inWall", "doorWindow", modeOption, wallSelect, 0, 0, 60, "normal", wall.thick);
						console.log("new door binder, should be obj2D: ", binder);
	          var angleWall = qSVG.angleDeg(wall.start.x, wall.start.y, wall.end.x, wall.end.y);
						console.log("angleWall: ", angleWall);
	          var v1 = qSVG.vectorXY({ x: wall.start.x, y: wall.start.y }, { x: wall.end.x, y: wall.end.y });
	          var v2 = qSVG.vectorXY({ x: wall.end.x, y: wall.end.y }, snap);
	          var newAngle = qSVG.vectorDeter(v1, v2);
						console.log("newAngle: ", newAngle);
	          if (Math.sign(newAngle) == 1) {
	            angleWall += 180;
	            binder.angleSign = 1;
	          }
	          var startCoords = qSVG.middle(wall.start.x, wall.start.y, wall.end.x, wall.end.y);
						console.log("startCoords: ", startCoords);
	          binder.x = startCoords.x;
	          binder.y = startCoords.y;
	          binder.angle = angleWall;
	          binder.update();
						console.log("door mode: appending binder.graph: ", binder.graph);
	          document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
	        }
	      }
	    }
	    else {
	      if (typeof (binder) != 'undefined') {
			    console.log("cannot add door: no walls yet?");
	        //binder.graph.remove();
	        //delete binder;
					bye_binder();
	      }
	    }
	  } // END DOOR MODE

	  //**************************************************************************
	  //**************        MOUSE MOVE:   NODE MODE *****************************************
	  //**************************************************************************

	  if (mode == 'node_mode') {
		  console.log("in node_mod. This creates circlebinder as binder if there isn't already a binder");
	    snap = calcul_snap(event, grid_snap);

	    if (typeof (binder) == 'undefined') {
	      if (addNode = floorplanEditor.nearWall(snap, 30)) {
	        var x2 = addNode.wall.end.x;
	        var y2 = addNode.wall.end.y;
	        var x1 = addNode.wall.start.x;
	        var y1 = addNode.wall.start.y;
	        angleWall = qSVG.angle(x1, y1, x2, y2);
					console.warn("node_mode: SETTING BINDER AS SVG..");
	        binder = qSVG.create('boxbind', 'path', {
	          id: "extension-floorplanner-circlebinder",
	          d: "M-20,-10 L-13,0 L-20,10 Z M-13,0 L13,0 M13,0 L20,-10 L20,10 Z",
	          stroke: "#5cba79",
	          fill: "#5cba79",
	          "stroke-width": "1.5px"
	        });
			
	        binder.setAttribute(
	          "transform", "translate(" + (addNode.x) + "," + (addNode.y) + ") rotate(" + (angleWall.deg + 90) + ",0,0)"
	        );
	        binder.data = addNode;
	        binder.x1 = x1;
	        binder.x2 = x2;
	        binder.y1 = y1;
	        binder.y2 = y2;
					console.log("node_mode: see? binder: ", binder);
	      }
	    } else {
				console.log("node_mode: a binder already existed: ", binder);
				console.log("node_mode: addNode: ", floorplanEditor.nearWall(snap, 30));
	      if (addNode = floorplanEditor.nearWall(snap, 30)) {
	        if (addNode) {
	          var x2 = addNode.wall.end.x;
	          var y2 = addNode.wall.end.y;
	          var x1 = addNode.wall.start.x;
	          var y1 = addNode.wall.start.y;
	          angleWall = qSVG.angle(x1, y1, x2, y2);
	          binder.setAttribute(
	            "transform", "translate(" + (addNode.x) + "," + (addNode.y) + ") rotate(" + (angleWall.deg + 90) + ",0,0)"
	          );
	          binder.data = addNode;
	        }
	        else {
				console.log("node_mode: removing binder 2");
	          //binder.remove();
	          //delete binder;
						bye_binder();
	        }
	      } else {
			  console.log("node_mode: removing binder");
	        //binder.remove();
	        //delete binder;
					bye_binder();
	      }
	    }
	  } // END NODE MODE

	  //**********************************  SELECT MODE ***************************************************************
	  if (mode == 'select_mode' && drag == 'off') { // FIRST TEST ON SELECT MODE (and drag OFF) to detect MOUSEOVER DOOR
		  //console.log("in select_mode.  drag,OBJDATA: ", drag, OBJDATA);
	    snap = calcul_snap(event, 'off');
			//console.log("select mode: snap: ", snap);
	    
			var objTarget = false;
			//console.log("select_mode: OBJDATA: ", OBJDATA);
	    //for (var i = OBJDATA.length -1; i >= 0; i--) {
			for (var i = 0; i < OBJDATA.length; i++) {
				//console.log(i, ": OBJ: ",  OBJDATA[i]);
				if(typeof OBJDATA[i].type == 'undefined'){
					console.error("OBJ has undefined type. This should not happen.");
					//OBJDATA.slice(i,1);
				}
	      var objX1 = OBJDATA[i].bbox.left;
	      var objX2 = OBJDATA[i].bbox.right;
	      var objY1 = OBJDATA[i].bbox.top;
	      var objY2 = OBJDATA[i].bbox.bottom;
	      var realBboxCoords = OBJDATA[i].realBbox;
				//console.log("realBboxCoords: ", realBboxCoords);
	      if (qSVG.rayCasting(snap, realBboxCoords)) {
					console.warn("FOUND NEARBY OBJECT: ", OBJDATA[i]);
	        objTarget = OBJDATA[i];
					//binder = OBJDATA[i];
					// TODO: why not break here?
	      }
	    }
			
			if(objTarget == false){
				//console.log("did not find a nearby object");
				//hideAllSize();
			}
			
			//console.log("select_mode: objTarget:", objTarget);
			if (typeof (binder) != 'undefined'){
				console.log("select_mode: binder:", binder);
			}
			
			
	    if (objTarget !== false) {
				console.log("selectMode found a target object: ", objTarget);
	      if (typeof (binder) != 'undefined' && (binder.type == 'segment')) {
					console.log("select_mode: removing existing binder of segment type first");
					//console.log("removing binder that is segment type");
	        binder.graph.remove();
	        //delete binder;
					bye_binder();
	        cursor('default');
	      }
				
	      if (objTarget.params.bindBox) { // OBJ -> BOUNDINGBOX TOOL
					console.warn("select_mode:  OBJTARGET HAS BINDBOX -> setting binder as obj2D boundingbox");
	        if (typeof (binder) == 'undefined') {
	          binder = new floorplanEditor.obj2D("free", "boundingBox", "", objTarget.bbox.origin, objTarget.angle, 0, objTarget.size*0.5, "normal", objTarget.thick*0.5, objTarget.realBbox);
	          binder.update();
	          binder.obj = objTarget;
	          binder.type = 'boundingBox';
	          binder.oldX = binder.x;
	          binder.oldY = binder.y;
	          document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
	          if (!objTarget.params.move) cursor('trash'); // LIKE MEASURE ON PLAN
	          if (objTarget.params.move) {
							console.log("this objTarget.params.move is true, setting move cursor");
							cursor('move');
						}
					}
	      }
	      else {  // DOOR, WINDOW, APERTURE.. -- OBJ WITHOUT BINDBOX (params.bindBox = False) -- !!!!
			    console.log("select_mode: DOOR, WINDOW, APERTURE.. -- NEARBY OBJTARGET, but WITHOUT BINDBOX");
	        console.log("++objTarget: ", objTarget);
					
					if(typeof (binder) == 'undefined'){
						console.log("select_mode: binder already existed: ", binder);
						
						var wallList = floorplanEditor.rayCastingWall(objTarget);
	          if (wallList.length > 1) wallList = wallList[0];
	          inWallRib(wallList);
	          var thickObj = wallList.thick;
	          var sizeObj = objTarget.size;
						//hideAllSize();
	          binder = new floorplanEditor.obj2D("inWall", "socle", "", objTarget, objTarget.angle, 0, sizeObj, "normal", thickObj);
	          binder.update();
						
	          binder.oldXY = { x: objTarget.x, y: objTarget.y }; // FOR OBJECT MENU
	          document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
						
						
						/*
						//console.log("event.target =?= binder.graph.firstChild: ", event.target, binder.graph.firstChild)
	          
						if (typeof binder.graph != 'undefined' && event.target == binder.graph.firstChild) {
	            cursor('move');
	            binder.graph.firstChild.setAttribute("class", "extension-floorplanner-circle_css_2");
	            binder.type = "obj";
	            binder.obj = objTarget;
	          }
	          else if(typeof binder.graph != 'undefined'){
	            cursor('default');
	            binder.graph.firstChild.setAttribute("class", "extension-floorplanner-circle_css_1");
	            binder.type = false;
	          }
						else{
							console.error("eh? binder but no graph, unexpectedly");
							bye_binder();
							
		          var wallList = floorplanEditor.rayCastingWall(objTarget);
		          if (wallList.length > 1) wallList = wallList[0];
		          inWallRib(wallList);
		          var thickObj = wallList.thick;
		          var sizeObj = objTarget.size;

		          binder = new floorplanEditor.obj2D("inWall", "socle", "", objTarget, objTarget.angle, 0, sizeObj, "normal", thickObj);
				  		console.log("select_mode: binder or inWall type: ", binder);
		          binder.update();

		          binder.oldXY = { x: objTarget.x, y: objTarget.y }; // FOR OBJECT MENU
		          document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
						}
						*/
					}
					else {
						
						if(typeof binder != 'undefined'){
		          //if (event.target == binder.graph.get(0).firstChild) {
							if (typeof binder.graph != 'undefined' && event.target == binder.graph.firstChild) {
		            cursor('move');
		            //binder.graph.get(0).firstChild.setAttribute("class", "circle_css_2");
								
		            binder.type = "obj";
		            binder.obj = objTarget;
								if(typeof binder.graph != 'undefined'){
									if(typeof binder.graph.firstChild != 'undefined'){
										console.log("binder.graph.firstChild: ", binder.graph.firstChild);
										if(binder.graph.firstChild != null){
											binder.graph.firstChild.setAttribute("class", "extension-floorplanner-circle_css_2");
										}
										
									}
									else{
										console.error("missing binder.graph.firstChild: ", binder.graph);
									}
								}
								else{
									console.error("expected a binder.graph");
								}
								
		          }
		          else {
		            cursor('default');
		            //binder.graph.get(0).firstChild.setAttribute("class", "circle_css_1");
								
		            binder.type = false;
								if(typeof binder.graph != 'undefined'){
									if(typeof binder.graph.firstChild != 'undefined'){
										console.log("binder.graph.firstChild: ", binder.graph.firstChild);
										if(binder.graph.firstChild != null){
											binder.graph.firstChild.setAttribute("class", "extension-floorplanner-circle_css_1");
										}
									}
									else{
										console.error("missing binder.graph.firstChild: ", binder.graph);
									}
								}
								else{
									console.error("expected a binder.graph");
								}
								
		          }
						}
						else{
							console.error("expected a binder");
						}
	          
						
						/*
	          var wallList = floorplanEditor.rayCastingWall(objTarget);
	          if (wallList.length > 1) wallList = wallList[0];
	          inWallRib(wallList);
	          var thickObj = wallList.thick;
	          var sizeObj = objTarget.size;

	          binder = new floorplanEditor.obj2D("inWall", "socle", "", objTarget, objTarget.angle, 0, sizeObj, "normal", thickObj);
			  		console.log("select_mode: binder or inWall type: ", binder);
	          binder.update();

	          binder.oldXY = { x: objTarget.x, y: objTarget.y }; // FOR OBJECT MENU
	          document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
						*/
	        }
	      }
	    }
	    else{
	    	//console.log("Did not find an objTarget");
	    }

	    // BIND CIRCLE IF nearNode and GROUP ALL SAME XY SEG POINTS
	    if (wallNode = floorplanEditor.nearWallNode(snap, 20)) {
				console.log("POINTER IS NEAR WALL NODE");
				if(typeof binder != 'undefined'){
					console.log("--binder already exists: ", binder);
				}
	      if (typeof binder == 'undefined' || (typeof binder != 'undefined' && typeof binder.type != 'undefined' && binder.type == 'segment')) {
	        console.log("replacing binder of type segment with unkillable circlebinder");
					bye_binder();
					binder = qSVG.create('boxbind', 'circle', {
	          id: "extension-floorplanner-circlebinder",
	          class: "extension-floorplanner-circle_css_2",
	          cx: wallNode.x,
	          cy: wallNode.y,
	          r: Rcirclebinder
	        });
	        binder.data = wallNode;
	        binder.type = "node";
					if (document.querySelectorAll('#extension-floorplanner-linebinder').length) document.querySelector('#extension-floorplanner-linebinder').remove();
	        
	      } else {
					console.log("...nothing here")
	        // REMAKE CIRCLE_CSS ON BINDER AND TAKE DATA SEG GROUP
	        // if (typeof(binder) != 'undefined') {
	        //     binder.attr({
	        //         class: "circle_css_2"
	        //     });
	        // }
	      }
				
	      cursor('move');
	    }
			else if (typeof (binder) != "undefined" && typeof binder.type != "undefined") {
				console.log("\n\nchecking binder and objTarget: ", binder, objTarget);
				if(binder.type == 'node'){
					console.log("select_mode: not near wall node, but binder type is node, so calling bye_binder");
					bye_binder();
	        //binder.remove();
	        //delete binder;
	        hideAllSize();
	        cursor('default');
	        rib();
				}
				else if(typeof binder.family != 'undefined' 
							&& binder.family == 'inWall' 
							&& typeof binder.class != 'undefined' 
							&& (binder.class == 'socle' || binder.class == 'doorWindow')
							&& objTarget !== false 
							&& objTarget.family == 'inWall' 
							&& objTarget.class == 'doorWindow'){
					
					console.warn("spotted the repeating wall thingy issue");
					//hideAllSize();
					//bye_binder();
					//hideAllSize();
					
					
					
					//binder = objTarget;
	        //binder.remove();
	        //delete binder;
	        
	        //cursor('default');
	        //rib();
					
				}
				else if(typeof binder.family != 'undefined' 
							&& binder.family == 'inWall' 
							&& typeof binder.class != 'undefined' 
							&& (binder.class == 'socle' || binder.class == 'doorWindow')
							&& objTarget === false ){
					
					console.warn("binder is inWall, while objTarget is false");
					bye_binder();
					hideAllSize();
					
					
				}
				else{
					console.log("mouse move: fell through. binder: ", binder, "\n\n");
				}
				
	      
	    }
	    else if (typeof binder != 'undefined') {
				console.log("select_mode, but nothing near the mouse pointer? HOWEVER, binder was not undefined: ", binder);
	      
				//console.log("clearing binder")
        //if (typeof (binder.graph) != 'undefined') binder.graph.remove();
        
				//if (binder.type == 'node') binder.remove();
        //delete binder;
				//document.querySelector('#extension-floorplanner-boxbind').replaceChildren(); // experiment
        
				//bye_binder();
				//cursor('default');
        //rib();

	    }
			
			if (typeof binder != "undefined"){
				console.log("Heyyyy, a binder still exists just before wall checking: ", binder);
			}
			else{
				//console.log("before wall checking binder is gone");
			}
			

	    // BIND WALL WITH NEARPOINT function ---> WALL BINDER CREATION
	    if (wallBind = floorplanEditor.rayCastingWalls(snap, WALLS)) {
				console.log("wallBinder creation. wallBind: ", wallBind);
	      if (wallBind.length > 1) wallBind = wallBind[wallBind.length - 1];
	      if (wallBind && typeof (binder) == 'undefined') {
	        var objWall = floorplanEditor.objFromWall(wallBind);
	        if (objWall.length > 0) floorplanEditor.inWallRib2(wallBind);
	        binder = {};
	        binder.wall = wallBind;
	        inWallRib(binder.wall);
	        var line = qSVG.create('none', 'line', {
	          x1: binder.wall.start.x, y1: binder.wall.start.y, x2: binder.wall.end.x, y2: binder.wall.end.y,
	          "stroke-width": 5,
	          stroke: "#5cba79"
	        });
	        var ball1 = qSVG.create('none', 'circle', {
	          class: "extension-floorplanner-circle_css",
	          cx: binder.wall.start.x, cy: binder.wall.start.y,
	          r: Rcirclebinder / 1.8
	        });
	        var ball2 = qSVG.create('none', 'circle', {
	          class: "extension-floorplanner-circle_css",
	          cx: binder.wall.end.x, cy: binder.wall.end.y,
	          r: Rcirclebinder / 1.8
	        });
	        binder.graph = qSVG.create('none', 'g');
	        binder.graph.append(line);
	        binder.graph.append(ball1);
	        binder.graph.append(ball2);
	        document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
	        binder.type = "segment";
	        cursor('pointer');
	      }
	    } else {
				//console.log("doing nearWall");
	      if (wallBind = floorplanEditor.nearWall(snap, 6)) {
					//console.log("got wallbind after doing nearwall: ", wallBind);
	        if (wallBind && typeof (binder) == 'undefined') {
						//console.log("got wallbind after doing nearwall, but binder was undefined. Creating an SVG of a line between two balls.");
	          wallBind = wallBind.wall;
	          var objWall = floorplanEditor.objFromWall(wallBind);
	          if (objWall.length > 0) floorplanEditor.inWallRib2(wallBind);
	          binder = {};
	          binder.wall = wallBind;
	          inWallRib(binder.wall);
	          var line = qSVG.create('none', 'line', {
	            x1: binder.wall.start.x, y1: binder.wall.start.y, x2: binder.wall.end.x, y2: binder.wall.end.y,
	            "stroke-width": 5,
	            stroke: "#5cba79"
	          });
	          var ball1 = qSVG.create('none', 'circle', {
	            class: "extension-floorplanner-circle_css",
	            cx: binder.wall.start.x, cy: binder.wall.start.y,
	            r: Rcirclebinder / 1.8
	          });
	          var ball2 = qSVG.create('none', 'circle', {
	            class: "extension-floorplanner-circle_css",
	            cx: binder.wall.end.x, cy: binder.wall.end.y,
	            r: Rcirclebinder / 1.8
	          });
	          binder.graph = qSVG.create('none', 'g');
	          binder.graph.append(line);
	          binder.graph.append(ball1);
	          binder.graph.append(ball2);
	          document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
	          binder.type = "segment";
	          cursor('pointer');
	        }
	      }
	      else {
					//console.log("not near a wall");
					if (typeof (binder) != "undefined"){
						//console.log("I'd like to delete this binder: ", binder);
		        if (typeof (binder) != "undefined" && typeof binder.type != 'undefined' && binder.type == 'segment') {
							//console.log("not near a wall, and binder was of type segment, so removing that old wall indicator.");
		          //binder.graph.remove();
		          //delete binder;
							bye_binder();
		          hideAllSize();
		          cursor('default');
		          rib();
		        }
						else if(objTarget == false){
							if(typeof binder.obj != 'undefined'){
								bye_binder();
			          hideAllSize();
			          cursor('default');
			          rib();
							}
							else if( isNaN(binder.height) ){
								bye_binder();
			          hideAllSize();
			          cursor('default');
			          rib();
							}
						}
						else{
							if(typeof binder.obj != 'undefined'){
								if(objTarget == binder.obj){
									console.log("GOOD, the binder is the currently nearest object.");
								}
								else{
									bye_binder();
				          hideAllSize();
				          cursor('default');
				          rib();
								}
							}
							else if( isNaN(binder.height) ){
								console.error("binder.height was NaN");
								bye_binder();
			          hideAllSize();
			          cursor('default');
			          rib();
							}
							
							
							
						}
						console.log("but should check if it's actually nearby.  objTarget: ", objTarget);
						/*
						if(typeof binder.obj != 'undefined'){
							bye_binder();
		          hideAllSize();
		          cursor('default');
		          rib();
						}
						*/
						
					}
	        
					/*
					else if (typeof (binder) != "undefined"){
						bye_binder();
	          hideAllSize();
	          cursor('default');
	          rib();
					}
					*/
	      }
	    }
	  } // END mode == 'select_mode' && drag == 'off'

	  // ------------------------------  LINE MODE ------------------------------------------------------

	  if ((mode == 'line_mode' || mode == 'partition_mode') && action == 0) {
	    snap = calcul_snap(event, 'off');
	    cursor('grab');
	    pox = snap.x;
	    poy = snap.y;
	    if (helpConstruc = intersection(snap, 25)) {
	      if (helpConstruc.distance < 10) {
	        pox = helpConstruc.x;
	        poy = helpConstruc.y;
	        cursor('grab');
	      } else {
	        cursor('crosshair');
	      }
	    }
	    if (wallNode = floorplanEditor.nearWallNode(snap, 20)) {
	      pox = wallNode.x;
	      poy = wallNode.y;
	      cursor('grab');
	      if (typeof (binder) == 'undefined') {
	        binder = qSVG.create('boxbind', 'circle', {
	          id: "extension-floorplanner-circlebinder",
	          class: "extension-floorplanner-circle_css_2",
	          cx: wallNode.x,
	          cy: wallNode.y,
	          r: Rcirclebinder / 1.5
	        });
	      }
	      intersectionOff();
	    } else {
	      if (!helpConstruc) cursor('crosshair');
	      if (typeof (binder) != "undefined") {
	        if (binder.graph) binder.graph.remove();
	        else bye_binder();//binder.remove();
	        //delete binder;
	      }
	    }
	  }

	  // ******************************************************************************************************
	  // ************************** ACTION = 1   LINE MODE => WALL CREATE                 *********************
	  // ******************************************************************************************************

	  if (action == 1 && (mode == 'line_mode' || mode == 'partition_mode')) {
	    snap = calcul_snap(event, grid_snap);
	    x = snap.x;
	    y = snap.y;
	    starter = minMoveGrid(snap);

	    if (!document.querySelectorAll('#extension-floorplanner-line_construc').length) {
	      if (wallNode = floorplanEditor.nearWallNode(snap, 20)) {
	        pox = wallNode.x;
	        poy = wallNode.y;

	        wallStartConstruc = false;
	        if (wallNode.bestWall == WALLS.length - 1) {
	          cursor('validation');
	        }
	        else {
	          cursor('grab');
	        }
	      } else {
	        cursor('crosshair');
	      }
	    }


	    if (starter > grid) {
		      if (!document.querySelectorAll('#extension-floorplanner-line_construc').length) {
	        var ws = 20;
	        if (mode == 'partition_mode') ws = 10;
	        lineconstruc = qSVG.create("boxbind", "line", {
	          id: "extension-floorplanner-line_construc",
	          x1: pox,
	          y1: poy,
	          x2: x,
	          y2: y,
	          "stroke-width": ws,
	          "stroke-linecap": "butt",
	          "stroke-opacity": 0.7,
	          stroke: "#9fb2e2"
	        });

	        svgadd = qSVG.create("boxbind", "line", { // ORANGE TEMP LINE FOR ANGLE 0 90 45 -+
	          id: "extension-floorplanner-linetemp",
	          x1: pox,
	          y1: poy,
	          x2: x,
	          y2: y,
	          "stroke": "transparent",
	          "stroke-width": 0.5,
	          "stroke-opacity": "0.9"
	        });
	      } else { // THE LINES AND BINDER ARE CREATED

			  // TODO: this check shouldn't exist.. maybe?
			  if(document.querySelector('#extension-floorplanner-linetemp')){
				  document.querySelector('#extension-floorplanner-linetemp').setAttribute('x2',x);
				  document.querySelector('#extension-floorplanner-linetemp').setAttribute('y2',y);
			  }
			  

	        if (helpConstrucEnd = intersection(snap, 10)) {
	          x = helpConstrucEnd.x;
	          y = helpConstrucEnd.y;
	        }
	        if (wallEndConstruc = floorplanEditor.nearWall(snap, 12)) { // TO SNAP SEGMENT TO FINALIZE X2Y2
	          x = wallEndConstruc.x;
	          y = wallEndConstruc.y;
	          cursor('grab');
	        } else {
	          cursor('crosshair');
	        }

	        // nearNode helped to attach the end of the construc line
	        if (wallNode = floorplanEditor.nearWallNode(snap, 20)) {
	          if (typeof (binder) == 'undefined') {
	            binder = qSVG.create('boxbind', 'circle', {
	              id: "extension-floorplanner-circlebinder",
	              class: "extension-floorplanner-circle_css_2",
	              cx: wallNode.x,
	              cy: wallNode.y,
	              r: Rcirclebinder / 1.5
	            });
	          }
						
						const testje = document.querySelectorAll('#extension-floorplanner-line_construc');
						if(testje.length > 1){
							console.error("yikes, there are multiple linecontructs with the same ID");
						}
						
						document.querySelector('#extension-floorplanner-line_construc').setAttribute('x2',wallNode.x);
						document.querySelector('#extension-floorplanner-line_construc').setAttribute('y2',wallNode.y);
  
	          x = wallNode.x;
	          y = wallNode.y;
	          wallEndConstruc = true;
	          intersectionOff();
	          if (wallNode.bestWall == WALLS.length - 1 && document.getElementById("extension-floorplanner-multi").checked) {
	            cursor('validation');
	          }
	          else {
	            cursor('grab');
	          }
	        } else {
	          if (typeof (binder) != "undefined") {
	            //binder.remove();
	            //delete binder;
							bye_binder();
	          }
	          if (wallEndConstruc === false) cursor('crosshair');
	        }
	        // LINETEMP AND LITLLE SNAPPING FOR HELP TO CONSTRUC ANGLE 0 90 45 *****************************************
	        var fltt = qSVG.angle(pox, poy, x, y);
	        var flt = Math.abs(fltt.deg);
	        var coeff = fltt.deg / flt; // -45 -> -1     45 -> 1
	        var phi = poy - (coeff * pox);
	        var Xdiag = (y - phi) / coeff;
	        if (typeof (binder) == 'undefined') {
	          // HELP FOR H LINE
	          var found = false;
	          if (flt < 15 && Math.abs(poy - y) < 25) {
	            y = poy;
	            found = true;
	          } // HELP FOR V LINE
	          if (flt > 75 && Math.abs(pox - x) < 25) {
	            x = pox;
	            found = true;
	          } // HELP FOR DIAG LINE
	          if (flt < 55 && flt > 35 && Math.abs(Xdiag - x) < 20) {
	            x = Xdiag;
	            found = true;
	          }
	          if (found) document.querySelector('#extension-floorplanner-line_construc').setAttribute( "stroke-opacity",1);
	          else document.querySelector('#extension-floorplanner-line_construc').setAttribute( "stroke-opacity",0.7);
	        }
					if(document.querySelector('#extension-floorplanner-line_construc')){
		        document.querySelector('#extension-floorplanner-line_construc').setAttribute( "x2",x);
						document.querySelector('#extension-floorplanner-line_construc').setAttribute( "y2",y);
					}
	        

	        // SHOW WALL SIZE -------------------------------------------------------------------------
	        var startText = qSVG.middle(pox, poy, x, y);
	        var angleText = qSVG.angle(pox, poy, x, y);
	        var valueText = ((qSVG.measure({
	          x: pox,
	          y: poy
	        }, {
	          x: x,
	          y: y
	        })) / 60).toFixed(2);
	        if (typeof (lengthTemp) == 'undefined') {
	          lengthTemp = document.createElementNS('http://www.w3.org/2000/svg', 'text');
	          lengthTemp.setAttributeNS(null, 'x', startText.x);
	          lengthTemp.setAttributeNS(null, 'y', (startText.y) - 15);
	          lengthTemp.setAttributeNS(null, 'text-anchor', 'middle');
	          lengthTemp.setAttributeNS(null, 'stroke', 'none');
	          lengthTemp.setAttributeNS(null, 'stroke-width', '0.6px');
	          lengthTemp.setAttributeNS(null, 'fill', '#777777');
	          lengthTemp.textContent = valueText + 'm';
	          document.querySelector('#extension-floorplanner-boxbind').append(lengthTemp);
	        }
	        if (typeof (lengthTemp) != 'undefined' && valueText > 0.1) {
	          lengthTemp.setAttributeNS(null, 'x', startText.x);
	          lengthTemp.setAttributeNS(null, 'y', (startText.y) - 15);
	          lengthTemp.setAttribute("transform", "rotate(" + angleText.deg + " " + startText.x + "," + startText.y + ")");
	          lengthTemp.textContent = valueText + ' m';
	        }
	        if (typeof (lengthTemp) != 'undefined' && valueText < 0.1) {
	          lengthTemp.textContent = "";
	        }
	      }
	    }
	  } // END LINE MODE DETECT && ACTION = 1

	  //ONMOVE
	  // **************************************************************************************************
	  //        ____ ___ _   _ ____  _____ ____
	  //        | __ )_ _| \ | |  _ \| ____|  _ \
	  //        |  _ \| ||  \| | | | |  _| | |_) |
	  //        | |_) | || |\  | |_| | |___|  _ <
	  //        |____/___|_| \_|____/|_____|_| \_\
	  //
	  // **************************************************************************************************

	  if (mode == 'bind_mode') {
		  console.log("in bind_mode. binder: ", binder);
		  console.log("--binder.type: ", binder.type);
	    snap = calcul_snap(event, grid_snap);
		  console.log("snap: ", snap);
		
	    if (binder.type == 'node') {
				console.log("binder type is node");
	      var coords = snap;
	      var magnetic = false;
	      for (var k in wallListRun) {
	        if (isObjectsEquals(wallListRun[k].end, binder.data)) {
	          if (Math.abs(wallListRun[k].start.x - snap.x) < 20) { coords.x = wallListRun[k].start.x; magnetic = "H"; }
	          if (Math.abs(wallListRun[k].start.y - snap.y) < 20) { coords.y = wallListRun[k].start.y; magnetic = "V"; }
	        }
	        if (isObjectsEquals(wallListRun[k].start, binder.data)) {
	          if (Math.abs(wallListRun[k].end.x - snap.x) < 20) { coords.x = wallListRun[k].end.x; magnetic = "H"; }
	          if (Math.abs(wallListRun[k].end.y - snap.y) < 20) { coords.y = wallListRun[k].end.y; magnetic = "V"; }
	        }
	      }

				console.log("near wall? ", floorplanEditor.nearWallNode(snap, 15, wallListRun));
	      if (nodeMove = floorplanEditor.nearWallNode(snap, 15, wallListRun)) { // sic: single =
	        coords.x = nodeMove.x;
	        coords.y = nodeMove.y;
					
					console.log("WRONG BINDER?! ", binder);
					
					if(document.querySelector('#extension-floorplanner-circlebinder')){
						console.log("circlebinder el existed: ", document.querySelector('#extension-floorplanner-circlebinder'));
						document.querySelector('#extension-floorplanner-circlebinder').setAttribute( "class","extension-floorplanner-circleGum");
						document.querySelector('#extension-floorplanner-circlebinder').setAttribute( "cx",coords.x);
						document.querySelector('#extension-floorplanner-circlebinder').setAttribute( "cy",coords.y);
					}
					else{
						console.log("circlebinder el did not exist");
						/*
						bye_binder();
		        binder = qSVG.create('boxbind', 'circle', {
		          id: "extension-floorplanner-circlebinder",
		          class: "extension-floorplanner-circleGum",
		          cx: coords.x,
		          cy: coords.y,
		          r: Rcirclebinder
		        });
		        //binder.data = wallNode;
		        //binder.type = "node";
						*/
					}
					
	        cursor('grab');
	      } else {
					console.log("RIGHT BINDER?!", binder);
	        if (magnetic != false) {
	          if (magnetic == "H") snap.x = coords.x;
	          else snap.y = coords.y;
	        }
	        if (helpConstruc = intersection(snap, 10, wallListRun)) {
	          coords.x = helpConstruc.x;
	          coords.y = helpConstruc.y;
	          snap.x = helpConstruc.x;
	          snap.y = helpConstruc.y;
	          if (magnetic != false) {
	            if (magnetic == "H") snap.x = coords.x;
	            else snap.y = coords.y;
	          }
	          cursor('grab');
	        } else {
	          cursor('move');
	        }
	        binder.remove()
					//bye_binder();
	        //document.querySelector('#extension-floorplanner-circlebinder').attr({"class": "circle_css", cx: coords.x, cy: coords.y});
	      }
	      for (var k in wallListRun) {
	        if (isObjectsEquals(wallListRun[k].start, binder.data)) {
	          wallListRun[k].start.x = coords.x;
	          wallListRun[k].start.y = coords.y;
	        }
	        if (isObjectsEquals(wallListRun[k].end, binder.data)) {
	          wallListRun[k].end.x = coords.x;
	          wallListRun[k].end.y = coords.y;
	        }
	      }
	      binder.data = coords;
	      floorplanEditor.wallsComputing(WALLS, false); // UPDATE FALSE

	      for (var k in wallListObj) {
	        var wall = wallListObj[k].wall;
	        var objTarget = wallListObj[k].obj;
	        var angleWall = qSVG.angleDeg(wall.start.x, wall.start.y, wall.end.x, wall.end.y);
	        var limits = limitObj(wall.equations.base, 2 * wallListObj[k].distance, wallListObj[k].from); // COORDS OBJ AFTER ROTATION
	        var indexLimits = 0;
	        if (qSVG.btwn(limits[1].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[1].y, wall.start.y, wall.end.y)) indexLimits = 1;
	        // NEW COORDS OBJDATA[obj]
	        objTarget.x = limits[indexLimits].x;
	        objTarget.y = limits[indexLimits].y;
	        objTarget.angle = angleWall;
	        if (objTarget.angleSign == 1) objTarget.angle = angleWall + 180;

	        var limitBtwn = limitObj(wall.equations.base, objTarget.size, objTarget); // OBJ SIZE OK BTWN xy1/xy2

	        if (qSVG.btwn(limitBtwn[0].x, wall.start.x, wall.end.x) && qSVG.btwn(limitBtwn[0].y, wall.start.y, wall.end.y) && qSVG.btwn(limitBtwn[1].x, wall.start.x, wall.end.x) && qSVG.btwn(limitBtwn[1].y, wall.start.y, wall.end.y)) {
	          objTarget.limit = limitBtwn;
	          objTarget.update();
	        }
	        else {
	          objTarget.graph.remove();
	          //delete objTarget;
	          OBJDATA.splice(wall.indexObj, 1);
	          wallListObj.splice(k, 1);
	        }
	      }
	      // for (k in toClean)
	      document.querySelector('#extension-floorplanner-boxRoom').replaceChildren();
	      document.querySelector('#extension-floorplanner-boxSurface').replaceChildren();
	      Rooms = qSVG.polygonize(WALLS);
	      floorplanEditor.roomMaker(Rooms);
	    }

	    // WALL MOVING ----BINDER TYPE SEGMENT-------- FUNCTION FOR H,V and Calculate Vectorial Translation

	    if (binder.type == 'segment' && action == 1) {
	      rib();

	      if (equation2.A == 'v') { equation2.B = snap.x; }
	      else if (equation2.A == 'h') { equation2.B = snap.y; }
	      else { equation2.B = snap.y - (snap.x * equation2.A); }

	      var intersection1 = qSVG.intersectionOfEquations(equation1, equation2, "obj");
	      var intersection2 = qSVG.intersectionOfEquations(equation2, equation3, "obj");
	      var intersection3 = qSVG.intersectionOfEquations(equation1, equation3, "obj");

	      if (binder.wall.parent != null) {
	        if (isObjectsEquals(binder.wall.parent.end, binder.wall.start)) binder.wall.parent.end = intersection1;
	        else if (isObjectsEquals(binder.wall.parent.start, binder.wall.start)) binder.wall.parent.start = intersection1;
	        else binder.wall.parent.end = intersection1;
	      }

	      if (binder.wall.child != null) {
	        if (isObjectsEquals(binder.wall.child.start, binder.wall.end)) binder.wall.child.start = intersection2;
	        else if (isObjectsEquals(binder.wall.child.end, binder.wall.end)) binder.wall.child.end = intersection2;
	        else binder.wall.child.start = intersection2;
	      }

	      binder.wall.start = intersection1;
	      binder.wall.end = intersection2;
	      binder.graph.remove()
	      // binder.graph[0].children[0].setAttribute("x1",intersection1.x);
	      // binder.graph[0].children[0].setAttribute("x2",intersection2.x);
	      // binder.graph[0].children[0].setAttribute("y1",intersection1.y);
	      // binder.graph[0].children[0].setAttribute("y2",intersection2.y);
	      // binder.graph[0].children[1].setAttribute("cx",intersection1.x);
	      // binder.graph[0].children[1].setAttribute("cy",intersection1.y);
	      // binder.graph[0].children[2].setAttribute("cx",intersection2.x);
	      // binder.graph[0].children[2].setAttribute("cy",intersection2.y);

	      // THE EQ FOLLOWED BY eq (PARENT EQ1 --- CHILD EQ3)
	      if (equation1.follow != undefined) {
	        if (!qSVG.rayCasting(intersection1, equation1.backUp.coords)) { // IF OUT OF WALL FOLLOWED
	          var distanceFromStart = qSVG.gap(equation1.backUp.start, intersection1);
	          var distanceFromEnd = qSVG.gap(equation1.backUp.end, intersection1);
	          if (distanceFromStart > distanceFromEnd) { // NEAR FROM End
	            equation1.follow.end = intersection1;
	          }
	          else {
	            equation1.follow.start = intersection1;
	          }
	        }
	        else {
	          equation1.follow.end = equation1.backUp.end;
	          equation1.follow.start = equation1.backUp.start;
	        }
	      }
	      if (equation3.follow != undefined) {
	        if (!qSVG.rayCasting(intersection2, equation3.backUp.coords)) { // IF OUT OF WALL FOLLOWED
	          var distanceFromStart = qSVG.gap(equation3.backUp.start, intersection2);
	          var distanceFromEnd = qSVG.gap(equation3.backUp.end, intersection2);
	          if (distanceFromStart > distanceFromEnd) { // NEAR FROM End
	            equation3.follow.end = intersection2;
	          }
	          else {
	            equation3.follow.start = intersection2;
	          }
	        }
	        else {
	          equation3.follow.end = equation3.backUp.end;
	          equation3.follow.start = equation3.backUp.start;
	        }
	      }

	      // EQ FOLLOWERS WALL MOVING
	      for (var i = 0; i < equationFollowers.length; i++) {
	        var intersectionFollowers = qSVG.intersectionOfEquations(equationFollowers[i].eq, equation2, "obj");
	        if (qSVG.btwn(intersectionFollowers.x, binder.wall.start.x, binder.wall.end.x, 'round') && qSVG.btwn(intersectionFollowers.y, binder.wall.start.y, binder.wall.end.y, 'round')) {
	          var size = qSVG.measure(equationFollowers[i].wall.start, equationFollowers[i].wall.end);
	          if (equationFollowers[i].type == "start") {
	            equationFollowers[i].wall.start = intersectionFollowers;
	            if (size < 5) {
	              if (equationFollowers[i].wall.child == null) {
	                WALLS.splice(WALLS.indexOf(equationFollowers[i].wall), 1);
	                equationFollowers.splice(i, 1);
	              }
	            }
	          }
	          if (equationFollowers[i].type == "end") {
	            equationFollowers[i].wall.end = intersectionFollowers;
	            if (size < 5) {
	              if (equationFollowers[i].wall.parent == null) {
	                WALLS.splice(WALLS.indexOf(equationFollowers[i].wall), 1);
	                equationFollowers.splice(i, 1);
	              }
	            }
	          }
	        }
	      }
	      // WALL COMPUTING, BLOCK FAMILY OF BINDERWALL IF NULL (START OR END) !!!!!
	      floorplanEditor.wallsComputing(WALLS, "move");
	      Rooms = qSVG.polygonize(WALLS);

	      // OBJDATA(s) FOLLOW 90¬∞ EDGE SELECTED
	      for (var rp = 0; rp < equationsObj.length; rp++) {
	        var objTarget = equationsObj[rp].obj;
	        var intersectionObj = qSVG.intersectionOfEquations(equationsObj[rp].eq, equation2);
	        // NEW COORDS OBJDATA[o]
	        objTarget.x = intersectionObj[0];
	        objTarget.y = intersectionObj[1];
	        var limits = limitObj(equation2, objTarget.size, objTarget);
	        if (qSVG.btwn(limits[0].x, binder.wall.start.x, binder.wall.end.x) && qSVG.btwn(limits[0].y, binder.wall.start.y, binder.wall.end.y) && qSVG.btwn(limits[1].x, binder.wall.start.x, binder.wall.end.x) && qSVG.btwn(limits[1].y, binder.wall.start.y, binder.wall.end.y)) {
	          objTarget.limit = limits;
	          objTarget.update();
	        }
	      }
	      // DELETING ALL OBJECT "INWALL" OVERSIZED INTO ITS EDGE (EDGE BY EDGE CONTROL)
	      for (var k in WALLS) {
	        var objWall = floorplanEditor.objFromWall(WALLS[k]); // LIST OBJ ON EDGE
	        for (var ob in objWall) {
	          var objTarget = objWall[ob];
	          var eq = floorplanEditor.createEquationFromWall(WALLS[k]);
	          var limits = limitObj(eq, objTarget.size, objTarget);
	          if (!qSVG.btwn(limits[0].x, WALLS[k].start.x, WALLS[k].end.x) || !qSVG.btwn(limits[0].y, WALLS[k].start.y, WALLS[k].end.y) || !qSVG.btwn(limits[1].x, WALLS[k].start.x, WALLS[k].end.x) || !qSVG.btwn(limits[1].y, WALLS[k].start.y, WALLS[k].end.y)) {
	            objTarget.graph.remove();
	            //delete objTarget;
	            var indexObj = OBJDATA.indexOf(objTarget);
	            OBJDATA.splice(indexObj, 1);
	          }
	        }
	      }

	      equationsObj = []; // REINIT eqObj -> MAYBE ONE OR PLUS OF OBJDATA REMOVED !!!!
	      var objWall = floorplanEditor.objFromWall(binder.wall); // LIST OBJ ON EDGE
	      for (var ob = 0; ob < objWall.length; ob++) {
	        var objTarget = objWall[ob];
	        equationsObj.push({ obj: objTarget, wall: binder.wall, eq: qSVG.perpendicularEquation(equation2, objTarget.x, objTarget.y) });
	      }

	      document.querySelector('#extension-floorplanner-boxRoom').replaceChildren();
	      document.querySelector('#extension-floorplanner-boxSurface').replaceChildren();
	      floorplanEditor.roomMaker(Rooms);
	      document.querySelector('#extension-floorplanner-lin').style.cursor = 'pointer';
	    }

	    // **********************************************************************
	    // ----------------------  BOUNDING BOX ------------------------------
	    // **********************************************************************
	    // binder.obj.params.move ---> FOR MEASURE DONT MOVE
	    if (binder.type == 'boundingBox' && action == 1 && binder.obj.params.move) {
	      binder.x = snap.x;
	      binder.y = snap.y;
	      binder.obj.x = snap.x;
	      binder.obj.y = snap.y;
	      binder.obj.update();
	      binder.update();
	    }

	    // **********************************************************************
	    // OBJ MOVING
	    // **********************************************************************
	    if (binder.type == 'obj' && action == 1) {
	      if (wallSelect = floorplanEditor.nearWall(snap)) {
	        if (wallSelect.wall.type != 'separate') {
	          inWallRib(wallSelect.wall);

	          var objTarget = binder.obj;
	          var wall = wallSelect.wall;
	          var angleWall = qSVG.angleDeg(wall.start.x, wall.start.y, wall.end.x, wall.end.y);
	          var v1 = qSVG.vectorXY({ x: wall.start.x, y: wall.start.y }, { x: wall.end.x, y: wall.end.y });
	          var v2 = qSVG.vectorXY({ x: wall.end.x, y: wall.end.y }, snap);
	          var newAngle = qSVG.vectorDeter(v1, v2);
	          binder.angleSign = 0;
	          objTarget.angleSign = 0;
	          if (Math.sign(newAngle) == 1) {
	            angleWall += 180;
	            binder.angleSign = 1;
	            objTarget.angleSign = 1;
	          }
	          var limits = limitObj(wall.equations.base, binder.size, wallSelect);
	          if (qSVG.btwn(limits[0].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[0].y, wall.start.y, wall.end.y) && qSVG.btwn(limits[1].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[1].y, wall.start.y, wall.end.y)) {
	            binder.x = wallSelect.x;
	            binder.y = wallSelect.y;
	            binder.angle = angleWall;
	            binder.thick = wall.thick;
	            objTarget.x = wallSelect.x;
	            objTarget.y = wallSelect.y;
	            objTarget.angle = angleWall;
	            objTarget.thick = wall.thick;
	            objTarget.limit = limits;
	            binder.update();
	            objTarget.update();
	          }

	          if ((wallSelect.x == wall.start.x && wallSelect.y == wall.start.y) || (wallSelect.x == wall.end.x && wallSelect.y == wall.end.y)) {
	            if (qSVG.btwn(limits[0].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[0].y, wall.start.y, wall.end.y)) {
	              binder.x = limits[0].x;
	              binder.y = limits[0].y;
	              objTarget.x = limits[0].x;
	              objTarget.y = limits[0].y;
	              objTarget.limit = limits;
	            }
	            if (qSVG.btwn(limits[1].x, wall.start.x, wall.end.x) && qSVG.btwn(limits[1].y, wall.start.y, wall.end.y)) {
	              binder.x = limits[1].x;
	              binder.y = limits[1].y;
	              objTarget.x = limits[1].x;
	              objTarget.y = limits[1].y;
	              objTarget.limit = limits;
	            }
	            binder.angle = angleWall;
	            binder.thick = wall.thick;
	            objTarget.angle = angleWall;
	            objTarget.thick = wall.thick;
	            binder.update();
	            objTarget.update();
	          }
	        }
	      }
	    } // END OBJ MOVE
	    if (binder.type != 'obj' && binder.type != 'segment') rib();
	  }
	  // ENDBIND ACTION MOVE **************************************************************************

	  // ---DRAG VIEWBOX PANNING -------------------------------------------------------

	  if (mode == 'select_mode' && drag == 'on') {
	    snap = calcul_snap(event, grid_snap);
	    document.querySelector('#extension-floorplanner-lin').style.cursor = 'move';
	    distX = (snap.xMouse - pox) * factor;
	    distY = (snap.yMouse - poy) * factor;
	    // pox = event.pageX;
	    // poy = event.pageY;
	    zoom_maker('zoomdrag', distX, distY);
	  }
	} 
	
	
	// END MOUSEMOVE


















	// *****************************************************************************************************
	// *****************************************************************************************************
	// *****************************************************************************************************
	// ******************************        MOUSE DOWN            *****************************************
	// *****************************************************************************************************
	// *****************************************************************************************************
	// *****************************************************************************************************

	function _MOUSEDOWN(event) {
		console.warn("MOUSEDOWN");
	  event.preventDefault();
		hide_submenus();
	  // *******************************************************************
	  // **************************   DISTANCE MODE   **********************
	  // *******************************************************************
	  if (mode == 'distance_mode') {
	    if (action == 0) {
	      action = 1;
	      snap = calcul_snap(event, grid_snap);
	      pox = snap.x;
	      poy = snap.y;
	    }
	  }

	  // *******************************************************************
	  // *************************   LINE/WALL MODE   **********************
	  // *******************************************************************
	  if (mode == 'line_mode' || mode == 'partition_mode') {
			
			/*
			if(document.querySelector('#extension-floorplanner-room_mode.extension-floorplanner-btn-success') != null
				|| document.querySelector('#extension-floorplanner-line_mode.extension-floorplanner-btn-success') != null
				|| document.querySelector('#extension-floorplanner-partition_mode.extension-floorplanner-btn-success') != null
			){
				root_el.classList.add('extension-floorplanner-do-not-pulsate');
			}
			*/
			root_el.classList.add('extension-floorplanner-do-not-pulsate');
	    if (action == 0) {
				
	      snap = calcul_snap(event, grid_snap);
	      pox = snap.x;
	      poy = snap.y;
	      if (wallStartConstruc = floorplanEditor.nearWall(snap, 12)) { // TO SNAP SEGMENT TO FINALIZE X2Y2
	        pox = wallStartConstruc.x;
	        poy = wallStartConstruc.y;
	      }
	    }
	    else {
	      // FINALIZE LINE_++
	      construc = 1;
	    }
	    action = 1;
	  }
	  if (mode == 'edit_door_mode') { // ACTION 1 ACTIVATE EDITION OF THE DOOR
	    action = 1;
	    document.querySelector('#extension-floorplanner-lin').style.cursor = 'pointer';
	  }

	  // *******************************************************************
	  // **********************   SELECT MODE + BIND   *********************
	  // *******************************************************************
	  if (mode == 'select_mode') {
			root_el.classList.add('extension-floorplanner-do-not-pulsate');
			if (typeof (binder) != 'undefined'){
				if(typeof (binder.type) != 'undefined'){
					console.log("MOUSEDOWN: OK, binder is defined and has type: ", binder, binder.type);
				}
				else{
					console.log("MOUSEDOWN: binder is defined but has no type: ", binder);
				}
			}
			else{
				console.error("MOUSEDOWN: binder is undefined");
			}
			// the binder.type check shouldn't be here...
	    if (typeof (binder) != 'undefined' && typeof (binder.type) != 'undefined' && (binder.type == 'segment' || binder.type == 'node' || binder.type == 'obj' || binder.type == 'boundingBox')) {
	      mode = 'bind_mode';
				console.log("mouse down -> segment/node/obj/boundingbox -> select_mode switching to bind_mode");
				

	      if (binder.type == 'obj') {
	        action = 1;
	      }

	      if (binder.type == 'boundingBox') {
	        action = 1;
	      }

	      // INIT FOR HELP BINDER NODE MOVING H V (MOUSE DOWN)
	      if (binder.type == 'node') {
	        document.querySelector('#extension-floorplanner-boxScale').style.display='none'
	        var node = binder.data;
	        pox = node.x;
	        poy = node.y;
	        var nodeControl = { x: pox, y: poy };

	        // DETERMINATE DISTANCE OF OPPOSED NODE ON EDGE(s) PARENT(s) OF THIS NODE !!!! NODE 1 -- NODE 2 SYSTE% :-(
	        wallListObj = []; // SUPER VAR -- WARNING
	        var objWall;
	        wallListRun = [];
	        for (var ee = WALLS.length - 1; ee > -1; ee--) { // SEARCH MOST YOUNG WALL COORDS IN NODE BINDER
	          if (isObjectsEquals(WALLS[ee].start, nodeControl) || isObjectsEquals(WALLS[ee].end, nodeControl)) {
	            wallListRun.push(WALLS[ee]);
	            break;
	          }
	        }
					console.log("wallListRun: ", wallListRun);
					if(wallListRun.length){
		        if (wallListRun[0].child != null) {
		          if (isObjectsEquals(wallListRun[0].child.start, nodeControl) || isObjectsEquals(wallListRun[0].child.end, nodeControl)) wallListRun.push(wallListRun[0].child);
		        }
		        if (wallListRun[0].parent != null) {
		          if (isObjectsEquals(wallListRun[0].parent.start, nodeControl) || isObjectsEquals(wallListRun[0].parent.end, nodeControl)) wallListRun.push(wallListRun[0].parent);
		        }
					}
	        

	        for (var k in wallListRun) {
	          if (isObjectsEquals(wallListRun[k].start, nodeControl) || isObjectsEquals(wallListRun[k].end, nodeControl)) {
	            var nodeTarget = wallListRun[k].start;
	            if (isObjectsEquals(wallListRun[k].start, nodeControl)) {
	              nodeTarget = wallListRun[k].end;
	            }
	            objWall = floorplanEditor.objFromWall(wallListRun[k]); // LIST OBJ ON EDGE -- NOT INDEX !!!
	            wall = wallListRun[k];
	            for (var ob = 0; ob < objWall.length; ob++) {
	              var objTarget = objWall[ob];
	              var distance = qSVG.measure(objTarget, nodeTarget);
	              wallListObj.push({ wall: wall, from: nodeTarget, distance: distance, obj: objTarget, indexObj: ob });
	            }
	          }
	        }
	        magnetic = 0;
	        action = 1;
	      }
	      if (binder.type == 'segment') {

	        document.querySelector('#extension-floorplanner-boxScale').style.display='none'
	        var wall = binder.wall;
	        binder.before = binder.wall.start;
	        equation2 = floorplanEditor.createEquationFromWall(wall);
	        if (wall.parent != null) {
	          equation1 = floorplanEditor.createEquationFromWall(wall.parent);
	          var angle12 = qSVG.angleBetweenEquations(equation1.A, equation2.A);
	          if (angle12 < 20 || angle12 > 160) {
	            var found = true;
	            for (var k in WALLS) {
	              if (qSVG.rayCasting(wall.start, WALLS[k].coords) && !isObjectsEquals(WALLS[k], wall.parent) && !isObjectsEquals(WALLS[k], wall)) {
	                if (wall.parent.parent != null && isObjectsEquals(wall, wall.parent.parent)) wall.parent.parent = null;
	                if (wall.parent.child != null && isObjectsEquals(wall, wall.parent.child)) wall.parent.child = null;
	                wall.parent = null;
	                found = false;
	                break;
	              }
	            }
	            if (found) {
	              var newWall;
	              if (isObjectsEquals(wall.parent.end, wall.start, "1")) {
	                newWall = new floorplanEditor.wall(wall.parent.end, wall.start, "normal", wall.thick);
	                WALLS.push(newWall);
	                newWall.parent = wall.parent;
	                newWall.child = wall;
	                wall.parent.child = newWall;
	                wall.parent = newWall;
	                equation1 = qSVG.perpendicularEquation(equation2, wall.start.x, wall.start.y);
	              }
	              else if (isObjectsEquals(wall.parent.start, wall.start, "2")) {
	                newWall = new floorplanEditor.wall(wall.parent.start, wall.start, "normal", wall.thick);
	                WALLS.push(newWall);
	                newWall.parent = wall.parent;
	                newWall.child = wall;
	                wall.parent.parent = newWall;
	                wall.parent = newWall;
	                equation1 = qSVG.perpendicularEquation(equation2, wall.start.x, wall.start.y);
	              }
	              // CREATE NEW WALL
	            }
	          }
	        }
	        if (wall.parent == null) {
	          var foundEq = false;
	          for (var k in WALLS) {
	            if (qSVG.rayCasting(wall.start, WALLS[k].coords) && !isObjectsEquals(WALLS[k].coords, wall.coords)) {
	              var angleFollow = qSVG.angleBetweenEquations(WALLS[k].equations.base.A, equation2.A);
	              if (angleFollow < 20 || angleFollow > 160) break;
	              equation1 = floorplanEditor.createEquationFromWall(WALLS[k]);
	              equation1.follow = WALLS[k];
	              equation1.backUp = {
	                coords: WALLS[k].coords,
	                start: WALLS[k].start,
	                end: WALLS[k].end,
	                child: WALLS[k].child,
	                parent: WALLS[k].parent
	              };
	              foundEq = true;
	              break;
	            }
	          }
	          if (!foundEq) equation1 = qSVG.perpendicularEquation(equation2, wall.start.x, wall.start.y);
	        }

	        if (wall.child != null) {
	          equation3 = floorplanEditor.createEquationFromWall(wall.child);
	          var angle23 = qSVG.angleBetweenEquations(equation3.A, equation2.A);
	          if (angle23 < 20 || angle23 > 160) {
	            var found = true;
	            for (var k in WALLS) {
	              if (qSVG.rayCasting(wall.end, WALLS[k].coords) && !isObjectsEquals(WALLS[k], wall.child) && !isObjectsEquals(WALLS[k], wall)) {
	                if (wall.child.parent != null && isObjectsEquals(wall, wall.child.parent)) wall.child.parent = null;
	                if (wall.child.child != null && isObjectsEquals(wall, wall.child.child)) wall.child.child = null;
	                wall.child = null;
	                found = false;
	                break;
	              }
	            }
	            if (found) {
	              if (isObjectsEquals(wall.child.start, wall.end)) {
	                var newWall = new floorplanEditor.wall(wall.end, wall.child.start, "new", wall.thick);
	                WALLS.push(newWall);
	                newWall.parent = wall;
	                newWall.child = wall.child;
	                wall.child.parent = newWall;
	                wall.child = newWall;
	                equation3 = qSVG.perpendicularEquation(equation2, wall.end.x, wall.end.y);
	              }
	              else if (isObjectsEquals(wall.child.end, wall.end)) {
	                var newWall = new floorplanEditor.wall(wall.end, wall.child.end, "normal", wall.thick);
	                WALLS.push(newWall);
	                newWall.parent = wall;
	                newWall.child = wall.child;
	                wall.child.child = newWall;
	                wall.child = newWall;
	                equation3 = qSVG.perpendicularEquation(equation2, wall.end.x, wall.end.y);
	              }
	              // CREATE NEW WALL
	            }
	          }
	        }
	        if (wall.child == null) {
	          var foundEq = false;
	          for (var k in WALLS) {
	            if (qSVG.rayCasting(wall.end, WALLS[k].coords) && !isObjectsEquals(WALLS[k].coords, wall.coords, "4")) {
	              var angleFollow = qSVG.angleBetweenEquations(WALLS[k].equations.base.A, equation2.A);
	              if (angleFollow < 20 || angleFollow > 160) break;
	              equation3 = floorplanEditor.createEquationFromWall(WALLS[k]);
	              equation3.follow = WALLS[k];
	              equation3.backUp = {
	                coords: WALLS[k].coords,
	                start: WALLS[k].start,
	                end: WALLS[k].end,
	                child: WALLS[k].child,
	                parent: WALLS[k].parent
	              };
	              foundEq = true;
	              break;
	            }
	          }
	          if (!foundEq) equation3 = qSVG.perpendicularEquation(equation2, wall.end.x, wall.end.y);
	        }

	        equationFollowers = [];
	        for (var k in WALLS) {
	          if (WALLS[k].child == null && qSVG.rayCasting(WALLS[k].end, wall.coords) && !isObjectsEquals(wall, WALLS[k])) {
	            equationFollowers.push({
	              wall: WALLS[k],
	              eq: floorplanEditor.createEquationFromWall(WALLS[k]),
	              type: "end"
	            });
	          }
	          if (WALLS[k].parent == null && qSVG.rayCasting(WALLS[k].start, wall.coords) && !isObjectsEquals(wall, WALLS[k])) {
	            equationFollowers.push({
	              wall: WALLS[k],
	              eq: floorplanEditor.createEquationFromWall(WALLS[k]),
	              type: "start"
	            });
	          }
	        }

	        equationsObj = [];
	        var objWall = floorplanEditor.objFromWall(wall); // LIST OBJ ON EDGE
	        for (var ob = 0; ob < objWall.length; ob++) {
	          var objTarget = objWall[ob];
	          equationsObj.push({ obj: objTarget, wall: wall, eq: qSVG.perpendicularEquation(equation2, objTarget.x, objTarget.y) });
	        }
	        action = 1;
	      }
	    }

	    else {
				console.log("mousedown: assuming this is a start of a drag because binder did not exist or had no type");
	      action = 0;
	      drag = 'on';
	      snap = calcul_snap(event, grid_snap);
	      pox = snap.xMouse;
	      poy = snap.yMouse;
				document.getElementById('extension-floorplanner-tool-root').classList.add("extension-floorplanner-do-not-pulsate");
	    }
	  }
	}

	//******************************************************************************************************
	//*******************  *****  ******        ************************************************************
	//*******************  *****  ******  ****  ************************************************************
	//*******************  *****  ******  ****  ************************************************************
	//*******************  *****  ******        ************************************************************
	//*******************         ******  ******************************************************************
	//**********************************  ******************************************************************

	function _MOUSEUP(event) {
		console.warn("MOUSEUP");
	  if (showRib) document.querySelector('#extension-floorplanner-boxScale').style.display = 'block';
		if(drag == 'on'){
			console.log("MOUSEUP: END OF A DRAG");
		}
		
		if(document.querySelector('#extension-floorplanner-room_mode.extension-floorplanner-btn-success') == null
			&& document.querySelector('#extension-floorplanner-line_mode.extension-floorplanner-btn-success') == null
			&& document.querySelector('#extension-floorplanner-partition_mode.extension-floorplanner-btn-success') == null
			&& document.querySelector('#extension-floorplanner-distance_mode.extension-floorplanner-btn-success') == null
			
		){
			console.log("Allowing pulsate");
			root_el.classList.remove('extension-floorplanner-do-not-pulsate');
		}
		
	  
		
		drag = 'off';
	  cursor('default');
		
		if(document.body.classList.contains('developer')){
			document.getElementById('extension-floorplanner-title').innerText = mode;
		}
		
	  if (mode == 'select_mode') {
	    if (typeof (binder) != 'undefined') {
				console.log("mouseup, and binder still existed, which is not supposed to happen. calling byebinder");
	      //binder.remove();
	      //delete binder;
				bye_binder();
				//hideAllSize();
	      floorplanSave();
	    }
	  }

	  //**************************************************************************
	  //********************   TEXTE   MODE **************************************
	  //**************************************************************************
	  if (mode == 'text_mode') {
	    if (action == 0) {
	      action = 1;
	      text_modal_el.style.display='block';
	      mode == 'edit_text_mode';
	    }
	  }

	  //**************************************************************************
	  //**************        OBJECT   MODE **************************************
	  //**************************************************************************
	  if (mode == 'object_mode') {
		  console.log("mouse_up: in object_mode. this fixates an object?");
	    if(typeof binder.graph != 'undefined' && typeof binder.type != 'undefined'){
				
				if(binder.type != 'boundingBox'){
					console.warn("adding boundingbox to OBJDATA: ", binder);
					//OBJDATA.push(binder);
				}
				else{
					//console.error("almost added boundingbox to OBJDATA.  binder: ", binder);
				}
				if(typeof binder.class != 'undefined' && binder.class == 'measure'){
	    		console.log("not saving measurement");
				}
				else{
					OBJDATA.push(binder);
				}
				//console.log("object_mode: ", binder, binder.family, binder.class, binder.type);
	    }
			else{
				console.error("attempted to save an svg element to object list! ", binder);
			}
			
		  console.log("OBJDATA is now: ", OBJDATA);
			console.log("object_mode: OBJDATA[OBJDATA.length - 1].class: ", OBJDATA[OBJDATA.length - 1].class);
	    if(typeof binder.graph != 'undefined') binder.graph.remove();
	    var targetBox = 'boxcarpentry';
			if (OBJDATA[OBJDATA.length - 1].class == 'text') targetBox = 'boxText';
	    else if (OBJDATA[OBJDATA.length - 1].class == 'energy') targetBox = 'boxEnergy';
	    else if (OBJDATA[OBJDATA.length - 1].class == 'furniture') targetBox = 'boxFurniture';
			else if (OBJDATA[OBJDATA.length - 1].class == 'measure') targetBox = 'boxMeasure';
	    document.querySelector('g#extension-floorplanner-' + targetBox).append(OBJDATA[OBJDATA.length - 1].graph);
	    //delete binder;
		  bye_binder();
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Object added';
	    fonc_button('select_mode');
	    floorplanSave();
	  }

	  // *******************************************************************
	  // **************************   UP: DISTANCE MODE   ******************
	  // *******************************************************************
	  if (mode == 'distance_mode') {

	    if (action == 1) {
	      action = 0;
	      // MODIFY BBOX FOR BINDER ZONE (TXT)
	      var bbox = labelMeasure.getBoundingClientRect();
	      bbox.x = (bbox.x * factor) - (offset.left * factor) + originX_viewbox;
	      bbox.y = (bbox.y * factor) - (offset.top * factor) + originY_viewbox;
				console.log("distance_mode: bbox x&y: ", bbox.x, bbox.y);
				
				
	      bbox.origin = { x: bbox.x + (bbox.width / 2), y: bbox.y + (bbox.height / 2) };
				console.log("distance_mode: bbox: ", bbox);
	      binder.bbox = bbox;
	      binder.realBbox = [
	        { x: binder.bbox.x, y: binder.bbox.y }, { x: binder.bbox.x + binder.bbox.width, y: binder.bbox.y }, { x: binder.bbox.x + binder.bbox.width, y: binder.bbox.y + binder.bbox.height }, { x: binder.bbox.x, y: binder.bbox.y + binder.bbox.height }];
				console.log("distance_mode: new size&thick from: binder.bbox.width,binder.bbox.height: ", binder.bbox.width, binder.bbox.height);
				console.log("binder.realBbox: ", binder.realBbox);
				
				binder.size = binder.bbox.width;
	      binder.thick = binder.bbox.height;
	      binder.graph.append(labelMeasure);
				
	      //OBJDATA.push(binder);
				//OBJDATA.push(binder_clone);
				console.log("distance_mode: typeof binder.graph: ", typeof binder.graph, binder.graph, binder.graph.outerHTML);
				
	      if(typeof binder.graph != 'undefined'){
					console.error("distance_mode: APPENDING TO BOXMEASURE, IN THEORY");
					
					let path_copy = binder.graph.cloneNode(true);
					console.log("path_copy: ", path_copy);
					let newpath = document.createElementNS('http://www.w3.org/2000/svg',"path");  
					
					let measure_d = binder.graph.getAttribute("d");
					console.log("measure_d: ", measure_d);
					let path_html = binder.graph.outerHTML;
					console.log("path_html: ", path_html);
					document.querySelector('g#extension-floorplanner-boxMeasure').append(path_copy);
					//let binder_clone = binder.cloneNode(true);
					//document.querySelector('g#extension-floorplanner-boxMeasure').append(binder_clone.graph);
					
					//document.querySelector('g#extension-floorplanner-boxMeasure').append(OBJDATA[OBJDATA.length - 1].graph);
					//document.querySelector('g#extension-floorplanner-boxMeasure').append(OBJDATA[OBJDATA.length - 1].graph);
					//document.querySelector('g#extension-floorplanner-boxMeasure').append(binder.graph.outerHTML);
					
					
					
					binder.graph.remove();
					//OBJDATA.push(binder);
				}
				else{
					console.error("distance_mode: no binder.graph.  binder: ", binder);
				}
	      
				try{
					delete labelMeasure;
				}
				catch(e){
					console.error("distance_mode: could not delete labelMeasure: ", e);
				}
				
	      //delete binder;
				bye_binder();
	      //
	      cross.remove();
				try{
					delete cross;
					//delete labelMeasure;
				}
				catch(e){
					console.error("distance_mode: could not delete cross: ", e);
				}
	      //
	      document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Measurement added';
	      fonc_button('select_mode');
	      floorplanSave();
	    }
	  }

	  // *******************************************************************
	  // **************************   ROOM MODE   **************************
	  // *******************************************************************

	  if (mode == 'room_mode') {

	    if (typeof (binder) == "undefined") {
	      return false;
	    }

	    var area = binder.area / 3600;
		  binder.setAttribute('fill', 'none');
		  binder.setAttribute('stroke', '#ddf00a');
		  binder.setAttribute('stroke-width', 7);
	    document.querySelector('.extension-floorplanner-size').innerHTML = area.toFixed(2) + " m¬≤";
	    document.querySelector('#extension-floorplanner-roomIndex').value = binder.id;
	    if (typeof ROOM[binder.id] != 'undefined'  && typeof ROOM[binder.id].surface != 'undefined' && ROOM[binder.id].surface != '') document.querySelector('#extension-floorplanner-roomSurface').value = ROOM[binder.id].surface;
	    else document.querySelector('#extension-floorplanner-roomSurface').value = '';
	    document.querySelector('#extension-floorplanner-seeArea').checked = ROOM[binder.id].showSurface;
	    document.querySelector('#extension-floorplanner-roomBackground').value = ROOM[binder.id].color;
	    var roomName = ROOM[binder.id].name;
	    document.querySelector('#extension-floorplanner-roomLabel').value = roomName;
	    if (ROOM[binder.id].name != '') {
	      document.querySelector('#extension-floorplanner-roomName').innerHTML = roomName + ' <span class="extension-floorplanner-caret"></span>';
	    }
	    else {
	      document.querySelector('#extension-floorplanner-roomName').innerHTML = 'None <span class="extension-floorplanner-caret"></span>';
	    }

	    var actionToDo = ROOM[binder.id].action;
	    document.querySelector('#extension-floorplanner-' + actionToDo + 'Action').checked = true;
	    document.querySelector('#extension-floorplanner-panel').style.display='none';
	    document.querySelector('#extension-floorplanner-roomTools').style.display='block';
	    document.querySelector('#extension-floorplanner-lin').style.cursor = 'default';
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Select a room';

	    mode = 'edit_room_mode';
	    floorplanSave();
	  }

	  // *******************************************************************
	  // **************************   NODE MODE   **************************
	  // *******************************************************************

	  if (mode == 'node_mode') {
	    if (typeof (binder) != 'undefined') { // ALSO ON MOUSEUP WITH HAVE CIRCLEBINDER ON ADDPOINT
	      var newWall = new floorplanEditor.wall({ x: binder.data.x, y: binder.data.y }, binder.data.wall.end, "normal", binder.data.wall.thick);
	      WALLS.push(newWall);
	      binder.data.wall.end = { x: binder.data.x, y: binder.data.y };
	      //binder.remove();
	      //delete binder;
				bye_binder();
	      floorplanEditor.architect(WALLS);
	      floorplanSave();
	    }
	    fonc_button('select_mode');
	  }

	  // *******************************************************************  ***** ****      *******  ******  ******  *****
	  // **************************   OBJ MODE   ***************************  *   * *******     *****  ******  ******   **
	  // *******************************************************************  ***** ****       ******  ******  ******  ***

	  if (mode == 'door_mode') {
	    if (typeof (binder) == "undefined") {
	      document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Draw a wall first';
	      fonc_button('select_mode');
	      return false;
	    }
	    OBJDATA.push(binder);
	    if(typeof binder.graph != 'undefined') binder.graph.remove();
	    document.querySelector('#extension-floorplanner-boxcarpentry').append(OBJDATA[OBJDATA.length - 1].graph);
	    //delete binder;
			bye_binder();
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Element added';
	    fonc_button('select_mode');
	    floorplanSave();
	  }

	  // *******************************************************************
	  // ********************   LINE MODE MOUSE UP   ***********************
	  // *******************************************************************

	  if (mode == 'line_mode' || mode == 'partition_mode') {
		  // This shouldn't be here.. of maybe it should.
		  if(document.querySelector('#extension-floorplanner-linetemp')){
		  	document.querySelector('#extension-floorplanner-linetemp').remove(); // DEL LINE HELP CONSTRUC 0 45 90
		  }
			if(document.querySelector('#extension-floorplanner-room_mode.extension-floorplanner-btn-success') != null
				|| document.querySelector('#extension-floorplanner-line_mode.extension-floorplanner-btn-success') != null
				|| document.querySelector('#extension-floorplanner-partition_mode.extension-floorplanner-btn-success') != null
				|| document.querySelector('#extension-floorplanner-distance_mode.extension-floorplanner-btn-success') != null
			){
				console.log("forbidding pulsate because of wall/line mode");
				root_el.classList.add('extension-floorplanner-do-not-pulsate');
			}
		
		  
	    intersectionOff();

	    var sizeWall = qSVG.measure({ x: x, y: y }, { x: pox, y: poy });
	    sizeWall = sizeWall / meter;
	    if (document.querySelectorAll('#extension-floorplanner-line_construc').length && sizeWall > 0.3) {
	      var sizeWall = wallSize;
	      if (mode == 'partition_mode') sizeWall = partitionSize;
	      var wall = new floorplanEditor.wall({ x: pox, y: poy }, { x: x, y: y }, "normal", sizeWall);
	      WALLS.push(wall);
	      floorplanEditor.architect(WALLS);

	      if (document.getElementById("extension-floorplanner-multi").checked && !wallEndConstruc) {
	        cursor('validation');
	        action = 1;
	      }
	      else action = 0;
	      document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Wall added <span style=\'font-size:0.6em\'> ' + (qSVG.measure(
	        { x: pox, y: poy }, { x: x, y: y }) / 60).toFixed(2) + ' m</span>';
	      document.querySelector('#extension-floorplanner-line_construc').remove(); // DEL LINE CONSTRUC HELP TO VIEW NEW SEG PATH
	      lengthTemp.remove();
	      //delete lengthTemp;
	      construc = 0;
	      if (wallEndConstruc) action = 0;
	      //delete wallEndConstruc;
	      pox = x;
	      poy = y;
	      floorplanSave();
	    }
	    else {
	      action = 0;
	      construc = 0;
	      document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Select mode';
	      fonc_button('select_mode');
	      if (typeof (binder) != 'undefined') {
	        //binder.remove();
	        //delete binder;
					bye_binder();
	      }
	      snap = calcul_snap(event, grid_snap);
	      pox = snap.x;
	      poy = snap.y;
	    }
	  }
	  // **************************** END LINE MODE MOUSE UP **************************

	  //**************************************************************************************
	  //**********************      BIND MODE MOUSE UP    ************************************
	  //**************************************************************************************
 
	  if (mode == 'bind_mode') {
		  console.log("mouseup: in bind_mode");
	    action = 0;
	    construc = 0; // CONSTRUC 0 TO FREE BINDER GROUP NODE WALL MOVING
	    if (typeof (binder) != 'undefined') {
				console.log("mouseup: binder exists, switching from bind_mode to select mode");
	      fonc_button('select_mode');
				if (typeof binder.type == 'undefined') {
					console.error("mouseup: binder.type was undefined, which is unexpected");
				}
	      if (binder.type == 'node') {

	      } // END BINDER NODE

	      if (binder.type == 'segment') {

	        var found = false;
	        if (binder.wall.start == binder.before) {
	          found = true;
	        }

	        if (found) {
	          document.querySelector('#extension-floorplanner-panel').style.display='none'
	          var objWall = floorplanEditor.objFromWall(wallBind);
	          document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Modify a wall<br/><span style="font-size:0.7em;color:#de9b43">This wall can\'t become a separation (it contains doors or windows)</span>';
	          if (objWall.length > 0) document.querySelector('#extension-floorplanner-separate').style.display='none';
	          else if (binder.wall.type == 'separate') {
	            document.querySelector('#extension-floorplanner-separate').style.display='none';
	            document.querySelector('#extension-floorplanner-rangeThick').style.display='none';
	            document.querySelector('#extension-floorplanner-recombine').style.display='block';
	            document.querySelector('#extension-floorplanner-cutWall').style.display='none';
	            document.getElementById('extension-floorplanner-titleWallTools').textContent = "Modify the separation";
	          }
	          else {
	            document.querySelector('#extension-floorplanner-cutWall').style.display='block';
	            document.querySelector('#extension-floorplanner-separate').style.display='block';
	            document.querySelector('#extension-floorplanner-rangeThick').style.display='block';
	            document.querySelector('#extension-floorplanner-recombine').style.display='none';
	            document.getElementById('extension-floorplanner-titleWallTools').textContent = "Modify the wall";
	            document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Modify the wall';
	          }
	          document.querySelector('#extension-floorplanner-wallTools').style.display = 'block'
	          document.getElementById('extension-floorplanner-wallWidth').setAttribute('min', 1);
	          document.getElementById('extension-floorplanner-wallWidth').setAttribute('max', 50);
	          document.getElementById('extension-floorplanner-wallWidthScale').textContent = "1-50";
	          document.getElementById("extension-floorplanner-wallWidth").value = binder.wall.thick;
	          document.getElementById("extension-floorplanner-wallWidthVal").textContent = binder.wall.thick;
	          mode = 'edit_wall_mode';
	        }
	        //delete equation1;
	        //delete equation2;
	        //delete equation3;
	        //delete intersectionFollowers;
	      }

	      if (binder.type == 'obj') {
					
	        var moveObj = Math.abs(binder.oldXY.x - binder.x) + Math.abs(binder.oldXY.y - binder.y);
	        if (moveObj < 1) {
						console.log("setting edit_door_mode");
				    document.querySelector('#extension-floorplanner-panel').style.display='none';
				    document.querySelector('#extension-floorplanner-objTools').style.display='block';
	          document.querySelector('#extension-floorplanner-lin').style.cursor = 'default';
	          document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Configure the door/window';
	          //console.log('obj ??', obj);
	          document.getElementById('extension-floorplanner-doorWindowWidth').setAttribute('min', binder.obj.params.resizeLimit.width.min);
	          document.getElementById('extension-floorplanner-doorWindowWidth').setAttribute('max', binder.obj.params.resizeLimit.width.max);
	          //document.getElementById('extension-floorplanner-doorWindowWidthScale').textContent = binder.obj.params.resizeLimit.width.min + "-" + binder.obj.params.resizeLimit.width.max;
	          document.getElementById('extension-floorplanner-doorWindowWidthScale-min').textContent = binder.obj.params.resizeLimit.width.min;
						document.getElementById('extension-floorplanner-doorWindowWidthScale-max').textContent = binder.obj.params.resizeLimit.width.max;
						
						document.getElementById("extension-floorplanner-doorWindowWidth").value = binder.obj.size;
	          document.getElementById("extension-floorplanner-doorWindowWidthVal").textContent = binder.obj.size;
	          mode = 'edit_door_mode';
	        }
	        else {
						console.log("modify door failure because object has moved: ", moveObj);
	          mode = "select_mode";
	          action = 0;
	          if(typeof binder.graph != 'undefined') binder.graph.remove();
	          //delete binder;
						bye_binder();
	        }
	      }

	      if (typeof (binder) != 'undefined' && binder.type == 'boundingBox') {
	        var moveObj = Math.abs(binder.oldX - binder.x) + Math.abs(binder.oldY - binder.y);
	        var objTarget = binder.obj;
	        if (!objTarget.params.move) {
	          // TO REMOVE MEASURE ON PLAN
	          objTarget.graph.remove();
	          OBJDATA.splice(OBJDATA.indexOf(objTarget), 1);
	          document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Measurement deleted';
	        }
	        if (moveObj < 1 && objTarget.params.move) {
	          if (!objTarget.params.resize) document.querySelector('#extension-floorplanner-objBoundingBoxScale').style.display='none';
	          else document.querySelector('#extension-floorplanner-objBoundingBoxScale').style.display='block';
	          if (!objTarget.params.rotate) document.querySelector('#extension-floorplanner-objBoundingBoxRotation').style.display='none';
	          else document.querySelector('#extension-floorplanner-objBoundingBoxRotation').style.display='block';
	          document.querySelector('#extension-floorplanner-panel').style.display='none'
	          //console.log(objTarget.params.resizeLimit.width.min)
	          document.querySelector('#extension-floorplanner-objBoundingBox').style.display='block'
	          document.querySelector('#extension-floorplanner-lin').style.cursor ='default';
	          document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Modify the object';
	          //console.log(objTarget)
						if(objTarget.params.resizeLimit){
							console.log("object has resize limit: ", objTarget.params.resizeLimit);
							
		          document.getElementById('extension-floorplanner-bboxWidth').setAttribute('min', objTarget.params.resizeLimit.width.min);
		          document.getElementById('extension-floorplanner-bboxWidth').setAttribute('max', objTarget.params.resizeLimit.width.max);
		          //document.getElementById('extension-floorplanner-bboxWidthScale').textContent = objTarget.params.resizeLimit.width.min + "-" + objTarget.params.resizeLimit.height.max;
							document.getElementById('extension-floorplanner-bboxWidthScale-min').textContent = objTarget.params.resizeLimit.width.min;
		          document.getElementById('extension-floorplanner-bboxWidthScale-max').textContent = objTarget.params.resizeLimit.width.max;
							document.getElementById('extension-floorplanner-bboxHeight').setAttribute('min', objTarget.params.resizeLimit.height.min);
		          document.getElementById('extension-floorplanner-bboxHeight').setAttribute('max', objTarget.params.resizeLimit.height.max);
		          //document.getElementById('extension-floorplanner-bboxHeightScale').textContent = objTarget.params.resizeLimit.height.min + "-" + objTarget.params.resizeLimit.height.max;
							document.getElementById('extension-floorplanner-bboxHeightScale-min').textContent = objTarget.params.resizeLimit.height.min;
							document.getElementById('extension-floorplanner-bboxHeightScale-max').textContent = objTarget.params.resizeLimit.height.max;
						}
	          
	          document.querySelector('#extension-floorplanner-stepsCounter').style.display='none';
	          if (objTarget.class == 'stair') {
	            document.getElementById("extension-floorplanner-bboxStepsVal").textContent = objTarget.value;
	            document.querySelector('#extension-floorplanner-stepsCounter').style.display='block';
	          }
	          document.getElementById("extension-floorplanner-bboxWidth").value = objTarget.width * 100;
	          document.getElementById("extension-floorplanner-bboxWidthVal").textContent = objTarget.width * 100;
	          document.getElementById("extension-floorplanner-bboxHeight").value = objTarget.height * 100;
	          document.getElementById("extension-floorplanner-bboxHeightVal").textContent = objTarget.height * 100;
	          document.getElementById("extension-floorplanner-bboxRotation").value = objTarget.angle;
	          document.getElementById("extension-floorplanner-bboxRotationVal").textContent = objTarget.angle;
	          mode = 'edit_boundingBox_mode';
	        }
	        else {
	          mode = "select_mode";
	          action = 0;
	          if(typeof binder.graph != 'undefined') binder.graph.remove();
	          //delete binder;
						bye_binder();
	        }
	      }

	      if (mode == 'bind_mode') {
	        //binder.remove();
	        //delete binder;
					bye_binder();
	      }
	    } // END BIND IS DEFINED
	    floorplanSave();
	  } // END BIND MODE

	  if (mode != 'edit_room_mode') {
	    floorplanEditor.showScaleBox();
	    rib();
	  }
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	//
	//   FUNC
	//
	
	
	
	
	
	//init
	let WALLS = [];
	let OBJDATA = [];
	let ROOM = [];
	let HISTORY = [];
	let wallSize = 20;
	let partitionSize = 8;
	let drag = 'off';
	let action = 0;
	let magnetic = 0;
	let construc = 0;
	let Rcirclebinder = 8;
	let mode = 'select_mode';
	let modeOption;
	//console.log("linElement: ", linElement);
	
	let binder
	
	var rect = linElement.getBoundingClientRect(); // get the bounding rectangle

	//console.log( rect.width );
	//console.log( rect.height);
	
	let taille_w = rect.width; //linElement.getBBox().width;
	let taille_h = rect.height; //linElement.getBBox().height;
	let offset = getOffset(linElement);
	//console.error("taille_w: ", taille_w);
	//console.log("lin element offset.top: ", offset.top);
	let grid = 20;
	let showRib = true;
	let showArea = true;
	let meter = 60;
	let grid_snap = 'off';
	let colorbackground = "#ffffff";
	let colorline = "#fff";
	let colorroom = "#f0daaf";
	let colorWall = "#666";
	let pox = 0;
	let poy = 0;
	let segment = 0;
	let xpath = 0;
	let ypath = 0;
	let width_viewbox = taille_w;
	let height_viewbox = taille_h;
	let ratio_viewbox = height_viewbox / width_viewbox;
	let originX_viewbox = 0;
	let originY_viewbox = 0;
	let zoom = 9;
	let factor = 1;

	let sizeText = [];
	let showAllSizeStatus = 0;

	//console.error("in func.js. ratio_viewbox: ", ratio_viewbox);

	// **************************************************************************
	// *****************   LOAD / SAVE LOCALSTORAGE      ************************
	// **************************************************************************

	function initHistory(boot = false) {
		console.log("in initHistory. boot: ", boot);
		document.getElementById('extension-floorplanner-myModal').style.display = 'none';
		//clear_floorplan();
	  HISTORY.index = 0;
	  
		  if (!boot && localStorage.getItem('extension-floorplanner-history')) localStorage.removeItem('extension-floorplanner-history');
	    if (localStorage.getItem('extension-floorplanner-history') && boot === "recovery") {
				try{
					console.log("initHistory attempting recovery");
	        let historyTemp = JSON.parse(localStorage.getItem('extension-floorplanner-history'));
	        floorplanLoad(historyTemp.length - 1, "boot");
	        floorplanSave("boot");
				}
	      catch(e){
	      	console.error("could not parse history from localStorage: ", e);
					localStorage.removeItem('extension-floorplanner-history');
					clear_floorplan(true);
	      }
	    }
	    if (boot === "newSquare") {
	        if (localStorage.getItem('extension-floorplanner-history')) localStorage.removeItem('extension-floorplanner-history');
	        HISTORY.push({
	            "objData": [],
	            "wallData": [{
	                "thick": 20,
	                "start": { "x": 540, "y": 194 },
	                "end": { "x": 540, "y": 734 },
	                "type": "normal",
	                "parent": 3,
	                "child": 1,
	                "angle": 1.5707963267948966,
	                "equations": { "up": { "A": "v", "B": 550 }, "down": { "A": "v", "B": 530 }, "base": { "A": "v", "B": 540 } },
	                "coords": [{ "x": 550, "y": 204 }, { "x": 530, "y": 184 }, { "x": 530, "y": 744 }, { "x": 550, "y": 724 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 540, "y": 734 },
	                "end": { "x": 1080, "y": 734 },
	                "type": "normal",
	                "parent": 0,
	                "child": 2,
	                "angle": 0,
	                "equations": { "up": { "A": "h", "B": 724 }, "down": { "A": "h", "B": 744 }, "base": { "A": "h", "B": 734 } },
	                "coords": [{ "x": 550, "y": 724 }, { "x": 530, "y": 744 }, { "x": 1090, "y": 744 }, { "x": 1070, "y": 724 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 1080, "y": 734 },
	                "end": { "x": 1080, "y": 194 },
	                "type": "normal",
	                "parent": 1,
	                "child": 3,
	                "angle": -1.5707963267948966,
	                "equations": {
	                    "up": { "A": "v", "B": 1070 },
	                    "down": { "A": "v", "B": 1090 },
	                    "base": { "A": "v", "B": 1080 }
	                },
	                "coords": [{ "x": 1070, "y": 724 }, { "x": 1090, "y": 744 }, { "x": 1090, "y": 184 }, { "x": 1070, "y": 204 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 1080, "y": 194 },
	                "end": { "x": 540, "y": 194 },
	                "type": "normal",
	                "parent": 2,
	                "child": 0,
	                "angle": 3.141592653589793,
	                "equations": { "up": { "A": "h", "B": 204 }, "down": { "A": "h", "B": 184 }, "base": { "A": "h", "B": 194 } },
	                "coords": [{ "x": 1070, "y": 204 }, { "x": 1090, "y": 184 }, { "x": 530, "y": 184 }, { "x": 550, "y": 204 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }],
	            "roomData": [{
	                "coords": [{ "x": 540, "y": 734 }, { "x": 1080, "y": 734 }, { "x": 1080, "y": 194 }, {
	                    "x": 540,
	                    "y": 194
	                }, { "x": 540, "y": 734 }],
	                "coordsOutside": [{ "x": 1090, "y": 744 }, { "x": 1090, "y": 184 }, { "x": 530, "y": 184 }, {
	                    "x": 530,
	                    "y": 744
	                }, { "x": 1090, "y": 744 }],
	                "coordsInside": [{ "x": 1070, "y": 724 }, { "x": 1070, "y": 204 }, { "x": 550, "y": 204 }, {
	                    "x": 550,
	                    "y": 724
	                }, { "x": 1070, "y": 724 }],
	                "inside": [],
	                "way": ["0", "2", "3", "1", "0"],
	                "area": 270400,
	                "surface": "",
	                "name": "",
	                "color": "gradientWhite",
	                "showSurface": true,
	                "action": "add"
	            }]
	        });
	        HISTORY[0] = JSON.stringify(HISTORY[0]);
	        localStorage.setItem('extension-floorplanner-history', JSON.stringify(HISTORY));
	        floorplanLoad(0);
	        floorplanSave();
	    }
	    else if (boot === "newL") {
	        if (localStorage.getItem('extension-floorplanner-history')) localStorage.removeItem('extension-floorplanner-history');
	        HISTORY.push({
	            "objData": [],
	            "wallData": [{
	                "thick": 20,
	                "start": { "x": 447, "y": 458 },
	                "end": { "x": 447, "y": 744 },
	                "type": "normal",
	                "parent": 5,
	                "child": 1,
	                "angle": 1.5707963267948966,
	                "equations": { "up": { "A": "v", "B": 457 }, "down": { "A": "v", "B": 437 }, "base": { "A": "v", "B": 447 } },
	                "coords": [{ "x": 457, "y": 468 }, { "x": 437, "y": 448 }, { "x": 437, "y": 754 }, { "x": 457, "y": 734 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 447, "y": 744 },
	                "end": { "x": 1347, "y": 744 },
	                "type": "normal",
	                "parent": 0,
	                "child": 2,
	                "angle": 0,
	                "equations": { "up": { "A": "h", "B": 734 }, "down": { "A": "h", "B": 754 }, "base": { "A": "h", "B": 744 } },
	                "coords": [{ "x": 457, "y": 734 }, { "x": 437, "y": 754 }, { "x": 1357, "y": 754 }, { "x": 1337, "y": 734 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 1347, "y": 744 },
	                "end": { "x": 1347, "y": 144 },
	                "type": "normal",
	                "parent": 1,
	                "child": 3,
	                "angle": -1.5707963267948966,
	                "equations": {
	                    "up": { "A": "v", "B": 1337 },
	                    "down": { "A": "v", "B": 1357 },
	                    "base": { "A": "v", "B": 1347 }
	                },
	                "coords": [{ "x": 1337, "y": 734 }, { "x": 1357, "y": 754 }, { "x": 1357, "y": 134 }, { "x": 1337, "y": 154 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 1347, "y": 144 },
	                "end": { "x": 1020, "y": 144 },
	                "type": "normal",
	                "parent": 2,
	                "child": 4,
	                "angle": 3.141592653589793,
	                "equations": { "up": { "A": "h", "B": 154 }, "down": { "A": "h", "B": 134 }, "base": { "A": "h", "B": 144 } },
	                "coords": [{ "x": 1337, "y": 154 }, { "x": 1357, "y": 134 }, { "x": 1010, "y": 134 }, { "x": 1030, "y": 154 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 1020, "y": 144 },
	                "end": { "x": 1020, "y": 458 },
	                "type": "normal",
	                "parent": 3,
	                "child": 5,
	                "angle": 1.5707963267948966,
	                "equations": {
	                    "up": { "A": "v", "B": 1030 },
	                    "down": { "A": "v", "B": 1010 },
	                    "base": { "A": "v", "B": 1020 }
	                },
	                "coords": [{ "x": 1030, "y": 154 }, { "x": 1010, "y": 134 }, { "x": 1010, "y": 448 }, { "x": 1030, "y": 468 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }, {
	                "thick": 20,
	                "start": { "x": 1020, "y": 458 },
	                "end": { "x": 447, "y": 458 },
	                "type": "normal",
	                "parent": 4,
	                "child": 0,
	                "angle": 3.141592653589793,
	                "equations": { "up": { "A": "h", "B": 468 }, "down": { "A": "h", "B": 448 }, "base": { "A": "h", "B": 458 } },
	                "coords": [{ "x": 1030, "y": 468 }, { "x": 1010, "y": 448 }, { "x": 437, "y": 448 }, { "x": 457, "y": 468 }],
	                "graph": { "0": {}, "context": {}, "length": 1 }
	            }],
	            "roomData": [{
	                "coords": [{ "x": 447, "y": 744 }, { "x": 1347, "y": 744 }, { "x": 1347, "y": 144 }, {
	                    "x": 1020,
	                    "y": 144
	                }, { "x": 1020, "y": 458 }, { "x": 447, "y": 458 }, { "x": 447, "y": 744 }],
	                "coordsOutside": [{ "x": 1357, "y": 754 }, { "x": 1357, "y": 134 }, { "x": 1010, "y": 134 }, {
	                    "x": 1010,
	                    "y": 448
	                }, { "x": 437, "y": 448 }, { "x": 437, "y": 754 }, { "x": 1357, "y": 754 }],
	                "coordsInside": [{ "x": 1337, "y": 734 }, { "x": 1337, "y": 154 }, { "x": 1030, "y": 154 }, {
	                    "x": 1030,
	                    "y": 468
	                }, { "x": 457, "y": 468 }, { "x": 457, "y": 734 }, { "x": 1337, "y": 734 }],
	                "inside": [],
	                "way": ["0", "2", "3", "4", "5", "1", "0"],
	                "area": 330478,
	                "surface": "",
	                "name": "",
	                "color": "gradientWhite",
	                "showSurface": true,
	                "action": "add"
	            }]
	        });
	        HISTORY[0] = JSON.stringify(HISTORY[0]);
	        localStorage.setItem('extension-floorplanner-history', JSON.stringify(HISTORY));
	        floorplanLoad(0);
	        floorplanSave();
	    }
			else{
				/*
				WALLS = [];
				OBJDATA = [];
				ROOM = [];
				HISTORY = [];
				floorplanSave("boot");
				*/
			}
	}

	
	
	document.getElementById('extension-floorplanner-start-floorplanner-button').addEventListener("click", function () {
		start_floorplanner();
	});
	
	document.getElementById('extension-floorplanner-redo').addEventListener("click", function () {
		floorplanner_undo();
	});
	
	function floorplanner_undo(){
		console.log("in floorplanner undo. HISTORY.index ?<? HISTORY.length", HISTORY.index, HISTORY.length);
    if (HISTORY.index < HISTORY.length) {
        floorplanLoad(HISTORY.index);
        HISTORY.index++;
        document.querySelector('#extension-floorplanner-undo').classList.remove('extension-floorplanner-disabled');
        if (HISTORY.index === HISTORY.length) {
          document.querySelector('#extension-floorplanner-redo').classList.add('extension-floorplanner-disabled');
        }
    }
	}

	document.getElementById('extension-floorplanner-undo').addEventListener("click", function () {
		floorplanner_redo();
	});
	
	function floorplanner_redo(){
    if (HISTORY.index > 0) {
        document.querySelector('#extension-floorplanner-undo').classList.remove('extension-floorplanner-disabled');
        if (HISTORY.index - 1 > 0) {
            HISTORY.index--;
            floorplanLoad(HISTORY.index - 1);
            document.querySelector('#extension-floorplanner-redo').classList.remove('extension-floorplanner-disabled');
        }
    }
    if (HISTORY.index === 1) document.querySelector('#extension-floorplanner-undo').classList.add('extension-floorplanner-disabled');
	}

	function floorplanSave(boot = false) {
		console.log("\nin floorplanSave. boot: ", boot);
		console.log("WALLS: ", WALLS);
		console.log("OBJDATA: ", OBJDATA);
		console.log("ROOM: ", ROOM);
		console.log("HISTORY.length: ", HISTORY.length);
		if(!floorplanner_started){return}
		//console.log("HISTORY[HISTORY.length - 1]: ", HISTORY[HISTORY.length - 1]);
		//document.querySelector("g#extension-floorplanner-boxbind").replaceChildren();
		
		if(ROOM.length){
			root_el.classList.add('extension-floorplanner-has-room');
		}
		else{
			root_el.classList.remove('extension-floorplanner-has-room');
		}
		
		
    if (boot) localStorage.removeItem('extension-floorplanner-history');
    // FOR CYCLIC OBJ INTO LOCALSTORAGE !!!
    for (let k in WALLS) {
        if (WALLS[k].child != null) {
            WALLS[k].child = WALLS.indexOf(WALLS[k].child);
        }
        if (WALLS[k].parent != null) {
            WALLS[k].parent = WALLS.indexOf(WALLS[k].parent);
        }
    }
    if (JSON.stringify({ objData: OBJDATA, wallData: WALLS, roomData: ROOM }) === HISTORY[HISTORY.length - 1]) {
        for (let k in WALLS) {
            if (WALLS[k].child != null) {
                WALLS[k].child = WALLS[WALLS[k].child];
            }
            if (WALLS[k].parent != null) {
                WALLS[k].parent = WALLS[WALLS[k].parent];
            }
        }
				console.warn("not saving because no real change");
        return false;
    }

    if (HISTORY.index < HISTORY.length) {
        HISTORY.splice(HISTORY.index, (HISTORY.length - HISTORY.index));
        document.querySelector('#extension-floorplanner-redo').classList.add('extension-floorplanner-disabled');
    }
    HISTORY.push(JSON.stringify({ objData: OBJDATA, wallData: WALLS, roomData: ROOM }));
		//console.log("pushed HISTORY: ", HISTORY);
		
		if(HISTORY.length > 10){
			HISTORY = HISTORY.slice(-10);
		}
		
    localStorage.setItem('extension-floorplanner-history', JSON.stringify(HISTORY));
		//console.log("localstorage: ", localStorage.getItem('extension-floorplanner-history'));
    HISTORY.index++;
    if (HISTORY.index > 1) document.querySelector('#extension-floorplanner-undo').classList.remove('extension-floorplanner-disabled');
    for (let k in WALLS) {
        if (WALLS[k].child != null) {
            WALLS[k].child = WALLS[WALLS[k].child];
        }
        if (WALLS[k].parent != null) {
            WALLS[k].parent = WALLS[WALLS[k].parent];
        }
    }
		
		generate_object_list();
		if(!boot) unsaved = true;
    return true;
	}


	function floorplanLoad(index = HISTORY.index, boot = false) {
		if(!floorplanner_started){return}
	    if (HISTORY.length === 0 && !boot){
	    	console.error("floorplanLoad exited early. No history, and boot was false");
				return false;
	    };
	    for (let k in OBJDATA) {
	        OBJDATA[k].graph.remove();
	    }
	    OBJDATA = [];
	    let historyTemp = [];
			if(localStorage.getItem('extension-floorplanner-history') != null){
		    historyTemp = JSON.parse(localStorage.getItem('extension-floorplanner-history'));
		    historyTemp = JSON.parse(historyTemp[index]);
				
			  console.log("floorplanLoad: historyTemp: ", historyTemp);
				
		    for (let k in historyTemp.objData) {
						let load = true;
		        let OO = historyTemp.objData[k];
						console.log("RESTORING OBJECTS. OO:", OO);
						if(OO.class == 'measure'){
							console.warn("\n\nABOUT TO RESTORE MEASURE");
							//load = false;
						}
		        //if (OO.family === 'energy') OO.family = 'byObject';
		        let obj = new floorplanEditor.obj2D(OO.family, OO.class, OO.type, {
		            x: OO.x,
		            y: OO.y
		        }, OO.angle, OO.angleSign, OO.size, OO.hinge = 'normal', OO.thick, OO.value, load);// true indicates this is a load, so to ignore the params size and thickness
		        obj.limit = OO.limit;
						console.log("obj.limit? ", obj.limit);
		        OBJDATA.push(obj);
						
						if(obj.family == 'inWall'){
							document.querySelector('#extension-floorplanner-boxcarpentry').append(OBJDATA[OBJDATA.length - 1].graph);
						}
						else{
							//document.querySelector('#extension-floorplanner-boxEnergy').append(OBJDATA[OBJDATA.length - 1].graph);
					    var targetBox = 'boxcarpentry';
							if (OBJDATA[OBJDATA.length - 1].class == 'text') targetBox = 'boxText';
					    else if (OBJDATA[OBJDATA.length - 1].class == 'energy') targetBox = 'boxEnergy';
					    else if (OBJDATA[OBJDATA.length - 1].class == 'furniture') targetBox = 'boxFurniture';
							else if (OBJDATA[OBJDATA.length - 1].class == 'measure') targetBox = 'boxMeasure';
					    document.querySelector('g#extension-floorplanner-' + targetBox).append(OBJDATA[OBJDATA.length - 1].graph);
						}
						
		        
		        obj.update();
		    }
		    WALLS = historyTemp.wallData;
		    for (let k in WALLS) {
				console.log("recreating walls? WALLS[k]",WALLS[k]);
		        if (WALLS[k].child != null) {
		            WALLS[k].child = WALLS[WALLS[k].child];
		        }
		        if (WALLS[k].parent != null) {
		            WALLS[k].parent = WALLS[WALLS[k].parent];
		        }
		    }
		    ROOM = historyTemp.roomData;
		    floorplanEditor.architect(WALLS);
		    floorplanEditor.showScaleBox();
		    rib();
			}
		  
	}

	document.querySelectorAll('#extension-floorplanner-tool-root svg.extension-floorplanner-current-svg').forEach(function (element) {
		console.error("!!! SETTING VIEWBOX 1: ", originX_viewbox, originY_viewbox, width_viewbox, height_viewbox);
	  element.setAttribute('viewBox', originX_viewbox + ' ' + originY_viewbox + ' ' + width_viewbox + ' ' + height_viewbox);
	});

	// **************************************************************************
	// *****************   FUNCTIONS ON BUTTON click     ************************
	// **************************************************************************

	document.getElementById('extension-floorplanner-report_mode').addEventListener("click", function () {
	    if (typeof (globalArea) === "undefined") return false;
	    mode = "report_mode";
	    document.querySelector('#extension-floorplanner-panel').style.display='none';
	    document.querySelector('#extension-floorplanner-reportTools').style.display='block';
	    document.getElementById('extension-floorplanner-reportTotalSurface').innerHTML = "Total surface : <b>" + (globalArea / 3600).toFixed(1) + "</b> m¬≤";
	    document.querySelector('#extension-floorplanner-reportTotalSurface').style.display='block';
	    document.getElementById('extension-floorplanner-reportNumberSurface').innerHTML = "Number of rooms : <b>" + ROOM.length + "</b>";
	    document.querySelector('#extension-floorplanner-reportNumberSurface').style.display='block';
	    let number = 1;
	    let reportRoom = '<div class="row">\n';
	    for (let k in ROOM) {
	        let nameRoom = "Room n¬∞" + number;
	        if (ROOM[k].name != "") nameRoom = ROOM[k].name;
	        reportRoom += '<div class="col-md-6"><p>' + nameRoom + '</p></div>\n';
	        reportRoom += '<div class="col-md-6"><p>Surface : <b>' + ((ROOM[k].area) / 3600).toFixed(2) + '</b> m¬≤</p></div>\n';
	        number++;
	    }
	    reportRoom += '</div><hr/>\n';
	    reportRoom += '<div>\n';
	    let switchNumber = 0;
	    let plugNumber = 0;
	    let lampNumber = 0;
	    for (let k in OBJDATA) {
	        if (OBJDATA[k].class === 'energy') {
	            if (OBJDATA[k].type === 'switch' || OBJDATA[k].type === 'doubleSwitch' || OBJDATA[k].type === 'dimmer') switchNumber++;
	            if (OBJDATA[k].type === 'plug' || OBJDATA[k].type === 'plug20' || OBJDATA[k].type === 'plug32') plugNumber++;
	            if (OBJDATA[k].type === 'wallLight' || OBJDATA[k].type === 'roofLight') lampNumber++;
	        }
	    }
	    reportRoom += '<p>Switch number : ' + switchNumber + '</p>';
	    reportRoom += '<p>Electric outlet number : ' + plugNumber + '</p>';
	    reportRoom += '<p>Light point number : ' + lampNumber + '</p>';
	    reportRoom += '</div>';
	    reportRoom += '<div>\n';
	    reportRoom += '<h2>Energy distribution per room</h2>\n';
	    number = 1;
	    reportRoom += '<div class="row">\n';
	    reportRoom += '<div class="col-md-4"><p>Label</p></div>\n';
	    reportRoom += '<div class="col-md-2"><small>Swi.</small></div>\n';
	    reportRoom += '<div class="col-md-2"><small>Elec. out.</small></div>\n';
	    reportRoom += '<div class="col-md-2"><small>Light.</small></div>\n';
	    reportRoom += '<div class="col-md-2"><small>Watts Max</small></div>\n';
	    reportRoom += '</div>';

	    let roomEnergy = [];
	    for (let k in ROOM) {
	        reportRoom += '<div class="row">\n';
	        let nameRoom = "Room n¬∞" + number + " <small>(no name)</small>";
	        if (ROOM[k].name != "") nameRoom = ROOM[k].name;
	        reportRoom += '<div class="col-md-4"><p>' + nameRoom + '</p></div>\n';
	        switchNumber = 0;
	        plugNumber = 0;
	        let plug20 = 0;
	        let plug32 = 0;
	        lampNumber = 0;
	        let wattMax = 0;
	        let plug = false;
	        for (let i in OBJDATA) {
	            if (OBJDATA[i].class === 'energy') {
	                if (OBJDATA[i].type === 'switch' || OBJDATA[i].type === 'doubleSwitch' || OBJDATA[i].type === 'dimmer') {
	                    if (roomTarget = floorplanEditor.rayCastingRoom(OBJDATA[i])) {
	                        if (isObjectsEquals(ROOM[k], roomTarget)) switchNumber++;
	                    }
	                }
	                if (OBJDATA[i].type === 'plug' || OBJDATA[i].type === 'plug20' || OBJDATA[i].type === 'plug32') {
	                    if (roomTarget = floorplanEditor.rayCastingRoom(OBJDATA[i])) {
	                        if (isObjectsEquals(ROOM[k], roomTarget)) {
	                            plugNumber++;
	                            if (OBJDATA[i].type === 'plug' && !plug) {
	                                wattMax += 3520;
	                                plug = true;
	                            }
	                            if (OBJDATA[i].type === 'plug20') {
	                                wattMax += 4400;
	                                plug20++;
	                            }
	                            if (OBJDATA[i].type === 'plug32') {
	                                wattMax += 7040;
	                                plug32++;
	                            }
	                        }
	                    }
	                }
	                if (OBJDATA[i].type === 'wallLight' || OBJDATA[i].type === 'roofLight') {
	                    if (roomTarget = floorplanEditor.rayCastingRoom(OBJDATA[i])) {
	                        if (isObjectsEquals(ROOM[k], roomTarget)) {
	                            lampNumber++;
	                            wattMax += 100;
	                        }
	                    }
	                }
	            }
	        }
	        roomEnergy.push({
	            switch: switchNumber,
	            plug: plugNumber,
	            plug20: plug20,
	            plug32: plug32,
	            light: lampNumber
	        });
	        reportRoom += '<div class="col-md-2"><b>' + switchNumber + '</b></div>\n';
	        reportRoom += '<div class="col-md-2"><b>' + plugNumber + '</b></div>\n';
	        reportRoom += '<div class="col-md-2"><b>' + lampNumber + '</b></div>\n';
	        reportRoom += '<div class="col-md-2"><b>' + wattMax + '</b></div>\n';
	        number++;
	        reportRoom += '</div>';
	    }
	    reportRoom += '<hr/><h2>Standard details NF C 15-100</h2>\n';
	    number = 1;

	    for (let k in ROOM) {
	        reportRoom += '<div class="row">\n';
	        let nfc = true;
	        let nameRoom = "Room n¬∞" + number + " <small>(no name)</small>";
	        if (ROOM[k].name != "") nameRoom = ROOM[k].name;
	        reportRoom += '<div class="col-md-4"><p>' + nameRoom + '</p></div>\n';
	        if (ROOM[k].name === "") {
	            reportRoom +=
	                '<div class="col-md-8"><p><i class="fa fa-ban" aria-hidden="true" style="color:red"></i> The room has no label, Home Rough Editor cannot provide you with information.</p></div>\n';
	        } else {
	            if (ROOM[k].name === "Salon") {
	                for (let g in ROOM) {
	                    if (ROOM[g].name === "Salle √† manger") {
	                        roomEnergy[k].light += roomEnergy[g].light;
	                        roomEnergy[k].plug += roomEnergy[g].plug;
	                        roomEnergy[k].switch += roomEnergy[g].switch;
	                    }
	                }
	                reportRoom += '<div class="col-md-8">';
	                if (roomEnergy[k].light === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 controlled light point</b> <small>(actually ' +
	                        roomEnergy[k].light + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].plug < 5) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>5 power outlets</b> <small>(actually ' +
	                        roomEnergy[k].plug + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (nfc) reportRoom += '<i class="fa fa-check" aria-hidden="true" style="color:green"></i>';
	                reportRoom += '</div>';
	            }
	            if (ROOM[k].name === "Salle √† manger") {
	                reportRoom +=
	                    '<div class="col-md-8"><p><i class="fa fa-info" aria-hidden="true" style="color:blue"></i> This room is linked to the <b>living room / living room</b> according to the standard.</p></div>\n';
	            }
	            if (ROOM[k].name.substr(0, 7) === "Chambre") {
	                reportRoom += '<div class="col-md-8">';
	                if (roomEnergy[k].light === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 controlled light point</b> <small>(actually ' +
	                        roomEnergy[k].light + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].plug < 3) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>3 power outlets</b> <small>(actually ' +
	                        roomEnergy[k].plug + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (nfc) reportRoom += '<i class="fa fa-check" aria-hidden="true" style="color:green"></i>';
	                reportRoom += '</div>';
	            }
	            if (ROOM[k].name === "SdB") {
	                reportRoom += '<div class="col-md-8">';
	                if (roomEnergy[k].light === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 light point</b> <small>(actually ' +
	                        roomEnergy[k].light + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].plug < 2) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>2 power outlets</b> <small>(actually ' +
	                        roomEnergy[k].plug + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].switch === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 switch</b> <small>(actually ' +
	                        roomEnergy[k].switch + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (nfc) reportRoom += '<i class="fa fa-check" aria-hidden="true" style="color:green"></i>';
	                reportRoom += '</div>';
	            }
	            if (ROOM[k].name === "Couloir") {
	                reportRoom += '<div class="col-md-8">';
	                if (roomEnergy[k].light === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 controlled light point</b> <small>(actually ' +
	                        roomEnergy[k].light + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].plug < 1) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 power outlet</b> <small>(actually ' +
	                        roomEnergy[k].plug + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (nfc) reportRoom += '<i class="fa fa-check" aria-hidden="true" style="color:green"></i>';
	                reportRoom += '</div>';
	            }
	            if (ROOM[k].name === "Toilette") {
	                reportRoom += '<div class="col-md-8">';
	                if (roomEnergy[k].light === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 light point</b>. <small>(actually ' +
	                        roomEnergy[k].light + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (nfc) reportRoom += '<i class="fa fa-check" aria-hidden="true" style="color:green"></i>';
	                reportRoom += '</div>';
	            }
	            if (ROOM[k].name === "Cuisine") {
	                reportRoom += '<div class="col-md-8">';
	                if (roomEnergy[k].light === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 controlled light point</b> <small>(actually ' +
	                        roomEnergy[k].light + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].plug < 6) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>6 power outlets</b> <small>(actually ' +
	                        roomEnergy[k].plug + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].plug32 === 0) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>1 32A power outlet</b> <small>(actually ' +
	                        roomEnergy[k].plug32 + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (roomEnergy[k].plug20 < 2) {
	                    reportRoom +=
	                        '<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> This room must have at least <b>2 20A power outlets</b> <small>(actually ' +
	                        roomEnergy[k].plug20 + ')</small>.</p>\n';
	                    nfc = false;
	                }
	                if (nfc) reportRoom += '<i class="fa fa-check" aria-hidden="true" style="color:green"></i>';
	                reportRoom += '</div>';
	            }
	        }
	        number++;
	        reportRoom += '</div>';
	    }

	    document.getElementById('extension-floorplanner-reportRooms').innerHTML = reportRoom;
	    document.querySelector('#extension-floorplanner-reportRooms').style.display='block'
	});

	document.getElementById('extension-floorplanner-wallWidth').addEventListener("input", function (event) {
    let sliderValue = this.value;
		console.log("sliderValue before: ", sliderValue);
		
		if(sliderValue > 20 - rotation_snappyness && sliderValue < 20 + rotation_snappyness){
			console.log("snapping wall to 20");
			sliderValue = 20;
			document.getElementById('extension-floorplanner-wallWidth').value = sliderValue;
		}
		console.log("sliderValue after: ", sliderValue);
    binder.wall.thick = sliderValue;
    binder.wall.type = "normal";
    floorplanEditor.architect(WALLS);
    let objWall = floorplanEditor.objFromWall(binder.wall); // LIST OBJ ON EDGE
    for (let w = 0; w < objWall.length; w++) {
        objWall[w].thick = sliderValue;
        objWall[w].update();
    }
    rib();
    document.getElementById("extension-floorplanner-wallWidthVal").textContent = sliderValue;
	});

	document.getElementById("extension-floorplanner-bboxTrash").addEventListener("click", function () {
	    if(typeof binder.obj != 'undefined' && typeof binder.obj.graph != 'undefined') binder.obj.graph.remove();
	    if(typeof binder.graph != 'undefined') binder.graph.remove();
	    if(typeof binder.obj != 'undefined') OBJDATA.splice(OBJDATA.indexOf(binder.obj), 1);
	    document.querySelector('#extension-floorplanner-objBoundingBox').style.display = 'none';
	    document.querySelector('#extension-floorplanner-panel').style.display='block';
	    fonc_button('select_mode');
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Deleted object';
	    //delete binder;
			bye_binder();
	    rib();
	});

	document.getElementById("extension-floorplanner-bboxStepsAdd").addEventListener("click", function () {
	    let newValue = document.getElementById("extension-floorplanner-bboxStepsVal").textContent;
	    if (newValue < 15) {
	        newValue++;
	        binder.obj.value = newValue;
	        binder.obj.update();
	        document.getElementById("extension-floorplanner-bboxStepsVal").textContent = newValue;
	    }
	});

	document.getElementById("extension-floorplanner-bboxStepsMinus").addEventListener("click", function () {
	    let newValue = document.getElementById("extension-floorplanner-bboxStepsVal").textContent;
	    if (newValue > 2) {
	        newValue--;
	        binder.obj.value = newValue;
	        binder.obj.update();
	        document.getElementById("extension-floorplanner-bboxStepsVal").textContent = newValue;
	    }
	});

	document.getElementById('extension-floorplanner-bboxWidth').addEventListener("input", function () {
	    let sliderValue = this.value;
			
			if(typeof binder != 'undefined' && typeof binder.obj != 'undefined'){
		    let objTarget = binder.obj;
				//console.log("new width scale WAIT NO: ", sliderValue / 100);
		    objTarget.size = (sliderValue / 100) * meter;
				if(linked_scaling){
					objTarget.thick = (sliderValue / 100) * meter;
				}
				//objTarget.scale = {}
		    objTarget.update();
		    binder.size = (sliderValue / 100) * meter;
				if(linked_scaling){
					binder.thick = (sliderValue / 100) * meter;
				}
		    binder.update();
		    document.getElementById("extension-floorplanner-bboxWidthVal").textContent = sliderValue;
				if(linked_scaling){
					document.getElementById('extension-floorplanner-bboxHeight').value = sliderValue;
					document.getElementById("extension-floorplanner-bboxHeightVal").textContent = sliderValue;
				}
			}
			else{
				console.error("cannot scale object, no binder or binder.obj");
			}
	    
	});

	document.getElementById('extension-floorplanner-bboxHeight').addEventListener("input", function () {
	    let sliderValue = this.value;
	    let objTarget = binder.obj;
	    objTarget.thick = (sliderValue / 100) * meter;
	    objTarget.update();
	    binder.thick = (sliderValue / 100) * meter;
	    binder.update();
	    document.getElementById("extension-floorplanner-bboxHeightVal").textContent = sliderValue;
	});

	document.getElementById('extension-floorplanner-bboxRotation').addEventListener("input", function () {
	    let sliderValue = this.value;
			
			if(sliderValue > -rotation_snappyness && sliderValue < rotation_snappyness){
				sliderValue = 0;
				document.getElementById('extension-floorplanner-bboxRotationVal').textContent = sliderValue;
				document.getElementById('extension-floorplanner-bboxRotation').value = sliderValue;
			}
			else if(sliderValue > 90-rotation_snappyness && sliderValue < 90+rotation_snappyness){
				console.log("optimizing");
				sliderValue = 90;
				document.getElementById('extension-floorplanner-bboxRotationVal').textContent = sliderValue;
				document.getElementById('extension-floorplanner-bboxRotation').value = sliderValue;
			}
			else if(sliderValue < -90 + rotation_snappyness && sliderValue > -90 - rotation_snappyness){
				sliderValue = -90;
				document.getElementById('extension-floorplanner-bboxRotationVal').textContent = sliderValue;
				document.getElementById('extension-floorplanner-bboxRotation').value = sliderValue;
			}
			else if(sliderValue > 45-rotation_snappyness && sliderValue < 45+rotation_snappyness){
				console.log("optimizing");
				sliderValue = 45;
				document.getElementById('extension-floorplanner-bboxRotationVal').textContent = sliderValue;
				document.getElementById('extension-floorplanner-bboxRotation').value = sliderValue;
			}
			else if(sliderValue < -40+rotation_snappyness && sliderValue > -45-rotation_snappyness){
				console.log("optimizing");
				sliderValue = -45;
				document.getElementById('extension-floorplanner-bboxRotationVal').textContent = sliderValue;
				document.getElementById('extension-floorplanner-bboxRotation').value = sliderValue;
			}
			else if(sliderValue > 135-rotation_snappyness && sliderValue < 135+rotation_snappyness){
				console.log("optimizing");
				sliderValue = 135;
				document.getElementById('extension-floorplanner-bboxRotationVal').textContent = sliderValue;
				document.getElementById('extension-floorplanner-bboxRotation').value = sliderValue;
			}
			else if(sliderValue < -130+rotation_snappyness && sliderValue > -135-rotation_snappyness){
				console.log("optimizing");
				sliderValue = -135;
				document.getElementById('extension-floorplanner-bboxRotationVal').textContent = sliderValue;
				document.getElementById('extension-floorplanner-bboxRotation').value = sliderValue;
			}
			
			
	    let objTarget = binder.obj;
	    objTarget.angle = sliderValue;
	    objTarget.update();
	    binder.angle = sliderValue;
	    binder.update();
	    document.getElementById("extension-floorplanner-bboxRotationVal").textContent = sliderValue;
	});

	document.getElementById('extension-floorplanner-doorWindowWidth').addEventListener("input", function () {
	    let sliderValue = this.value;
	    let objTarget = binder.obj;
	    let wallBind = floorplanEditor.rayCastingWalls(objTarget, WALLS);
	    if (wallBind.length > 1) {
	        wallBind = wallBind[wallBind.length - 1];
	    }
	    let limits = limitObj(wallBind.equations.base, sliderValue, objTarget);
	    if (qSVG.btwn(limits[1].x, wallBind.start.x, wallBind.end.x) && qSVG.btwn(limits[1].y, wallBind.start.y, wallBind.end.y) &&
	        qSVG.btwn(limits[0].x, wallBind.start.x, wallBind.end.x) && qSVG.btwn(limits[0].y, wallBind.start.y, wallBind.end.y)) {
	        objTarget.size = sliderValue;
	        objTarget.limit = limits;
	        objTarget.update();
	        binder.size = sliderValue;
	        binder.limit = limits;
	        binder.update();
	        document.getElementById("extension-floorplanner-doorWindowWidthVal").textContent = sliderValue;
	    }
	    inWallRib(wallBind);
	});

	document.getElementById("extension-floorplanner-objToolsHinge").addEventListener("click", function () {
		console.log("hinge change. binder: ", binder);
		console.log("hinge change. binder.obj: ", binder.obj);
	    let objTarget = binder.obj;
	    let hingeStatus = objTarget.hinge; // normal - reverse
	    if (hingeStatus === 'normal') {
	        objTarget.hinge = 'reverse';
	    } else objTarget.hinge = 'normal';
	    objTarget.update();
	});



	document.getElementById('extension-floorplanner-text-size-slider').addEventListener("input", function () {
	    document.getElementById('extension-floorplanner-labelBox').style.fontSize = this.value + 'px';
	});

	// CANDLE TODO onclick klopt hier niet
	document.querySelector('#extension-floorplanner-save-text').addEventListener("click",function (e) {
		console.log("saving text");
		document.querySelector('#extension-floorplanner-textToLayer').style.display='none';
    fonc_button('select_mode');
    action = 0;
    let textToMake = document.getElementById('extension-floorplanner-labelBox').value; //textContent;
		
		console.log("new text: ", textToMake);
    if (textToMake != "" && textToMake != "Your text") {
				console.log("creating text binder")
        binder = new floorplanEditor.obj2D("free", "text", document.getElementById('extension-floorplanner-labelBox').style.color, snap, 0, 0, 0, "normal", 0, {
            text: textToMake,
            size: document.getElementById('extension-floorplanner-text-size-slider').value
        });
				console.log("binder with text before update: ", binder);
        binder.update();
				console.log("binder with text after update: ", binder);
        OBJDATA.push(binder);
        if(typeof binder.graph != 'undefined') binder.graph.remove();
        document.querySelector('#extension-floorplanner-boxText').append(OBJDATA[OBJDATA.length - 1].graph);
        OBJDATA[OBJDATA.length - 1].update();
        //delete binder;
				bye_binder();
        document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Added text';
        floorplanSave();
    } else {
			console.warn("no relevant text provided");
        document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Selection mode';
    }
    //document.getElementById('extension-floorplanner-labelBox').textContent = "Your text";
		document.getElementById('extension-floorplanner-labelBox').value == '';
    document.getElementById('extension-floorplanner-labelBox').style.color = "#333333";
    document.getElementById('extension-floorplanner-labelBox').style.fontSize = "15px";
    document.getElementById('extension-floorplanner-text-size-slider').value = 15;
	});


	// Cancel adding text
	document.querySelector('#extension-floorplanner-cancel-text').addEventListener("click",function (e) {
		console.log("cancelling text");
		document.querySelector('#extension-floorplanner-textToLayer').style.display='none';
    fonc_button('select_mode');
    action = 0;
    
    //document.getElementById('extension-floorplanner-labelBox').textContent = "Your text";
		document.getElementById('extension-floorplanner-labelBox').value == '';
    document.getElementById('extension-floorplanner-labelBox').style.color = "#333333";
    document.getElementById('extension-floorplanner-labelBox').style.fontSize = "15px";
    document.getElementById('extension-floorplanner-text-size-slider').value = 15;
	});




	if (!Array.prototype.includes) {
	    Object.defineProperty(Array.prototype, 'includes', {
	        value: function (searchElement, fromIndex) {
	            if (this === null) {
	                throw new TypeError('"this" is null or not defined');
	            }

	            let o = Object(this);
	            let len = o.length >>> 0;
	            if (len === 0) {
	                return false;
	            }
	            let n = fromIndex | 0;
	            let k = Math.max(n >= 0 ? n : len - Math.abs(n), 0);

	            while (k < len) {
	                if (o[k] === searchElement) {
	                    return true;
	                }
	                k++;
	            }
	            return false;
	        }
	    });
	}

	function isObjectsEquals(a, b, message = false) {
	    if (message) console.log("equals message: ", message);
	    let isOK = true;
	    for (let prop in a) {
	        if (a[prop] !== b[prop]) {
	            isOK = false;
	            break;
	        }
	    }
	    return isOK;
	};

	function throttle(callback, delay) {
	    let last;
	    let timer;
	    return function () {
	        let context = this;
	        let now = +new Date();
	        let args = arguments;
	        if (last && now < last + delay) {
	            // le d√©lai n'est pas √©coul√© on reset le timer
	            clearTimeout(timer);
	            timer = setTimeout(function () {
	                last = now;
	                callback.apply(context, args);
	            }, delay);
	        } else {
	            last = now;
	            callback.apply(context, args);
	        }
	    };
	}
	
	/*
	linElement.mousewheel(throttle(function (event) {
	    event.preventDefault();
	    if (event.deltaY > 0) {
	        zoom_maker('zoomin', 200);
	    } else {
	        zoom_maker('zoomout', 200);
	    }
	}, 100));
	*/
	zoom_maker('zoomout', 200);
	
	document.getElementById("extension-floorplanner-showRib").addEventListener("click", function () {
	    if (document.getElementById("extension-floorplanner-showRib").checked) {
	        document.querySelector('#extension-floorplanner-boxScale').style.display='block';
	        document.querySelector('#extension-floorplanner-boxRib').style.display='block';
					document.querySelector('#extension-floorplanner-boxArea').style.display='block';
					document.querySelector('#extension-floorplanner-boxMeasure').style.display='block';
					document.querySelector('#extension-floorplanner-areaValue').style.display='block';
	        showRib = true;
	    } else {
	        document.querySelector('#extension-floorplanner-boxScale').style.display = 'none';
	        document.querySelector('#extension-floorplanner-boxRib').style.display = 'none';
					document.querySelector('#extension-floorplanner-boxArea').style.display = 'none';
					document.querySelector('#extension-floorplanner-areaValue').style.display='none';
					document.querySelector('#extension-floorplanner-boxMeasure').style.display='none';
	        showRib = false;
	    }
	});

/*
	document.getElementById("extension-floorplanner-showArea").addEventListener("click", function () {
	    if (document.getElementById("extension-floorplanner-showArea").checked) {
	        document.querySelector('#extension-floorplanner-boxArea').style.display='block';
	    } else {
	        document.querySelector('#extension-floorplanner-boxArea').style.display = 'none';
	    }
	});
*/
	document.getElementById("extension-floorplanner-showLayerRoom").addEventListener("click", function () {
	    if (document.getElementById("extension-floorplanner-showLayerRoom").checked) {
	        document.querySelector('#extension-floorplanner-boxRoom').style.display='block';
	    } else {
	        document.querySelector('#extension-floorplanner-boxRoom').style.display = 'none';
	    }
	});

	document.getElementById("extension-floorplanner-showLayerEnergy").addEventListener("click", function () {
		console.log("toggling energy/furniture layer");
	    if (document.getElementById("extension-floorplanner-showLayerEnergy").checked) {
				console.log("showing furniture");
	      document.querySelector('#extension-floorplanner-boxEnergy').style.display='block';
					//document.querySelector('#extension-floorplanner-boxcarpentry').style.display='block';
	    } else {
			  console.log("hiding furniture");
	      document.querySelector('#extension-floorplanner-boxEnergy').style.display = 'none';
					//document.querySelector('#extension-floorplanner-boxcarpentry').style.display = 'none';
	    }
	});

	// document.getElementById("showLayerFurniture").addEventListener("click", function () {
	//   if (document.getElementById("showLayerFurniture").checked) {
	//     document.querySelector('#extension-floorplanner-boxFurniture').style.display='block';
	//   }
	//   else {
	//     document.querySelector('#extension-floorplanner-boxFurniture').style.display = 'none';
	//   }
	// });

	document.getElementById("extension-floorplanner-applySurface").addEventListener("click", function () {
		change_room_background();
	});
	
	
	function change_room_background(){
    document.querySelector('#extension-floorplanner-roomTools').style.display = 'none';
    document.querySelector('#extension-floorplanner-panel').style.display='block';
    //binder.remove();
    //delete binder;
		bye_binder();
    let id = document.querySelector('#extension-floorplanner-roomIndex').value;
		console.log("roomIndex: ", id);
    //COLOR
    let data = document.querySelector('#extension-floorplanner-roomBackground').value;
    ROOM[id].color = "extension-floorplanner-" + data;
    //ROOM NAME
    let roomName = document.querySelector('#extension-floorplanner-roomName').value;
    if (roomName === 'None') {
        roomName = '';
    }
    ROOM[id].name = roomName;
    //ROOM SURFACE
    let area = document.querySelector('#extension-floorplanner-roomSurface').value;
    ROOM[id].surface = area;
    //SHOW SURFACE
    let show = document.querySelector("#extension-floorplanner-seeArea").checked;
    ROOM[id].showSurface = show;
    //ACTION PARAM
    let action = document.querySelector('#extension-floorplanner-tool-root input[type=radio]:checked').value;
    ROOM[id].action = action;
    if (action === 'sub') {
        ROOM[id].color = 'hatch';
    }
    if (action != 'sub' && data === 'hatch') {
        ROOM[id].color = 'gradientNeutral';
    }
    document.querySelector('#extension-floorplanner-boxRoom').replaceChildren();
    document.querySelector('#extension-floorplanner-boxSurface').replaceChildren();
    floorplanEditor.roomMaker(Rooms);
    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Updated room';
    fonc_button('select_mode');
	}

	document.getElementById("extension-floorplanner-resetRoomTools").addEventListener("click", function () {
	    document.querySelector('#extension-floorplanner-roomTools').style.display = 'none';
	    document.querySelector('#extension-floorplanner-panel').style.display='block';
	    //binder.remove();
	    //delete binder;
			bye_binder();
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Updated room';
	    fonc_button('select_mode');

	});

	document.getElementById("extension-floorplanner-wallTrash").addEventListener("click", function () {
	    let wall = binder.wall;
	    for (let k in WALLS) {
	        if (isObjectsEquals(WALLS[k].child, wall)) WALLS[k].child = null;
	        if (isObjectsEquals(WALLS[k].parent, wall)) {
	            WALLS[k].parent = null;
	        }
	    }
	    WALLS.splice(WALLS.indexOf(wall), 1);
	    document.querySelector('#extension-floorplanner-wallTools').style.display = 'none';
	    wall.graph.remove();
	    binder.graph.remove();
	    floorplanEditor.architect(WALLS);
	    rib();
	    mode = "select_mode";
	    document.querySelector('#extension-floorplanner-panel').style.display='block';
	});

	let textEditorColorBtn = document.querySelectorAll('.extension-floorplanner-textEditorColor');
	for (let k = 0; k < textEditorColorBtn.length; k++) {
	    textEditorColorBtn[k].addEventListener('click', function () {
	        document.getElementById('extension-floorplanner-labelBox').style.color = this.style.color;
	    });
	}

	let zoomBtn = document.querySelectorAll('.extension-floorplanner-zoom');
	console.log("zoomBtn: ", zoomBtn);
	for (let k = 0; k < zoomBtn.length; k++) {
	    zoomBtn[k].addEventListener("click", function () {
	        let lens = this.getAttribute('data-zoom');
	        zoom_maker(lens, 200, 50);
	    })
	}

	let roomColorBtn = document.querySelectorAll(".extension-floorplanner-roomColor");
	for (let k = 0; k < roomColorBtn.length; k++) {
	    roomColorBtn[k].addEventListener("click", function (event) {
		    let data = event.target.getAttribute('data-type');
				console.log("clicked on roomcolor button. data: ", data);
				console.log("--document.querySelector('#extension-floorplanner-roomBackground'): ", document.querySelector('#extension-floorplanner-roomBackground'));
				console.log("--BINDER: ", binder);
		    document.querySelector('#extension-floorplanner-roomBackground').value = data;
		    binder.setAttribute('fill', 'url(#extension-floorplanner-' + data + ')');
			  change_room_background();
			});
	}

	let objTrashBtn = document.querySelectorAll(".extension-floorplanner-objTrash");
	for (let k = 0; k < objTrashBtn.length; k++) {
	    objTrashBtn[k].addEventListener("click", function () {
	        document.querySelector('#extension-floorplanner-objTools').style.display = 'none';
	        let obj = binder.obj;
	        obj.graph.remove();
	        OBJDATA.splice(OBJDATA.indexOf(obj), 1);
	        fonc_button('select_mode');
	        document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Selection mode';
	        document.querySelector('#extension-floorplanner-panel').style.display = 'block';
	        if(typeof binder.graph != 'undefined') binder.graph.remove();
	        //delete binder;
					bye_binder();
	        rib();
	        document.querySelector('#extension-floorplanner-panel').style.display = 'block';
	    });
	}

	let dropdownMenu = document.querySelectorAll(".extension-floorplanner-dropdown-menu li a");
	for (let k = 0; k < dropdownMenu.length; k++) {
	    dropdownMenu[k].addEventListener("click", function () {
	        let selText = this.textContent;
			// TODO: is parents van jquery?
	        document.querySelector(this).closest('.extension-floorplanner-btn-group').querySelector('.extension-floorplanner-dropdown-toggle').innerHTML = selText + ' <span class="caret"></span>';
	        if (selText != 'None') document.querySelector('#extension-floorplanner-roomName').value = selText;
	        else document.querySelector('#extension-floorplanner-roomName').value = '';
	    });
	}

	// TRY MATRIX CALC FOR BBOX REAL COORDS WITH TRAS + ROT.
	function matrixCalc(el, message = false) {
	    if (message) console.log("matrixCalc called by -> ", message);
	    let m = el.getCTM();
	    let bb = el.getBBox();
	    let tpts = [
	        matrixXY(m, bb.x, bb.y),
	        matrixXY(m, bb.x + bb.width, bb.y),
	        matrixXY(m, bb.x + bb.width, bb.y + bb.height),
	        matrixXY(m, bb.x, bb.y + bb.height)];
	    return tpts;
	}

	function matrixXY(m, x, y) {
	    return { x: x * m.a + y * m.c + m.e, y: x * m.b + y * m.d + m.f };
	}

	function realBboxShow(coords) {
	    for (let k in coords) {
	        debugPoint(coords[k]);
	    }
	}


	function limitObj(equation, size, coords, message = false) {
	    if (message) {
	        console.log("limitObj: message: ", message);
	    }
	    let Px = coords.x;
	    let Py = coords.y;
	    let Aq = equation.A;
	    let Bq = equation.B;
	    let pos1, pos2;
	    if (Aq === 'v') {
	        pos1 = { x: Px, y: Py - size / 2 };
	        pos2 = { x: Px, y: Py + size / 2 };
	    } else if (Aq === 'h') {
	        pos1 = { x: Px - size / 2, y: Py };
	        pos2 = { x: Px + size / 2, y: Py };
	    } else {
	        let A = 1 + Aq * Aq;
	        let B = (-2 * Px) + (2 * Aq * Bq) + (-2 * Py * Aq);
	        let C = (Px * Px) + (Bq * Bq) - (2 * Py * Bq) + (Py * Py) - (size * size) / 4; // -N
	        let Delta = (B * B) - (4 * A * C);
	        let posX1 = (-B - (Math.sqrt(Delta))) / (2 * A);
	        let posX2 = (-B + (Math.sqrt(Delta))) / (2 * A);
	        pos1 = { x: posX1, y: (Aq * posX1) + Bq };
	        pos2 = { x: posX2, y: (Aq * posX2) + Bq };
	    }
	    return [pos1, pos2];
	}

	function zoom_maker(lens, xmove, xview) {
			
		if(Math.abs(xmove) > 200 || Math.abs(xview) > 200){
			console.warn("zoom_maker: unlikely move speed");
			return
		}
		
		  console.log("in zoom_maker.  lens, xmove, xview: ", lens, xmove, xview);
	    if (lens === 'zoomout' && zoom > 1 && zoom < 17) {
	        zoom--;
	        width_viewbox += xmove;
	        let ratioWidthZoom = taille_w / width_viewbox;
	        height_viewbox = width_viewbox * ratio_viewbox;
	        myDiv = document.getElementById("extension-floorplanner-scaleVal");
	        myDiv.style.width = 60 * ratioWidthZoom + 'px';
	        originX_viewbox = originX_viewbox - (xmove / 2);
	        originY_viewbox = originY_viewbox - (xmove / 2 * ratio_viewbox);
	    }
	    if (lens === 'zoomin' && zoom < 14 && zoom > 0) {
	        zoom++;
	        let oldWidth = width_viewbox;
	        width_viewbox -= xmove;
	        let ratioWidthZoom = taille_w / width_viewbox;
	        height_viewbox = width_viewbox * ratio_viewbox;
	        myDiv = document.getElementById("extension-floorplanner-scaleVal");
	        myDiv.style.width = 60 * ratioWidthZoom + 'px';

	        originX_viewbox = originX_viewbox + (xmove / 2);
	        originY_viewbox = originY_viewbox + (xmove / 2 * ratio_viewbox);
	    }
	    factor = width_viewbox / taille_w;
			console.log("zoom factor: ", factor);
			if(factor < 0){
				console.log("factor was below 1, forcing zoomreset");
				factor = 1;
				lens = 'zoomreset';
			}
	    if (lens === 'zoomreset') {
				console.warn("zoomreset!");
        originX_viewbox = 0;
        originY_viewbox = 0;
        width_viewbox = taille_w;
        height_viewbox = taille_h;
        factor = 1;
				/*
				zoom = 9;
				let ratioWidthZoom = taille_w / width_viewbox;
        myDiv = document.getElementById("extension-floorplanner-scaleVal");
        myDiv.style.width = 60 * ratioWidthZoom + 'px';
				*/
	    }
	    if (lens === 'zoomright') {
	        originX_viewbox += xview;
	    }
	    if (lens === 'zoomleft') {
	        originX_viewbox -= xview;
	    }
	    if (lens === 'zoomtop') {
	        originY_viewbox -= xview;
	    }
	    if (lens === 'zoombottom') {
	        originY_viewbox += xview;
	    }
	    if (lens === 'zoomdrag') {
	        originX_viewbox -= xmove;
	        originY_viewbox -= xview;
	    }
	    document.querySelectorAll('#extension-floorplanner-tool-root svg.extension-floorplanner-current-svg').forEach(function (element) {
			  console.log("CHANGING VIEWBOX. element: ", element);
				//console.error("!!! SETTING VIEWBOX 2: ", originX_viewbox, originY_viewbox, width_viewbox,height_viewbox);
	      element.setAttribute('viewBox', originX_viewbox + ' ' + originY_viewbox + ' ' + width_viewbox + ' ' + height_viewbox);
	    });
	}

	tactile = false;

	function calcul_snap(event, state) {
		//console.log("calcul_snap:  event, state:",event, state);
		
    if (event.touches) {
        let touches = event.changedTouches;
        //console.log("calcul_snap touches");
        eX = touches[0].pageX;
        eY = touches[0].pageY;
        tactile = true;
    } else {
        eX = event.pageX;
        eY = event.pageY;
    }
    x_mouse = (eX * factor) - (offset.left * factor) + originX_viewbox;
    y_mouse = (eY * factor) - (offset.top * factor) + originY_viewbox;
		//console.log("calculsnap: x_mouse: ", x_mouse);
		//console.log("calculsnap: y_mouse: ", y_mouse);
		
    if (state === 'on') {
        x_grid = Math.round(x_mouse / grid) * grid;
        y_grid = Math.round(y_mouse / grid) * grid;
    }
    if (state === 'off') {
        x_grid = x_mouse;
        y_grid = y_mouse;
    }
    return {
        x: x_grid,
        y: y_grid,
        xMouse: x_mouse,
        yMouse: y_mouse
    };
	}

	minMoveGrid = function (mouse) {
	    return Math.abs(Math.abs(pox - mouse.x) + Math.abs(poy - mouse.y));
	}

	function intersectionOff() {
	    if (typeof (lineIntersectionP) != 'undefined') {
	        lineIntersectionP.remove();
					try{
						delete lineIntersectionP;
					}
					catch(e){console.error("cannot delete lineIntersectionP: ", e)}
	        //delete lineIntersectionP;
	    }
	}

	function intersection(snap, range = Infinity, except = ['']) {
	    // ORANGE LINES 90¬∞ NEAR SEGMENT
	    let bestEqPoint = {};
	    let equation = {};

	    bestEqPoint.distance = range;

	    if (typeof (lineIntersectionP) != 'undefined') {
	        lineIntersectionP.remove();
	        //delete lineIntersectionP;
	    }

	    lineIntersectionP = qSVG.create("boxbind", "path", { // ORANGE TEMP LINE FOR ANGLE 0 90 45 -+
	        d: "",
	        "stroke": "transparent",
	        "stroke-width": 0.5,
	        "stroke-opacity": "1",
	        fill: "none"
	    });

	    for (index = 0; index < WALLS.length; index++) {
	        if (except.indexOf(WALLS[index]) === -1) {
	            let x1 = WALLS[index].start.x;
	            let y1 = WALLS[index].start.y;
	            let x2 = WALLS[index].end.x;
	            let y2 = WALLS[index].end.y;

	            // EQUATION 90¬∞ of segment nf/nf-1 at X2/Y2 Point
	            if (Math.abs(y2 - y1) === 0) {
	                equation.C = 'v'; // C/D equation 90¬∞ Coef = -1/E
	                equation.D = x1;
	                equation.E = 'h'; // E/F equation Segment
	                equation.F = y1;
	                equation.G = 'v'; // G/H equation 90¬∞ Coef = -1/E
	                equation.H = x2;
	                equation.I = 'h'; // I/J equation Segment
	                equation.J = y2;
	            } else if (Math.abs(x2 - x1) === 0) {
	                equation.C = 'h'; // C/D equation 90¬∞ Coef = -1/E
	                equation.D = y1;
	                equation.E = 'v'; // E/F equation Segment
	                equation.F = x1;
	                equation.G = 'h'; // G/H equation 90¬∞ Coef = -1/E
	                equation.H = y2;
	                equation.I = 'v'; // I/J equation Segment
	                equation.J = x2;
	            } else {
	                equation.C = (x1 - x2) / (y2 - y1);
	                equation.D = y1 - (x1 * equation.C);
	                equation.E = (y2 - y1) / (x2 - x1);
	                equation.F = y1 - (x1 * equation.E);
	                equation.G = (x1 - x2) / (y2 - y1);
	                equation.H = y2 - (x2 * equation.C);
	                equation.I = (y2 - y1) / (x2 - x1);
	                equation.J = y2 - (x2 * equation.E);
	            }
	            equation.A = equation.C;
	            equation.B = equation.D;
	            eq = qSVG.nearPointOnEquation(equation, snap);
	            if (eq.distance < bestEqPoint.distance) {
	                setBestEqPoint(bestEqPoint, eq.distance, index, eq.x, eq.y, x1, y1, x2, y2, 1);
	            }
	            equation.A = equation.E;
	            equation.B = equation.F;
	            eq = qSVG.nearPointOnEquation(equation, snap);
	            if (eq.distance < bestEqPoint.distance) {
	                setBestEqPoint(bestEqPoint, eq.distance, index, eq.x, eq.y, x1, y1, x2, y2, 1);
	            }
	            equation.A = equation.G;
	            equation.B = equation.H;
	            eq = qSVG.nearPointOnEquation(equation, snap);
	            if (eq.distance < bestEqPoint.distance) {
	                setBestEqPoint(bestEqPoint, eq.distance, index, eq.x, eq.y, x1, y1, x2, y2, 2);
	            }
	            equation.A = equation.I;
	            equation.B = equation.J;
	            eq = qSVG.nearPointOnEquation(equation, snap);
	            if (eq.distance < bestEqPoint.distance) {
	                setBestEqPoint(bestEqPoint, eq.distance, index, eq.x, eq.y, x1, y1, x2, y2, 2);
	            }
	        } // END INDEXOF EXCEPT TEST
	    } // END LOOP FOR

	    if (bestEqPoint.distance < range) {
	        if (bestEqPoint.way === 2) {
				lineIntersectionP.setAttribute("d","M" + bestEqPoint.x1 + "," + bestEqPoint.y1 + " L" + bestEqPoint.x2 + "," + bestEqPoint.y2 + " L" + bestEqPoint.x + "," + bestEqPoint.y);
	            lineIntersectionP.setAttribute("stroke","#d7ac57");
	        } else {
				// ORANGE TEMP LINE FOR ANGLE 0 90 45 -+
				lineIntersectionP.setAttribute("d","M" + bestEqPoint.x2 + "," + bestEqPoint.y2 + " L" + bestEqPoint.x1 + "," + bestEqPoint.y1 + " L" + bestEqPoint.x + "," + bestEqPoint.y);
	            lineIntersectionP.setAttribute("stroke","#d7ac57");
	        }
	        return ({
	            x: bestEqPoint.x,
	            y: bestEqPoint.y,
	            wall: WALLS[bestEqPoint.node],
	            distance: bestEqPoint.distance
	        });
	    } else {
	        return false;
	    }
	}

	function debugPoint(point, name, color = "#00ff00") {
		console.warn("in debugPoint. point, name, color: ", point, name, color);
	    qSVG.create('boxDebug', 'circle', {
	        cx: point.x,
	        cy: point.y,
	        r: 7,
	        fill: color,
	        id: name,
	        class: "extension-floorplanner-visu"
	    });
	}

	function showVertex() {
	    for (let i = 0; i < vertex.length; i++) {
	        debugPoint(vertex[i], i);

	    }
	}

	function showJunction() {
	    for (let i = 0; i < junction.length; i++) {
	        debugPoint({ x: junction[i].values[0], y: junction[i].values[1] }, i);

	    }
	}

	

	function hideAllSize() {
	    document.querySelector('#extension-floorplanner-boxbind').replaceChildren(); //.innerHTML = '';
	    sizeText = [];
	    showAllSizeStatus = 0;
	}

	function allRib() {
	    document.querySelector('#extension-floorplanner-boxRib').replaceChildren(); //.innerHTML = '';
	    for (let i in WALLS) {
	        inWallRib(WALLS[i], 'all');
	    }
	}

	function inWallRib(wall, option = false) {
		console.log("inWallRib:  wall, option:",wall, option);
	    if (!option) document.querySelector('#extension-floorplanner-boxRib').replaceChildren(); //.innerHTML = '';
	    ribMaster = [];
	    ribMaster.push([]);
	    ribMaster.push([]);
	    let inter;
	    let distance;
	    let cross;
	    let angleTextValue = wall.angle * (180 / Math.PI);
	    let objWall = floorplanEditor.objFromWall(wall); // LIST OBJ ON EDGE
	    if (objWall.length == 0) return
	    ribMaster[0].push({ wall: wall, crossObj: false, side: 'up', coords: wall.coords[0], distance: 0 });
	    ribMaster[1].push({ wall: wall, crossObj: false, side: 'down', coords: wall.coords[1], distance: 0 });
	    let objTarget = null
	    for (let ob in objWall) {
	        objTarget = objWall[ob];
	        objTarget.up = [
	            qSVG.nearPointOnEquation(wall.equations.up, objTarget.limit[0]),
	            qSVG.nearPointOnEquation(wall.equations.up, objTarget.limit[1])
	        ];
	        objTarget.down = [
	            qSVG.nearPointOnEquation(wall.equations.down, objTarget.limit[0]),
	            qSVG.nearPointOnEquation(wall.equations.down, objTarget.limit[1])
	        ];

	        distance = qSVG.measure(wall.coords[0], objTarget.up[0]) / meter;
	        ribMaster[0].push({
	            wall: objTarget,
	            crossObj: ob,
	            side: 'up',
	            coords: objTarget.up[0],
	            distance: distance.toFixed(2)
	        });
	        distance = qSVG.measure(wall.coords[0], objTarget.up[1]) / meter;
	        ribMaster[0].push({
	            wall: objTarget,
	            crossObj: ob,
	            side: 'up',
	            coords: objTarget.up[1],
	            distance: distance.toFixed(2)
	        });
	        distance = qSVG.measure(wall.coords[1], objTarget.down[0]) / meter;
	        ribMaster[1].push({
	            wall: objTarget,
	            crossObj: ob,
	            side: 'down',
	            coords: objTarget.down[0],
	            distance: distance.toFixed(2)
	        });
	        distance = qSVG.measure(wall.coords[1], objTarget.down[1]) / meter;
	        ribMaster[1].push({
	            wall: objTarget,
	            crossObj: ob,
	            side: 'down',
	            coords: objTarget.down[1],
	            distance: distance.toFixed(2)
	        });
	    }
	    distance = qSVG.measure(wall.coords[0], wall.coords[3]) / meter;
	    ribMaster[0].push({ wall: objTarget, crossObj: false, side: 'up', coords: wall.coords[3], distance: distance });
	    distance = qSVG.measure(wall.coords[1], wall.coords[2]) / meter;
	    ribMaster[1].push({ wall: objTarget, crossObj: false, side: 'down', coords: wall.coords[2], distance: distance });
	    ribMaster[0].sort(function (a, b) {
	        return (a.distance - b.distance).toFixed(2);
	    });
	    ribMaster[1].sort(function (a, b) {
	        return (a.distance - b.distance).toFixed(2);
	    });
	    for (let t in ribMaster) {
	        for (let n = 1; n < ribMaster[t].length; n++) {
	            let found = true;
	            let shift = -5;
	            let valueText = Math.abs(ribMaster[t][n - 1].distance - ribMaster[t][n].distance);
	            let angleText = angleTextValue;
	            if (found) {
	                if (ribMaster[t][n - 1].side === 'down') {
	                    shift = -shift + 10;
	                }
	                if (angleText > 89 || angleText < -89) {
	                    angleText -= 180;
	                    if (ribMaster[t][n - 1].side === 'down') {
	                        shift = -5;
	                    } else shift = -shift + 10;
	                }


	                sizeText[n] = document.createElementNS('http://www.w3.org/2000/svg', 'text');
	                let startText = qSVG.middle(ribMaster[t][n - 1].coords.x, ribMaster[t][n - 1].coords.y, ribMaster[t][n].coords.x,
	                    ribMaster[t][n].coords.y);
	                sizeText[n].setAttributeNS(null, 'x', startText.x);
	                sizeText[n].setAttributeNS(null, 'y', (startText.y) + shift);
	                sizeText[n].setAttributeNS(null, 'text-anchor', 'middle');
	                sizeText[n].setAttributeNS(null, 'font-family', 'sans-serif');
	                sizeText[n].setAttributeNS(null, 'stroke', '#ffffff');
	                sizeText[n].textContent = valueText.toFixed(2);
	                if (sizeText[n].textContent < 1) {
	                    sizeText[n].setAttributeNS(null, 'font-size', '0.8em');
	                    sizeText[n].textContent = sizeText[n].textContent.substring(1, sizeText[n].textContent.length);
	                } else sizeText[n].setAttributeNS(null, 'font-size', '1em');
	                sizeText[n].setAttributeNS(null, 'stroke-width', '0.27px');
	                sizeText[n].setAttributeNS(null, 'fill', '#666666');
	                sizeText[n].setAttribute("transform", "rotate(" + angleText + " " + startText.x + "," + (startText.y) + ")");

	                document.querySelector('#extension-floorplanner-boxRib').append(sizeText[n]);
	            }
	        }
	    }
	}

	function rib(shift = 5) {
		console.log("in rib. shift: ", shift);
	    // return false;
	    let ribMaster = [];
	    ribMaster.push([]);
	    ribMaster.push([]);
	    let inter;
	    let distance;
	    let cross;
	    for (let i in WALLS) {
	        if (WALLS[i].equations.base) {
	            ribMaster[0].push([]);
	            pushToRibMaster(ribMaster, 0, i, i, i, 'up', WALLS[i].coords[0], 0);
	            ribMaster[1].push([]);
	            pushToRibMaster(ribMaster, 1, i, i, i, 'down', WALLS[i].coords[1], 0);

	            for (let p in WALLS) {
	                if (i != p && WALLS[p].equations.base) {
	                    cross = qSVG.intersectionOfEquations(WALLS[i].equations.base, WALLS[p].equations.base, "object");
	                    if (qSVG.btwn(cross.x, WALLS[i].start.x, WALLS[i].end.x, 'round') &&
	                        qSVG.btwn(cross.y, WALLS[i].start.y, WALLS[i].end.y, 'round')) {

	                        inter = qSVG.intersectionOfEquations(WALLS[i].equations.up, WALLS[p].equations.up, "object");
	                        if (qSVG.btwn(inter.x, WALLS[i].coords[0].x, WALLS[i].coords[3].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[i].coords[0].y, WALLS[i].coords[3].y, 'round') &&
	                            qSVG.btwn(inter.x, WALLS[p].coords[0].x, WALLS[p].coords[3].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[p].coords[0].y, WALLS[p].coords[3].y, 'round')) {
	                            distance = qSVG.measure(WALLS[i].coords[0], inter) / meter;
	                            pushToRibMaster(ribMaster, 0, i, i, p, 'up', inter, distance.toFixed(2));

	                        }

	                        inter = qSVG.intersectionOfEquations(WALLS[i].equations.up, WALLS[p].equations.down, "object");
	                        if (qSVG.btwn(inter.x, WALLS[i].coords[0].x, WALLS[i].coords[3].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[i].coords[0].y, WALLS[i].coords[3].y, 'round') &&
	                            qSVG.btwn(inter.x, WALLS[p].coords[1].x, WALLS[p].coords[2].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[p].coords[1].y, WALLS[p].coords[2].y, 'round')) {
	                            distance = qSVG.measure(WALLS[i].coords[0], inter) / meter;
	                            pushToRibMaster(ribMaster, 0, i, i, p, 'up', inter, distance.toFixed(2));

	                        }

	                        inter = qSVG.intersectionOfEquations(WALLS[i].equations.down, WALLS[p].equations.up, "object");
	                        if (qSVG.btwn(inter.x, WALLS[i].coords[1].x, WALLS[i].coords[2].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[i].coords[1].y, WALLS[i].coords[2].y, 'round') &&
	                            qSVG.btwn(inter.x, WALLS[p].coords[0].x, WALLS[p].coords[3].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[p].coords[0].y, WALLS[p].coords[3].y, 'round')) {
	                            distance = qSVG.measure(WALLS[i].coords[1], inter) / meter;
	                            pushToRibMaster(ribMaster, 1, i, i, p, 'down', inter, distance.toFixed(2));

	                        }

	                        inter = qSVG.intersectionOfEquations(WALLS[i].equations.down, WALLS[p].equations.down, "object");
	                        if (qSVG.btwn(inter.x, WALLS[i].coords[1].x, WALLS[i].coords[2].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[i].coords[1].y, WALLS[i].coords[2].y, 'round') &&
	                            qSVG.btwn(inter.x, WALLS[p].coords[1].x, WALLS[p].coords[2].x, 'round') &&
	                            qSVG.btwn(inter.y, WALLS[p].coords[1].y, WALLS[p].coords[2].y, 'round')) {
	                            distance = qSVG.measure(WALLS[i].coords[1], inter) / meter;
	                            pushToRibMaster(ribMaster, 1, i, i, p, 'down', inter, distance.toFixed(2));

	                        }
	                    }
	                }
	            }
	            distance = qSVG.measure(WALLS[i].coords[0], WALLS[i].coords[3]) / meter;
	            pushToRibMaster(ribMaster, 0, i, i, i, 'up', WALLS[i].coords[3], distance.toFixed(2));

	            distance = qSVG.measure(WALLS[i].coords[1], WALLS[i].coords[2]) / meter;
	            pushToRibMaster(ribMaster, 1, i, i, i, 'down', WALLS[i].coords[2], distance.toFixed(2));
	        }
	    }

	    for (let a in ribMaster[0]) {
	        ribMaster[0][a].sort(function (a, b) {
	            return (a.distance - b.distance).toFixed(2);
	        });
	    }
	    for (let a in ribMaster[1]) {
	        ribMaster[1][a].sort(function (a, b) {
	            return (a.distance - b.distance).toFixed(2);
	        });
	    }

	    let sizeText = [];
	    if (shift === 5) document.querySelector('#extension-floorplanner-boxRib').replaceChildren(); //.innerHTML = '';
	    for (let t in ribMaster) {
	        for (let a in ribMaster[t]) {
	            for (let n = 1; n < ribMaster[t][a].length; n++) {
	                if (ribMaster[t][a][n - 1].wallIndex === ribMaster[t][a][n].wallIndex) {
	                    let edge = ribMaster[t][a][n].wallIndex;
	                    let found = true;
	                    let valueText = Math.abs(ribMaster[t][a][n - 1].distance - ribMaster[t][a][n].distance);
	                    // CLEAR TOO LITTLE VALUE
	                    if (valueText < 0.15) {
	                        found = false;
	                    }
	                    // CLEAR (thick) BETWEEN CROSS EDGE
	                    if (found && ribMaster[t][a][n - 1].crossEdge === ribMaster[t][a][n].crossEdge && ribMaster[t][a][n].crossEdge !=
	                        ribMaster[t][a][n].wallIndex) {
	                        found = false;
	                    }
	                    // CLEAR START INTO EDGE
	                    if (found && ribMaster[t][a].length > 2 && n === 1) {
	                        let polygon = [];
	                        for (let pp = 0; pp < 4; pp++) {
	                            polygon.push({
	                                x: WALLS[ribMaster[t][a][n].crossEdge].coords[pp].x,
	                                y: WALLS[ribMaster[t][a][n].crossEdge].coords[pp].y
	                            }); // FOR Z
	                        }
	                        if (qSVG.rayCasting(ribMaster[t][a][0].coords, polygon)) {
	                            found = false;
	                        }
	                    }
	                    // CLEAR END INTO EDGE
	                    if (found && ribMaster[t][a].length > 2 && n === ribMaster[t][a].length - 1) {
	                        let polygon = [];
	                        for (let pp = 0; pp < 4; pp++) {
	                            polygon.push({
	                                x: WALLS[ribMaster[t][a][n - 1].crossEdge].coords[pp].x,
	                                y: WALLS[ribMaster[t][a][n - 1].crossEdge].coords[pp].y
	                            }); // FOR Z
	                        }
	                        if (qSVG.rayCasting(ribMaster[t][a][ribMaster[t][a].length - 1].coords, polygon)) {
	                            found = false;
	                        }
	                    }

	                    if (found) {
	                        let angleText = WALLS[ribMaster[t][a][n].wallIndex].angle * (180 / Math.PI);
	                        let shiftValue = -shift;
	                        if (ribMaster[t][a][n - 1].side === 'down') {
	                            shiftValue = -shiftValue + 10;
	                        }
	                        if (angleText > 90 || angleText < -89) {
	                            angleText -= 180;
	                            if (ribMaster[t][a][n - 1].side === 'down') {
	                                shiftValue = -shift;
	                            } else shiftValue = -shiftValue + 10;
	                        }
	                        sizeText[n] = document.createElementNS('http://www.w3.org/2000/svg', 'text');
	                        let startText = qSVG.middle(ribMaster[t][a][n - 1].coords.x, ribMaster[t][a][n - 1].coords.y, ribMaster[t][a][n].coords.x,
	                            ribMaster[t][a][n].coords.y);
	                        sizeText[n].setAttributeNS(null, 'x', startText.x);
	                        sizeText[n].setAttributeNS(null, 'y', (startText.y) + (shiftValue));
	                        sizeText[n].setAttributeNS(null, 'text-anchor', 'middle');
	                        sizeText[n].setAttributeNS(null, 'font-family', 'sans-serif');
	                        sizeText[n].setAttributeNS(null, 'stroke', '#ffffff');
	                        sizeText[n].textContent = valueText.toFixed(2);
	                        if (sizeText[n].textContent < 1) {
	                            sizeText[n].setAttributeNS(null, 'font-size', '0.73em');
	                            sizeText[n].textContent = sizeText[n].textContent.substring(1, sizeText[n].textContent.length);
	                        } else sizeText[n].setAttributeNS(null, 'font-size', '0.9em');
	                        sizeText[n].setAttributeNS(null, 'stroke-width', '0.2px');
	                        sizeText[n].setAttributeNS(null, 'fill', '#555555');
	                        sizeText[n].setAttribute("transform", "rotate(" + angleText + " " + startText.x + "," + (startText.y) + ")");

	                        document.querySelector('#extension-floorplanner-boxRib').append(sizeText[n]);
	                    }
	                }
	            }
	        }
	    }
	}

	function cursor(tool) {
	    if (tool === 'grab') tool =
	        "url('img/add.png') 8 8, auto";
	    if (tool === 'scissor') tool = "url('img/scissors.svg'), auto";
	    if (tool === 'trash') tool = "url('img/cancel.png'), auto";
	    if (tool === 'validation') tool = "url('img/check.svg'), auto";
	    linElement.style.cursor = tool;
	}

	function fullscreen() {
	    // go full-screen
	    let i = document.body;
	    if (i.requestFullscreen) {
	        i.requestFullscreen();
	    } else if (i.webkitRequestFullscreen) {
	        i.webkitRequestFullscreen();
	    } else if (i.mozRequestFullScreen) {
	        i.mozRequestFullScreen();
	    } else if (i.msRequestFullscreen) {
	        i.msRequestFullscreen();
	    }
	}

	function outFullscreen() {
	    if (document.exitFullscreen) {
	        document.exitFullscreen();
	    } else if (document.mozCancelFullScreen) {
	        document.mozCancelFullScreen();
	    } else if (document.webkitExitFullscreen) {
	        document.webkitExitFullscreen();
	    }
	}

	document.addEventListener("fullscreenchange", function () {
	    if (
	        !document.fullscreenElement &&
	        !document.webkitFullscreenElement &&
	        !document.mozFullScreenElement &&
	        !document.msFullscreenElement) {
	        document.querySelector('#extension-floorplanner-nofull_mode').display = 'none';
	        document.querySelector('#extension-floorplanner-full_mode').style.display='block';
	    }
	});

	function raz_button() {
		if(document.querySelector('#extension-floorplanner-rect_mode')){
		    document.querySelector('#extension-floorplanner-rect_mode').classList.remove('extension-floorplanner-btn-success');
		    document.querySelector('#extension-floorplanner-rect_mode').classList.add('extension-floorplanner-btn-default');
		}
	    document.querySelector('#extension-floorplanner-select_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-select_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-line_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-line_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-partition_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-partition_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-door_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-door_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-node_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-node_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-text_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-text_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-room_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-room_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-distance_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-distance_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-object_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-object_mode').classList.add('extension-floorplanner-btn-default');
	    document.querySelector('#extension-floorplanner-stair_mode').classList.remove('extension-floorplanner-btn-success');
	    document.querySelector('#extension-floorplanner-stair_mode').classList.add('extension-floorplanner-btn-default');
	}

	function fonc_button(modesetting, option) {
		console.error("in fonc_button.  modesetting, option: ", modesetting, option);
		if(modesetting == 'door_mode'){
			//bye_binder();
		}
			//bye_binder();
	    floorplanSave();

	    hide_submenus();
	    raz_button();
	    if (option != 'simpleStair') {
	        document.querySelector('#extension-floorplanner-' + modesetting).classList.remove('extension-floorplanner-btn-default');
	        document.querySelector('#extension-floorplanner-' + modesetting).classList.add('extension-floorplanner-btn-success');
	    }
	    mode = modesetting;
	    modeOption = option;

			document.getElementById('extension-floorplanner-title').innerText = mode;

	    if (typeof (lineIntersectionP) != 'undefined') {
	        lineIntersectionP.remove();
	        //delete lineIntersectionP;
	    }
	}


	document.querySelector('#extension-floorplanner-distance_mode').addEventListener('click',function () {
		//document.querySelector('#extension-floorplanner-boxMeasure').replaceChildren();
	  linElement.style.cursor = 'crosshair';
	  document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Add a measurement';
	  fonc_button('distance_mode');
		setTimeout(()=>{
			root_el.classList.add('extension-floorplanner-do-not-pulsate');
		},100);
	});

	document.querySelector('#extension-floorplanner-room_mode').addEventListener('click',function () {
		console.log("clicked on room color button");
	  linElement.style.cursor = 'pointer';
	  document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Select a room';
	  fonc_button('room_mode');
		console.log("adding do-not-pulsate to root_el");
		setTimeout(()=>{
			root_el.classList.add('extension-floorplanner-do-not-pulsate');
		},100);
		
	});
	
	
	document.querySelector('#extension-floorplanner-roomTools').addEventListener('click',function () {
		document.getElementById('extension-floorplanner-tool-root').classList.remove("extension-floorplanner-do-not-pulsate");
	});
	

	document.querySelector('#extension-floorplanner-select_mode').addEventListener('click',function () {
    do_select_mode();
	});

	function do_select_mode(){
    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Select';
    if (typeof (binder) != 'undefined') {
				bye_binder();
    }
		hideAllSize(); // experiment
    fonc_button('select_mode');
	}

	document.querySelector('#extension-floorplanner-line_mode').addEventListener('click',function () {
		console.log("floorplanner: clicked on wall button");
		setTimeout(()=>{
			root_el.classList.add('extension-floorplanner-do-not-pulsate');
		},100);
	  
    linElement.style.cursor = 'crosshair';
    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Drag to create walls';
    multi = 0;
    action = 0;
    // snap = calcul_snap(event, grid_snap);
    //
    // pox = snap.x;
    // poy = snap.y;
    fonc_button('line_mode');
	});

	document.querySelector('#extension-floorplanner-partition_mode').addEventListener('click',function () {
	    linElement.style.cursor = 'crosshair';
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Creation of thin wall(s)';
	    multi = 0;
	    fonc_button('partition_mode');
			setTimeout(()=>{
				root_el.classList.add('extension-floorplanner-do-not-pulsate');
			},100);
	});

/*
	if(document.querySelector('#extension-floorplanner-rect_mode')){
		document.querySelector('#extension-floorplanner-rect_mode').addEventListener('click',function () {
		    linElement.style.cursor = 'crosshair';
		    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Room(s) creation';
		    fonc_button('rect_mode');
		});
	}
*/

	document.querySelectorAll('.extension-floorplanner-door').forEach(function (element) {
		element.addEventListener('click',function () {
	    	linElement.style.cursor = 'crosshair';
	    	document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Add a door';
	    	document.querySelector('#extension-floorplanner-door_list').style.display = 'none';
	    	fonc_button('door_mode', element.getAttribute('data-type'));
		});
	});

	document.querySelectorAll('.extension-floorplanner-window').forEach(function (element) {
		element.addEventListener('click',function () {
	    linElement.style.cursor = 'crosshair';
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Add a window';
	    document.querySelector('#extension-floorplanner-door_list').style.display = 'none';
	    document.querySelector('#extension-floorplanner-window_list').style.display = 'none';
	    fonc_button('door_mode', element.id.replace('extension-floorplanner-',''));
		});
	});

	document.querySelectorAll('.extension-floorplanner-object').forEach(function (element) {
		element.addEventListener('click',function () {
	    cursor('move');
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Add an object';
	    fonc_button('object_mode', element.id.replace('extension-floorplanner-',''));
	        //element.setAttribute('viewBox', originX_viewbox + ' ' + originY_viewbox + ' ' + width_viewbox + ' ' + height_viewbox);
		});
	});
/*
	document.querySelectorAll('.extension-floorplanner-object').forEach(function (element) {
	    cursor('move');
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Add an object';
	    fonc_button('object_mode', element.id.replace('extension-floorplanner-',''));
	        //element.setAttribute('viewBox', originX_viewbox + ' ' + originY_viewbox + ' ' + width_viewbox + ' ' + height_viewbox);
		//});
	});
*/
	document.querySelector('#extension-floorplanner-stair_mode').addEventListener('click',function () {
	    cursor('move');
	    document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Add staircase';
	    fonc_button('object_mode', 'simpleStair');
	});

	document.querySelector('#extension-floorplanner-node_mode').addEventListener('click',function () {
	    document.querySelector('#extension-floorplanner-boxinfo')
					.innerHTML = 'Add a joint to a wall<br/><span style=\"font-size:0.7em\">Note: this may delete rooms or doors already on that wall.</span>';
	    fonc_button('node_mode');
			setTimeout(()=>{
				root_el.classList.add('extension-floorplanner-do-not-pulsate');
			},100);
	});

	document.querySelector('#extension-floorplanner-text_mode').addEventListener('click',function () {
		document.getElementById('extension-floorplanner-labelBox').value = '';
		document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Add text<br/><span style=\"font-size:0.7em\">Place the cursor at the desired location</span>';
		fonc_button('text_mode');
	});

	if(document.querySelector('#extension-floorplanner-grid_mode')){
		document.querySelector('#extension-floorplanner-grid_mode').addEventListener('click',function () {
		    if (grid_snap === 'on') {
		        grid_snap = 'off';
		        document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Help grid off';
		        document.querySelector('#extension-floorplanner-grid_mode').classList.remove('extension-floorplanner-btn-success');
		        document.querySelector('#extension-floorplanner-grid_mode').classList.add('btn-warning');
		        document.querySelector('#extension-floorplanner-grid_mode').innerHTML = 'GRID OFF';
		        document.querySelector('#extension-floorplanner-boxgrid').style.opacity='0.5';
		    } else {
		        grid_snap = 'on';
		        document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Help grid on';
		        document.querySelector('#extension-floorplanner-grid_mode').classList.remove('btn-warning');
		        document.querySelector('#extension-floorplanner-grid_mode').classList.add('extension-floorplanner-btn-success');
		        document.querySelector('#extension-floorplanner-grid_mode').innerHTML = 'GRID ON';
		        document.querySelector('#extension-floorplanner-boxgrid').style.opacity='1';
		    }
		});
	}
	

	//  RETURN PATH(s) ARRAY FOR OBJECT + PROPERTY params => bindBox (false = open sideTool), move, resize, rotate
	// dividerObj is also known as value
	function carpentryCalc(classObj, typeObj, sizeObj, thickObj, dividerObj = 0) {
		  console.log("in carpentryCalc.  classObj, typeObj, sizeObj, thickObj, dividerObj: ", classObj, typeObj, sizeObj, thickObj, dividerObj);
	    let construc = [];
	    construc.params = {};
	    construc.params.bindBox = false;
	    construc.params.move = false;
	    construc.params.resize = false;
	    construc.params.resizeLimit = {};
	    construc.params.resizeLimit.width = { min: false, max: false };
	    construc.params.resizeLimit.height = { min: false, max: false };
	    construc.params.rotate = false;

	    if (classObj === 'socle') {
				console.warn("carpentrycalc: mysterious socle spotted.");
					
	        pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," +
	            thickObj / 2 + " L " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2) +
	            " Z", "#5cba79", "#5cba79", '');
				
	    }


	    if (classObj === 'doorWindow') {
	        if (typeObj === 'simple') {

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " L " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2) + " Z", "#ccc", "none",
	                '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," +
	                (-sizeObj - thickObj / 2) + "  A" + sizeObj + "," + sizeObj + " 0 0,1 " + sizeObj / 2 + "," + (-thickObj / 2), "none", colorWall,
	                '');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 40, max: 120 };
	        }
	        if (typeObj === 'double') {

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " L " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2) + " Z", "#ccc", "none",
	                '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," +
	                (-sizeObj / 2 - thickObj / 2) + "  A" + sizeObj / 2 + "," + sizeObj / 2 + " 0 0,1 0," + (-thickObj / 2), "none", colorWall,
	                '');

	            pushToConstruc(construc, "M " + (sizeObj / 2) + "," + (-thickObj / 2) + " L " + (sizeObj / 2) + "," +
	                (-sizeObj / 2 - thickObj / 2) + "  A" + sizeObj / 2 + "," + sizeObj / 2 + " 0 0,0 0," + (-thickObj / 2), "none", colorWall,
	                '');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 40, max: 160 };
	        }
	        if (typeObj === 'pocket') {
	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-(thickObj / 2) - 4) + " L " + (-sizeObj / 2) + "," +
	                thickObj / 2 + " L " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-(thickObj / 2) - 4) + " Z", "#ccc",
	                "none",
	                'none');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " M " + (sizeObj / 2) + "," + (thickObj / 2) + " L " + (sizeObj / 2) + "," + (-thickObj / 2), "none", "#494646",
	                '5 5');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," +
	                (-thickObj / 2 - 5) + " L " + (+sizeObj / 2) + "," + (-thickObj / 2 - 5) + " L " + (+sizeObj / 2) +
	                "," + (-thickObj / 2) + " Z", "url(#hatch)", "#494646", '');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 60, max: 200 };
	        }
	        if (typeObj === 'aperture') {
	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " L " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2) + " Z", "#ccc", "#494646",
	                '5,5');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-(thickObj / 2)) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " L " + ((-sizeObj / 2) + 5) + "," + thickObj / 2 + " L " + ((-sizeObj / 2) + 5) + "," + (-(thickObj / 2)) + " Z", "none",
	                "#494646",
	                'none');

	            pushToConstruc(construc, "M " + ((sizeObj / 2) - 5) + "," + (-(thickObj / 2)) + " L " + ((sizeObj / 2) - 5) + "," + thickObj / 2 +
	                " L " + (sizeObj / 2) + "," + thickObj / 2 + " L " + (sizeObj / 2) + "," + (-(thickObj / 2)) + " Z", "none", "#494646",
	                'none');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 40, max: 500 };
	        }
	        if (typeObj === 'fix') {
	            pushToConstruc(construc, "M " + (-sizeObj / 2) + ",-2 L " + (-sizeObj / 2) + ",2 L " +
	                sizeObj / 2 + ",2 L " + sizeObj / 2 + ",-2 Z", "#ccc", "none", '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " M " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2), "none", "#ccc", '');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 30, max: 300 };
	        }
	        if (typeObj === 'flap') {

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + ",-2 L " + (-sizeObj / 2) + ",2 L " +
	                sizeObj / 2 + ",2 L " + sizeObj / 2 + ",-2 Z", "#ccc", "none", '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " M " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2), "none", "#ccc", '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + ((-sizeObj / 2) +
	                ((sizeObj) * 0.866)) + "," + ((-sizeObj / 2) - (thickObj / 2)) + "  A" + sizeObj + "," +
	                sizeObj + " 0 0,1 " + sizeObj / 2 + "," + (-thickObj / 2), "none", colorWall, '');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 20, max: 100 };
	        }
	        if (typeObj === 'twin') {

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + ",-2 L " + (-sizeObj / 2) + ",2 L " + sizeObj / 2 +
	                ",2 L " + sizeObj / 2 + ",-2 Z", "#000", "none", '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " L " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2), "#fff", "#fff", '', 0.7);

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " M " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2), "none", "#000", '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + ((-sizeObj / 2) +
	                ((sizeObj / 2) * 0.866)) + "," + (-sizeObj / 4 - thickObj / 2) + "  A" +
	                sizeObj / 2 + "," + sizeObj / 2 + " 0 0,1 0," + (-thickObj / 2), "none", colorWall, '');

	            pushToConstruc(construc, "M " + (sizeObj / 2) + "," + (-thickObj / 2) + " L " + ((sizeObj / 2) +
	                ((-sizeObj / 2) * 0.866)) + "," + (-sizeObj / 4 - thickObj / 2) + "  A" +
	                sizeObj / 2 + "," + sizeObj / 2 + " 0 0,0 0," + (-thickObj / 2), "none", colorWall, '');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 40, max: 200 };
	        }
	        if (typeObj === 'bay') {

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 +
	                " M " + sizeObj / 2 + "," + thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2), "none", "#ccc", '');

	            pushToConstruc(construc, "M " + (-sizeObj / 2) + ",-2 L " + (-sizeObj / 2) + ",0 L 2,0 L 2,2 L 3,2 L 3,-2 Z", "#ccc", "none", '');

	            pushToConstruc(construc, "M -2,1 L -2,3 L " + sizeObj / 2 + ",3 L " + sizeObj / 2 + ",1 L -1,1 L -1,-1 L -2,-1 Z", "#ccc", "none", '');
	            construc.params.resize = true;
	            construc.params.resizeLimit.width = { min: 60, max: 300 };
	        }
	    }

	    if (classObj === 'measure') {
				  console.log("classObj = measure. sizeObj: ", sizeObj);
	        construc.params.bindBox = true;
					// 						construc, path, fill, stroke, strokeDashArray, opacity = 1
	        //pushToConstruc(construc, "M-" + (sizeObj / 2) + ",0 l10,-10 l0,8 l" + (sizeObj - 20) + ",0 l0,-8 l10,10 l-10,10 l0,-8 l-" + (sizeObj - 20) + ",0 l0,8 Z", "#729eeb", "none", '');
	        pushToConstruc(construc, "M-" + (sizeObj / 2) + ",0 l10,-10 l0,8 l" + (sizeObj) + ",0 l0,-8 l10,10 l-10,10 l0,-8 l-" + (sizeObj) + ",0 l0,8 Z", "#729eeb", "none", '4 1');
	    }

	    if (classObj === 'boundingBox') {
				console.log("classObj = boundingbox.  sizeObj,thickObj: ", sizeObj, thickObj);
	      /*
				pushToConstruc(construc,
	            "M" + (-sizeObj / 2 - bounding_padding) + "," + (-thickObj / 2 - bounding_padding) + " L" + (sizeObj / 2 + bounding_padding) + "," + (-thickObj / 2 - bounding_padding) + " L" +
	            (sizeObj / 2 + bounding_padding) + "," + (thickObj / 2 + bounding_padding) + " L" + (-sizeObj / 2 - bounding_padding) + "," + (thickObj / 2 + bounding_padding) + " Z", 'none',
	            "#aaa", '');
				*/
				pushToConstruc(construc,
          "M" + (-sizeObj / 2) + "," + (-thickObj / 2) + " L" + (sizeObj / 2) + "," + (-thickObj / 2) + " L" +
          (sizeObj / 2) + "," + (thickObj / 2) + " L" + (-sizeObj / 2) + "," + (thickObj / 2) + " Z", 'none',
          "#aaa", '');
				
	        // construc.push({'path':"M"+dividerObj[0].x+","+dividerObj[0].y+" L"+dividerObj[1].x+","+dividerObj[1].y+" L"+dividerObj[2].x+",
	        // "+dividerObj[2].y+" L"+dividerObj[3].x+","+dividerObj[3].y+" Z", 'fill':'none', 'stroke':"#000", 'strokeDashArray': ''});
	    }

	    //typeObj = color  dividerObj = text
	    if (classObj === 'text' && typeof dividerObj == 'object') {
				  console.log("recalc: TEXT dividerObj.size: ", dividerObj.size);
	        construc.params.bindBox = true;
	        construc.params.move = true;
					construc.params.resize = true;
	        construc.params.rotate = true;
	        construc.params.width = 80;
	        construc.params.height = 80;
          construc.params.resizeLimit = {};
					construc.params.resizeLimit.width = { min: 20, max: 300 };
          construc.params.resizeLimit.height = { min: 20, max: 300 };
					
	        construc.push({
	            'text': dividerObj.text,
	            'x': '0',
	            'y': '20',
	            'fill': typeObj,
						  'fill-opacity':'.5',
	            'stroke': typeObj,
	            'fontSize': dividerObj.size + 'px',
	            "strokeWidth": "1px",
						  "opacity":'1' // TODO: added
	        });
	    }

	    if (classObj === 'stair') {
	        construc.params.bindBox = true;
	        construc.params.move = true;
	        construc.params.resize = true;
	        construc.params.rotate = true;
	        construc.params.width = 60;
	        construc.params.height = 180;
	        if (typeObj === 'simpleStair' && typeof dividerObj == 'number' && dividerObj != 0) {
						
	            pushToConstruc(construc,
	                "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 + " L " + sizeObj / 2 + "," +
	                thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2) + " Z", "#fff", "#000", '');
							
	            let heightStep = thickObj / (dividerObj);
	            for (let i = 1; i < dividerObj + 1; i++) {
	                pushToConstruc(construc, "M " + (-sizeObj / 2) + "," + ((-thickObj / 2) + (i * heightStep)) + " L " + (sizeObj / 2) + "," +
	                    ((-thickObj / 2) + (i * heightStep)), "none", "#000", 'none');
	            }
	            construc.params.resizeLimit.width = { min: 40, max: 200 };
	            construc.params.resizeLimit.height = { min: 40, max: 400 };
	        }
	    }

			// Added new options via:
			// 1. create and shave svg shape in Pixelmator, placing center of shape in top-left corner (so only a quarter of the shape is visible)
			// 2. copy svg path from svg file in here, and translate to relative svg path: https://svg-path.com/
			// 3. copy relative svg path below

	    if (classObj === 'energy') {
	        construc.params.bindBox = true;
	        construc.params.move = true;
	        construc.params.resize = true;
	        construc.params.rotate = true;
          construc.params.resizeLimit = {};
					construc.params.resizeLimit.width = { min: 20, max: 300 };
          construc.params.resizeLimit.height = { min: 20, max: 300 };
					
					/*
          pushToConstruc(construc,
              "M " + (-sizeObj / 2) + "," + (-thickObj / 2) + " L " + (-sizeObj / 2) + "," + thickObj / 2 + " L " + sizeObj / 2 + "," +
              thickObj / 2 + " L " + sizeObj / 2 + "," + (-thickObj / 2) + " Z", "#fff", "#000", '');
					*/
	        if (typeObj === 'circle') {
            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "", "#333", '');
            construc.params.width = 80;
            construc.params.height = 80;
            construc.family = 'free';
	        }
	        if (typeObj === 'half-circle') {
            pushToConstruc(construc, "m 40 20 L 40 20 C 40 -2.09 22.09 -20 0 -20 C -22.09 -20 -40 -2.09 -40 20 L 40 20 Z", "#fff", "#333", '');
            construc.params.width = 80;
            construc.params.height = 40;
            construc.family = 'free';
	        }
					
	        if (typeObj === 'square') {
	            pushToConstruc(construc, "m -20,-20 l 40,0 l0,40 l-40,0 Z", "", "#333", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'crossed-square') {
	            pushToConstruc(construc, "m -18.97 19.51 L -18.97 -18.54 L -18.97 -19.51 L 19 -19.51 L 19 19.51 L 18.05 19.51 Z", "", "#888", '');
							pushToConstruc(construc, "m -18.97 19.51 L 18.97 -19.51 L -18.97 -19.51 L 19 19.51 Z", "", "#888", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'eye') {
	            pushToConstruc(construc, "m 0.35 14.13 C -12.25 14.14 -22.47 1.83 -22.68 1.21 C -23.17 -0.3 -12.63 -11.74 -0.03 -11.76 C 12.58 -11.77 23.18 0.12 23 1.16 C 22.93 1.57 13.39 13.9 1.03 14.12 L 0.35 14.13 Z M 0.67 8.18 C 0.93 8.18 1.19 8.17 1.46 8.14 C 5.69 7.72 8.78 4.03 8.36 -0.12 C 7.93 -4.26 4.16 -7.28 -0.08 -6.88 L -0.15 -6.87 C -4.39 -6.43 -7.46 -2.72 -7.02 1.42 C -6.6 5.3 -3.24 8.19 0.67 8.18 Z", "#f66", "#933", '');
	            construc.params.width = 40;
	            construc.params.height = 20;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'heart') {
						  // 						construc, path, fill, stroke, strokeDashArray, opacity = 1
	            pushToConstruc(construc, "m 11.73 2.96 C 10.7 4.85 9.24 6.69 7.35 8.49 C 5.46 10.28 3.22 11.99 0.63 13.62 C 0.47 13.72 0.3 13.81 0.13 13.88 C -0.18 14.04 -0.55 14.04 -0.86 13.88 C -1.03 13.81 -1.2 13.72 -1.36 13.62 C -3.94 11.99 -6.18 10.28 -8.07 8.49 C -9.97 6.69 -11.43 4.85 -12.46 2.96 C -13.49 1.06 -14 -0.91 -14 -2.84 C -14 -4.44 -13.66 -5.8 -12.98 -7.04 C -12.35 -8.24 -11.4 -9.24 -10.24 -9.95 C -9.08 -10.65 -7.75 -11.02 -6.39 -11 C -5.04 -11 -3.82 -10.66 -2.81 -9.98 C -1.79 -9.31 -0.95 -8.4 -0.36 -7.34 C 0.22 -8.4 1.06 -9.31 2.08 -9.98 C 3.1 -10.66 4.32 -11 5.66 -11 C 7.02 -11.02 8.36 -10.65 9.51 -9.95 C 10.67 -9.24 11.62 -8.24 12.26 -7.04 C 12.93 -5.8 13.27 -4.44 13.27 -2.84 C 13.27 -0.91 12.76 1.06 11.73 2.96 Z", "#f00", "#333", '');
	            construc.params.width = 50;
	            construc.params.height = 50;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'droplet') {
	            pushToConstruc(construc, "m 2 13a5 5 0 0 0 10 0c0-1.73-1.66-5.03-5-9.65C3.66 7.97 2 11.27 2 13zM7 0c4.67 6.09 7 10.42 7 13a7 7 0 0 1-14 0c0-2.58 2.33-6.91 7-13z", "#44f", "#333", '');
	            construc.params.width = 20;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'triangle') {
	            pushToConstruc(construc, "m 0 -16.5 L -18 15 L 18 15 Z", "", "#333", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'dome') {
	            pushToConstruc(construc, "m 20 0 L 20 0 C 20 -11.05 11.05 -20 0 -20 C -11.05 -20 -20 -11.05 -20 0 L -20 20 L 20 20 L 20 0 Z", "", "#333", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'flower') {
	            pushToConstruc(construc, "m 4.1 -9.9 C 9.13 -22.03 -9.13 -22.03 -4.1 -9.9 C -9.13 -22.03 -22.03 -9.13 -9.9 -4.1 C -22.03 -9.13 -22.03 9.13 -9.9 4.1 C -22.03 9.13 -9.13 22.03 -4.1 9.9 C -9.13 22.03 9.13 22.03 4.1 9.9 C 9.13 22.03 22.03 9.13 9.9 4.1 C 22.03 9.13 22.03 -9.13 9.9 -4.1 C 22.03 -9.13 9.12 -22.03 4.1 -9.9 Z", "#8f8", "#333", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'leaf') {
	            pushToConstruc(construc, "m19.538679-40s1.891464 5.83535 4.961239 14.263565c3.069777 8.428215 5.674416 12.220772.310078 18.294571-4.326512 4.897369-17.178302 10.222321-18.294574 13.333336-1.099219 3.067901.667281 7.162781 4.651163 4.961243 3.792242-2.096428 15.893952-16.933655 17.364341-17.984498 0 0 1.24031 6.008683 1.24031 10.23256 0 3.279373-.263879 10.123413-2.170541 11.782943-1.391943 1.211468-9.629778 5.660164-16.744188 6.511628-4.704797.563095-9.841857 2.546974-6.20155 4.961242 4.446521 2.949143 16.91535-5.32465 22.63566-5.891475 0 0-.305422 5.133655-.930233 7.131786-1.195967 3.82481-5.292099 12.403099-14.263566 12.403099-6.09674 0-9.839066-3.082474-9.922481-4.961239-.089925-2.028526-3.199065-1.971786-3.410853-.310078-.174882 1.371464-2.181396 5.271317-9.302325 5.271317-7.144804 0-19.077206-6.942638-20.155039-14.263565-1.047751-7.117516.930233-7.44186.930233-7.44186s13.401863 9.922477 22.945736 9.922477c9.319075 0-1.297362-4.880313-4.651162-6.201549-3.353802-1.321236-17.364341-7.713478-17.364341-11.782944 0-4.17643-.755966-10.595039 8.992247-18.604652 0 0 6.223874 14.475662 9.612403 18.604652 3.38853 4.128983 9.79566 4.826981 9.302326.310074-.473803-4.338303-16.397516-21.178291-13.643411-25.736435 3.143879-5.204964 9.436281-11.968994 14.573644-13.023254 0 0 .003718 9.0093.930232 13.953491s4.439385 9.322174 6.821706 5.891472c2.600003-3.744492-4.031008-15.547295-4.031008-17.984497 0-2.437203 7.127127-13.64341 15.813954-13.64341z", "#8f8", "#333", '');
	            construc.params.width = 30;
	            construc.params.height = 30;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'star') {
	            pushToConstruc(construc, "m 0.5 -11 L -3.42 -4.18 L -11.39 -2.71 L -5.85 2.98 L -6.85 10.71 L 0.5 7.41 L 7.85 10.71 L 6.85 2.98 L 12.39 -2.71 L 4.42 -4.18 Z", "#ff0", "#333", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'rounded-square') {
	            pushToConstruc(construc, "m -18 11 C -18 15.97 -13.97 20 -9 20 L 11 20 C 15.97 20 20 15.97 20 11 L 20 -9 C 20 -13.97 15.97 -18 11 -18 L -9 -18 C -13.97 -18 -18 -13.97 -18 -9 Z", "", "#333", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'paw') {
	            pushToConstruc(construc, "m 9.87 19 C 6.63 19 5.72 17.22 0 17.22 C -5.72 17.22 -6.63 19 -9.87 19 C -14.29 19 -15.02 15.3 -15.02 13.38 C -15.02 10.12 -12.62 8.11 -8.84 5.24 C -5.15 2.43 -5.03 -1.42 0 -1.42 C 5.03 -1.42 5.15 2.43 8.84 5.24 C 12.62 8.11 15.02 10.12 15.02 13.38 C 15.02 15.3 14.29 19 9.87 19 Z M -6.68 -17.98 C -4.08 -18.3 -1.47 -14.37 -0.97 -10.3 C -0.47 -6.22 -2.28 -3.55 -4.87 -3.23 C -7.47 -2.91 -9.87 -5.07 -10.37 -9.14 C -10.87 -13.21 -9.27 -17.66 -6.68 -17.98 Z M -16.51 -9.31 C -14.17 -10.03 -11.11 -6.83 -9.99 -3.14 C -8.87 0.54 -10.11 3.31 -12.45 4.04 C -14.8 4.76 -17.37 3.15 -18.49 -0.53 C -19.61 -4.22 -18.86 -8.59 -16.51 -9.31 Z M 6.68 -17.98 C 4.08 -18.3 1.47 -14.37 0.97 -10.3 C 0.47 -6.22 2.28 -3.55 4.87 -3.23 C 7.47 -2.91 9.87 -5.07 10.37 -9.14 C 10.87 -13.21 9.27 -17.66 6.68 -17.98 Z M 16.51 -9.31 C 14.17 -10.03 11.11 -6.83 9.99 -3.14 C 8.87 0.54 10.11 3.31 12.46 4.04 C 14.8 4.76 17.37 3.15 18.49 -0.53 C 19.61 -4.22 18.86 -8.59 16.51 -9.31 Z", "#aaf", "#aaf", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
					// 17.85 28.54
	        if (typeObj === 'note') {
	            pushToConstruc(construc, "m 8.85 8.54 C 10.55 6.59 11.47 3.73 11.47 0.59 C 11.47 -5.7 3.62 -8.84 3.62 -8.84 L 3.62 12.96 L 3.62 12.96 C 3.62 14.91 2.1 17.06 -0.35 18.22 C -1.38 18.72 -2.5 18.98 -3.64 19 C -5.49 19 -7.06 18.24 -7.7 16.83 C -7.9 16.4 -8 15.94 -8 15.47 C -8 13.52 -6.47 11.37 -4.03 10.21 C -3 9.71 -1.88 9.44 -0.74 9.43 C 0.53 9.42 1.66 9.79 2.46 10.47 L 2.46 -19 L 3.62 -19 C 3.62 -14.2 6.82 -12.24 9.58 -8.4 C 11.26 -6.05 12.63 -3.42 12.63 -0.29 C 12.63 3.24 11.24 6.33 8.85 8.54 Z", "#8f8", "#333", '');
	            construc.params.width = 30;
	            construc.params.height = 60;
	            construc.family = 'free';
	        }
					
					
	        if (typeObj === 'wifi') {
	            pushToConstruc(construc, "m 16.66 -6.5 C 16.49 -6.33 16.26 -6.23 16.02 -6.23 C 15.78 -6.24 15.56 -6.34 15.39 -6.51 C 11.4 -10.81 5.83 -13.25 0 -13.25 C -5.83 -13.25 -11.4 -10.81 -15.39 -6.51 C -15.56 -6.34 -15.78 -6.24 -16.02 -6.23 C -16.26 -6.23 -16.49 -6.33 -16.66 -6.5 L -18.74 -8.6 C -19.08 -8.93 -19.09 -9.49 -18.76 -9.84 C -13.88 -15.05 -7.1 -18 0 -18 C 7.1 -18 13.88 -15.05 18.76 -9.84 C 19.09 -9.49 19.08 -8.94 18.74 -8.6 Z M 0 -8.47 C 4.63 -8.47 9.04 -6.49 12.14 -3.02 C 12.46 -2.66 12.45 -2.11 12.11 -1.77 L 10.02 0.35 C 9.84 0.53 9.61 0.62 9.36 0.62 C 9.12 0.61 8.88 0.5 8.72 0.31 C 6.52 -2.24 3.34 -3.7 0 -3.7 C -3.34 -3.7 -6.52 -2.24 -8.72 0.31 C -8.88 0.5 -9.11 0.61 -9.36 0.62 C -9.61 0.62 -9.84 0.53 -10.02 0.35 L -12.11 -1.77 C -12.45 -2.11 -12.46 -2.66 -12.13 -3.02 C -9.03 -6.49 -4.62 -8.47 0 -8.47 Z M 0 1.07 C 2.16 1.06 4.2 2.05 5.55 3.75 C 5.83 4.1 5.8 4.62 5.48 4.94 L 0.64 9.74 C 0.28 10.09 -0.28 10.09 -0.64 9.74 L -5.48 4.94 C -5.8 4.62 -5.83 4.1 -5.55 3.75 C -4.2 2.05 -2.15 1.06 0 1.07 Z", "#00f", "#00f", '');
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
					
	        if (typeObj === 'bed') {
	            pushToConstruc(construc, "m 10 10 L -10 10 L -10 20 L 10 20 Z", "#fff", "#333", '');
							pushToConstruc(construc, "m 10 -20 L -10 -20 L -10 10 L 10 10 Z", "#ccc", "#333", '');
							pushToConstruc(construc, "m 7 14.5 C 7 13.12 5.88 12 4.5 12 L -4.5 12 C -5.88 12 -7 13.12 -7 14.5 C -7 15.88 -5.88 17 -4.5 17 L 4.5 17 C 5.88 17 7 15.88 7 14.5 Z", "#ccc", "#333", '');
	            construc.params.width = 120;
	            construc.params.height = 200;
	            construc.family = 'free';
	        }
					
					
	        if (typeObj === 'double-bed') {
						
              //pushToConstruc(construc, "m 100 50 L -100 50 L -100 100 L 100 100 Z", "#fff", "#333", '');
						  //pushToConstruc(construc, "m 100 -100 L -100 -100 L -100 50 L 100 50 Z", "#ccc", "#333", '');
						  //pushToConstruc(construc, "m 80 72.5 C 80 65.6 74.4 60 67.5 60 L 22.5 60 C 15.6 60 10 65.6 10 72.5 C 10 79.4 15.6 85 22.5 85 L 67.5 85 C 74.4 85 80 79.4 80 72.5 Z", "#ccc", "#333", '');
            
	            pushToConstruc(construc, "m 20 10 L -20 10 L -20 20 L 20 20 Z", "#fff", "#333", '');
							pushToConstruc(construc, "m 20 -20 L -20 -20 L -20 10 L 20 10 Z", "#ccc", "#333", '');
							pushToConstruc(construc, "m 16 14.5 C 16 13.12 14.88 12 13.5 12 L 4.5 12 C 3.12 12 2 13.12 2 14.5 C 2 15.88 3.12 17 4.5 17 L 13.5 17 C 14.88 17 16 15.88 16 14.5 Z M -3 14.5 C -3 13.12 -4.12 12 -5.5 12 L -14.5 12 C -15.88 12 -17 13.12 -17 14.5 C -17 15.88 -15.88 17 -14.5 17 L -5.5 17 C -4.12 17 -3 15.88 -3 14.5 Z", "#ccc", "#333", '');
	            construc.params.width = 200;
	            construc.params.height = 200;
	            construc.family = 'free';
	        }
					
					
	        if (typeObj === 'couch') {
	            pushToConstruc(construc, "m 25.97 17 L -19.49 17 C -24.32 17 -28.28 13.04 -28.28 8.21 L -28.28 -8.14 C -28.28 -12.98 -24.32 -16.93 -19.49 -16.93 L 25.97 -16.93 C 30.81 -16.93 34.76 -12.98 34.76 -8.14 L 34.76 8.21 C 34.76 13.04 30.81 17 25.97 17", "#fff", "#333", '');
							pushToConstruc(construc, "m 36.87 6.88 L 34.22 6.88 C 32.55 6.88 31.18 5.52 31.18 3.85 L 31.18 -13.9 C 31.18 -15.57 32.55 -16.93 34.22 -16.93 L 36.87 -16.93 C 38.54 -16.93 39.9 -15.57 39.9 -13.9 L 39.9 3.85 C 39.9 5.52 38.54 6.88 36.87 6.88 M -27.73 6.88 L -30.38 6.88 C -32.05 6.88 -33.42 5.52 -33.42 3.85 L -33.42 -13.9 C -33.42 -15.57 -32.05 -16.93 -30.38 -16.93 L -27.73 -16.93 C -26.07 -16.93 -24.7 -15.57 -24.7 -13.9 L -24.7 3.85 C -24.7 5.52 -26.07 6.88 -27.73 6.88", "#ccc", "#333", '');
							pushToConstruc(construc, "m 31.73 17 L -25.24 17 C -28.88 17 -31.86 14.02 -31.86 10.38 L -31.86 10.38 C -31.86 6.75 -28.88 3.77 -25.24 3.77 L 31.73 3.77 C 35.37 3.77 38.34 6.75 38.34 10.38 L 38.34 10.38 C 38.34 14.02 35.37 17 31.73 17", "#fff", "#333", '');
							construc.params.width = 80;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
					
	        if (typeObj === 'tv') {
	            pushToConstruc(construc, "m-25.972872-4.574562h51.567162l5.769916 11.19516h-63.106718z", "#fff", "#333", '');
							pushToConstruc(construc, "m-25.285498-4.071335-5.112459 10.054611h60.41761l-5.112734-10.054611z", "#ccc", "#333", '');
							pushToConstruc(construc, "m-30.660994 8h61.31688l.70832-1.379402h-63.106718z", "#ccc", "#333", '');
	            construc.params.width = 100;
	            construc.params.height = 30;
	            construc.family = 'free';
	        }
					
					
	        if (typeObj === 'sink') {
	            //pushToConstruc(construc, "m160 49.5c0-70.968597-57.531403-128.5-128.5-128.5-70.96859 0-128.5 57.531403-128.5 128.5 0 70.96859 57.53141 128.5 128.5 128.5 70.968597 0 128.5-57.53141 128.5-128.5z", "#fff", "#333", '');
							pushToConstruc(construc, "m-9 34c-.552282 0-1-.447716-1-1s.447718-1 1-1 1 .447716 1 1-.447718 1-1 1zm17 0c-.552283 0-1-.447716-1-1s.447717-1 1-1c.552282 0 1 .447716 1 1s-.447718 1-1 1zm-8.5-10c-15.187801 0-27.5-12.312195-27.5-27.5s12.312199-27.5 27.5-27.5 27.5 12.312195 27.5 27.5c0 15.020439-12.043373 27.22496-27 27.492188-.166652.002979-.332637.007812-.5.007812z", "#fff", "#333", '');
				      pushToConstruc(construc, "m-2 34c0 1.104568.895431 2 2 2s2-.895432 2-2v-26c0-1.104568-.895431-2-2-2s-2 .895432-2 2z", "#fff", "#333", '');
							
							construc.params.width = 25;
	            construc.params.height = 50;
	            construc.family = 'free';
	        }
					
					
	        if (typeObj === 'lock') {
	            pushToConstruc(construc, "m 10.31 20 L -10.88 20 C -12.6 20 -14 18.61 -14 16.9 L -14 -0.16 C -14 -1.87 -12.6 -3.26 -10.88 -3.26 L -10.73 -3.26 L -10.73 -9.61 C -10.73 -15.35 -6.05 -20 -0.29 -20 C 5.48 -20 10.16 -15.35 10.16 -9.61 L 10.16 -3.26 L 10.31 -3.26 C 12.03 -3.26 13.43 -1.87 13.43 -0.16 L 13.43 16.9 C 13.43 18.61 12.03 20 10.31 20 Z M 7.04 -9.61 C 7.04 -13.64 3.76 -16.9 -0.29 -16.9 C -4.33 -16.9 -7.61 -13.64 -7.61 -9.61 L -7.61 -3.26 L 7.04 -3.26 L 7.04 -9.61 Z", "#990", "#333", '');
				      construc.params.width = 25;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
	        if (typeObj === 'pill') {
	            pushToConstruc(construc, "M -10.077519 10 C -15.557549 10 -20 5.522842 -20 0 C -20 -5.522842 -15.557549 -10 -10.077519 -10 L 10.077518 -10 C 15.557549 -10 20 -5.522842 20 0 C 20 5.522842 15.557549 10 10.077518 10 L -10.077519 10 Z", "#fff", "#333", '');
				      construc.params.width = 30;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
					
					
					
					
	        if (typeObj === 'gtl') {
	            pushToConstruc(construc, "m -20,-20 l 40,0 l0,40 l-40,0 Z", "#fff", "#333", '');
	            construc.push({
	                'text': "GTL",
	                'x': '0',
	                'y': '5',
	                'fill': "#333333",
	                'stroke': "none",
	                'fontSize': '0.9em',
	                "strokeWidth": "0.4px"
	            });
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'switch') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#333", '');
	            pushToConstruc(construc, qSVG.circlePath(-2, 4, 5), "none", "#333", '');
	            pushToConstruc(construc, "m 0,0 5,-9", "none", "#333", '');
	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';

	        }
	        if (typeObj === 'doubleSwitch') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#333", '');
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 4), "none", "#333", '');
	            pushToConstruc(construc, "m 2,-3 5,-8 3,2", "none", "#333", '');
	            pushToConstruc(construc, "m -2,3 -5,8 -3,-2", "none", "#333", '');
	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'dimmer') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#333", '');
	            pushToConstruc(construc, qSVG.circlePath(-2, 4, 5), "none", "#333", '');
	            pushToConstruc(construc, "m 0,0 5,-9", "none", "#333", '');
	            pushToConstruc(construc, "M -2,-6 L 10,-4 L-2,-2 Z", "none", "#333", '');

	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'plug') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8", "none", "#333", '');
	            pushToConstruc(construc, "m 0,3 v 7", "none", "#333", '');
	            pushToConstruc(construc, "m -10,4 h 20", "none", "#333", '');
	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'plug20') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8", "none", "#333", '');
	            pushToConstruc(construc, "m 0,3 v 7", "none", "#333", '');
	            pushToConstruc(construc, "m -10,4 h 20", "none", "#333", '');

	            construc.push({
	                'text': "20A",
	                'x': '0',
	                'y': '-5',
	                'fill': "#333333",
	                'stroke': "none",
	                'fontSize': '0.65em',
	                "strokeWidth": "0.4px"
	            });
	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'plug32') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8", "none", "#333", '');
	            pushToConstruc(construc, "m 0,3 v 7", "none", "#333", '');
	            pushToConstruc(construc, "m -10,4 h 20", "none", "#333", '');

	            construc.push({
	                'text': "32A",
	                'x': '0',
	                'y': '-5',
	                'fill': "#333333",
	                'stroke': "none",
	                'fontSize': '0.65em',
	                "strokeWidth": "0.4px"
	            });
	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'roofLight') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "M -8,-8 L 8,8 M -8,8 L 8,-8", "none", "#333", '');

	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'free';
	        }
	        if (typeObj === 'wallLight') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "M -8,-8 L 8,8 M -8,8 L 8,-8", "none", "#333", '');
	            pushToConstruc(construc, "M -10,10 L 10,10", "none", "#333", '');

	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'www') {
	            pushToConstruc(construc, "m -20,-20 l 40,0 l0,40 l-40,0 Z", "#fff", "#333", '');

	            construc.push({
	                'text': "@",
	                'x': '0',
	                'y': '4',
	                'fill': "#333333",
	                'stroke': "none",
	                'fontSize': '1.2em',
	                "strokeWidth": "0.4px"
	            });
	            construc.params.width = 40;
	            construc.params.height = 40;
	            construc.family = 'free';
	        }
	        if (typeObj === 'rj45') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "m-10,5 l0,-10 m20,0 l0,10", "none", "#333", '');
	            pushToConstruc(construc, "m 0,5 v 7", "none", "#333", '');
	            pushToConstruc(construc, "m -10,5 h 20", "none", "#333", '');

	            construc.push({
	                'text': "RJ45",
	                'x': '0',
	                'y': '-5',
	                'fill': "#333333",
	                'stroke': "none",
	                'fontSize': '0.5em',
	                "strokeWidth": "0.4px"
	            });
	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'tv-plug') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "m-10,5 l0-10 m20,0 l0,10", "none", "#333", '');
	            pushToConstruc(construc, "m-7,-5 l0,7 l14,0 l0,-7", "none", "#333", '');
	            pushToConstruc(construc, "m 0,5 v 7", "none", "#333", '');
	            pushToConstruc(construc, "m -10,5 h 20", "none", "#333", '');

	            construc.push({
	                'text': "TV",
	                'x': '0',
	                'y': '-5',
	                'fill': "#333333",
	                'stroke': "none",
	                'fontSize': '0.5em',
	                "strokeWidth": "0.4px"
	            });
	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }

	        if (typeObj === 'heater') {
	            pushToConstruc(construc, qSVG.circlePath(0, 0, 16), "#fff", "#000", '');
	            pushToConstruc(construc, "m-15,-4 l30,0", "none", "#333", '');
	            pushToConstruc(construc, "m-14,-8 l28,0", "none", "#333", '');
	            pushToConstruc(construc, "m-11,-12 l22,0", "none", "#333", '');
	            pushToConstruc(construc, "m-16,0 l32,0", "none", "#333", '');
	            pushToConstruc(construc, "m-15,4 l30,0", "none", "#333", '');
	            pushToConstruc(construc, "m-14,8 l28,0", "none", "#333", '');
	            pushToConstruc(construc, "m-11,12 l22,0", "none", "#333", '');

	            construc.params.width = 36;
	            construc.params.height = 36;
	            construc.family = 'stick';
	        }
	        if (typeObj === 'radiator') {
	            pushToConstruc(construc, "m -20,-10 l 40,0 l0,20 l-40,0 Z", "#fff", "#333", '');
	            pushToConstruc(construc, "M -15,-10 L -15,10", "#fff", "#333", '');
	            pushToConstruc(construc, "M -10,-10 L -10,10", "#fff", "#333", '');
	            pushToConstruc(construc, "M -5,-10 L -5,10", "#fff", "#333", '');
	            pushToConstruc(construc, "M -0,-10 L -0,10", "#fff", "#333", '');
	            pushToConstruc(construc, "M 5,-10 L 5,10", "#fff", "#333", '');
	            pushToConstruc(construc, "M 10,-10 L 10,10", "#fff", "#333", '');
	            pushToConstruc(construc, "M 15,-10 L 15,10", "#fff", "#333", '');

	            construc.params.width = 40;
	            construc.params.height = 20;
	            construc.family = 'stick';
	        }
	    }

	    if (classObj === 'furniture') {
	        //construc.params.bindBox = true;
	        construc.params.bindBox = false;
					construc.params.move = true;
	        construc.params.resize = true;
	        construc.params.rotate = true;
	    }

	    return construc;
	}

	function setBestEqPoint(bestEqPoint, distance, index, x, y, x1, y1, x2, y2, way) {
	    bestEqPoint.distance = distance;
	    bestEqPoint.node = index;
	    bestEqPoint.x = x;
	    bestEqPoint.y = y;
	    bestEqPoint.x1 = x1;
	    bestEqPoint.y1 = y1;
	    bestEqPoint.x2 = x2;
	    bestEqPoint.y2 = y2;
	    bestEqPoint.way = way;
	}

	function pushToRibMaster(ribMaster, firstIndex, secondIndex, wallIndex, crossEdge, side, coords, distance) {
	    ribMaster[firstIndex][secondIndex].push({
	        wallIndex: wallIndex,
	        crossEdge: crossEdge,
	        side: side,
	        coords: coords,
	        distance: distance
	    });
	}

	function pushToConstruc(construc, path, fill, stroke, strokeDashArray, opacity = 1) {
	    construc.push({
	        'path': path,
	        'fill': fill,
	        'stroke': stroke,
	        'strokeDashArray': strokeDashArray,
	        'opacity': opacity
	    });
	}
	
	
	
	

	function get_svg(){
		let svg_clone = document.getElementById('extension-floorplanner-lin').cloneNode(true);
		console.log("svg_clone: ", svg_clone);
		svg_clone.querySelector("g#extension-floorplanner-boxgrid").remove();
		svg_clone.querySelector("g#extension-floorplanner-boxScale").remove();
		svg_clone.querySelector("g#extension-floorplanner-boxRib").remove();
		svg_clone.querySelector("g#extension-floorplanner-boxbind").remove();
		svg_clone.querySelector("g#extension-floorplanner-boxArea").remove();
		svg_clone.querySelector("g#extension-floorplanner-boxMeasure").remove();
		return svg_clone;
	}
	
	
	function saveSvg(svgEl, name) {
	    svgEl.setAttribute("xmlns", "http://www.w3.org/2000/svg");
	    var svgData = svgEl.outerHTML;
	    var preface = '<?xml version="1.0" standalone="no"?>\r\n';
	    var svgBlob = new Blob([preface, svgData], {type:"image/svg+xml;charset=utf-8"});
	    var svgUrl = URL.createObjectURL(svgBlob);
	    var downloadLink = document.createElement("a");
	    downloadLink.href = svgUrl;
	    downloadLink.download = name;
	    document.body.appendChild(downloadLink);
	    downloadLink.click();
	    document.body.removeChild(downloadLink);
	}
	
	
	function download(filename, text) {
	    var element = document.createElement('a');
	    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
	    element.setAttribute('download', filename);

	    element.style.display = 'none';
	    document.body.appendChild(element);

	    element.click();

	    document.body.removeChild(element);
	}

	// SVG download button
	document.getElementById("extension-floorplanner-svg-download-button").addEventListener("click", function(){
		saveSvg(get_svg(),"floorplanner.svg");
	}, false);
	
	
	function hide_submenus(){
		document.querySelectorAll('.extension-floorplanner-sub').forEach(function (element) {
			element.style.display='none';
		});
	}


	function toggle_furniture(){
		console.log("in toggle_furniture");
		
		let energy_list_el = document.getElementById('extension-floorplanner-energy_list');
		
		console.log("display?", energy_list_el.style.display);
		if( energy_list_el.style.display == 'block' ){
			hide_submenus();
			//energy_list_el.style.display='none';
		}else{
			hide_submenus();
			energy_list_el.style.display='block';
		}
	}
	
	
	function toggle_layers(){
		let showing = window.getComputedStyle(document.getElementById("extension-floorplanner-layer_list"), null); //.getPropertyCSSValue("display").cssText;
		console.log("showing: ", showing);
		console.log("showing 2: ", showing.getPropertyValue('display'));
		//hide_submenus();
		if(showing.getPropertyValue('display')=='block'){
			document.querySelector('#extension-floorplanner-layer_list').style.display='none';
		}
		else{
			document.querySelector('#extension-floorplanner-layer_list').style.display='block';
		}
	}
	
	function toggle_object_list(){
		let showing = window.getComputedStyle(document.getElementById("extension-floorplanner-object_list"), null); //.getPropertyCSSValue("display").cssText;
		console.log("showing: ", showing);
		console.log("showing 2: ", showing.getPropertyValue('display'));
		//hide_submenus();
		if(showing.getPropertyValue('display')=='block'){
			document.querySelector('#extension-floorplanner-object_list').style.display='none';
		}
		else{
			document.querySelector('#extension-floorplanner-object_list').style.display='block';
		}
	}
	
	
	function new_floorplan(){
		if(WALLS.length || ROOM.length || OBJDATA.length){
			document.getElementById('extension-floorplanner-plan-exists-warning').style.display = 'block';
		}
		else{
			document.getElementById('extension-floorplanner-plan-exists-warning').style.display = 'none';
		}
		document.querySelector('#extension-floorplanner-myModal').style.display = 'block';
	}
	

	function clear_floorplan(force = false,clear_local_storage=true){
		console.log("in clear_floorplan. force: ", force);
		
		if(WALLS.length == 0 && ROOM.length == 0 && OBJDATA.length == 0){
			console.log("clear_floorplan: WALLS, ROOM and OBJDATA are empty, setting force to true");
			force = true;
		}
		
		if(force == false){
			force = confirm("Are you sure you want to erase everything on the current floorplan?");
		}
		
		if(force){
			console.log("clearing floorplan");
			if(clear_local_storage){
				localStorage.removeItem('extension-floorplanner-history');
				current_filename = null;
				localStorage.removeItem('extension-floorplanner-current-filename');
				document.getElementById('extension-floorplanner-current-filename').textContent = '';
			}
			
	    for (let k in OBJDATA) {
	        OBJDATA[k].graph.remove();
	    }
		
		  current_filename = null;
			WALLS = [];
			OBJDATA = [];
			ROOM = [];
			HISTORY = [];
			wallSize = 20;
			partitionSize = 8;
			drag = 'off';
			action = 0;
			magnetic = 0;
			construc = 0;
			Rcirclebinder = 8;
			mode = 'select_mode';
			grid = 20;
			meter = 60;
			colorline = "#fff";
			colorroom = "#f0daaf";
			colorWall = "#666";
			pox = 0;
			poy = 0;
			segment = 0;
			xpath = 0;
			ypath = 0;
			width_viewbox = taille_w;
			height_viewbox = taille_h;
			ratio_viewbox = height_viewbox / width_viewbox;
			originX_viewbox = 0;
			originY_viewbox = 0;
			zoom = 9;
			factor = 1;

			sizeText = [];
			showAllSizeStatus = 0;
		
			document.querySelector("g#extension-floorplanner-boxText").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxgrid").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxScale").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxRib").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxMeasure").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxbind").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxArea").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxpath").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxSurface").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxwall").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxRoom").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxcarpentry").replaceChildren();
			document.querySelector("g#extension-floorplanner-boxEnergy").replaceChildren();
		}
	}


	function delete_floorplan(){
		if(current_filename == null){
			console.error("cannot delete, no current floorplan set. Attempting clear instead");
			clear_floorplan();
		}
		else if(typeof floorplans[current_filename] != 'undefined'){
			console.error("deleting: ", current_filename);
			delete floorplans[current_filename];
			localStorage.setItem('extension-floorplanner-floorplans', JSON.stringify(floorplans));
			localStorage.removeItem('extension-floorplanner-current-filename');
			clear_floorplan(true);
			document.getElementById('extension-floorplanner-current-filename').textContent = '';
			generate_floorplans_list();
		}
		
		if(floorplans.length == 0){
			console.log("all floorplans have been deleted");
		}
		else{
			console.error('cannot delete, no current_filename');
			//floorplans[floorplans.length-1];
		}
	}


	function save_to_floorplans(){
		console.log("in save_to_floorplans. HISTORY: ", HISTORY);
		if(HISTORY.length){
			let last_version = HISTORY[ HISTORY.length -1 ];
			console.log("save_to_floorplans: last_version: ", last_version);
			let svg_image = get_svg();
			console.log("svg_image: ", svg_image);
			
	    svg_image.setAttribute("xmlns", "http://www.w3.org/2000/svg");
	    var svgData = svg_image.outerHTML;
	    var preface = '<?xml version="1.0" standalone="no"?>\r\n';
	    var svgBlob = new Blob([preface, svgData], {type:"image/svg+xml;charset=utf-8"});
	    var svgUrl = '' + URL.createObjectURL(svgBlob);
			
			if(current_filename == null){
				current_filename = prompt("Please enter the floorplan's name", "Ground floor");
			}
			//let floorplans_length = Object.keys(floorplans).length;
			if(current_filename != null && current_filename.length > 0){
				if(typeof floorplans[current_filename] == 'undefined'){
					floorplans[current_filename] = {
										'index':Object.keys(floorplans).length,
										'name':current_filename,
										'svg_data':svgData.replaceAll(' id=',' xid='),
										//'svg_image_url':svgUrl,
										'floorplan':last_version
									}
				}
				else{
					// index is not overwritten, as the user migth have re-ordered the floorplan icons.
					floorplans[current_filename]['name'] = current_filename;
					floorplans[current_filename]['svg_data'] = svgData.replaceAll(' id=',' xid=');
					//floorplans[current_filename]['svg_image_url'] = svgUrl;
					floorplans[current_filename]['floorplan'] = last_version;
				}
				
				console.log("floorplans is now: ", floorplans);
				localStorage.setItem('extension-floorplanner-floorplans', JSON.stringify(floorplans));
				unsaved = false;
			}
			localStorage.setItem('extension-floorplanner-current-filename', JSON.stringify(current_filename));
			
			generate_floorplans_list();
			
			
		}
		/*
		floorplanLoad(historyTemp.length - 1, "boot");
    if (HISTORY.index < HISTORY.length) {
        HISTORY.splice(HISTORY.index, (HISTORY.length - HISTORY.index));
        document.querySelector('#extension-floorplanner-redo').classList.add('extension-floorplanner-disabled');
    }
    HISTORY.push(JSON.stringify({ objData: OBJDATA, wallData: WALLS, roomData: ROOM }));
		//console.log("pushed HISTORY: ", HISTORY);
    localStorage.setItem('extension-floorplanner-history', JSON.stringify(HISTORY));
		//console.log("localstorage: ", localStorage.getItem('extension-floorplanner-history'));
    HISTORY.index++;
    if (HISTORY.index > 1) document.querySelector('#extension-floorplanner-undo').classList.remove('extension-floorplanner-disabled');
		*/
	}


	function save_floorplan_as(){
		let copy_filename_suggestion = current_filename;
		if(copy_filename_suggestion == null){
			copy_filename_suggestion = "Ground floor";
		}
		else{
			copy_filename_suggestion = copy_filename_suggestion + ' (copy)';
		}
		let copy_filename = prompt("Please enter the floorplan's name", copy_filename_suggestion);
		console.log("copy_filename: ", copy_filename);
		if(copy_filename != null && copy_filename.length > 0){
			current_filename = copy_filename;
			save_to_floorplans();
		}
	}

	
	function generate_floorplans_list(){
		console.log("in generate_floorplans_list");
		floorplans_list_el.innerHTML = '';
		let floorplans_length = Object.keys(floorplans).length;
		
		for (var p = 0; p < floorplans_length + 10; p++) {
		
			for (const [key, details] of Object.entries(floorplans)) {
			  //console.log(`${key}: ${details}`);
				if(typeof details.index != 'undefined'){
					//console.log(p, "p =?= details.index?: ", details.index);
					if(p == details.index){
						let floorplan_el = document.createElement('li');
						floorplan_el.classList.add('extension-floorplanner-floorplan-item');
						/*
						let floorplan_image_el = document.createElement('img');
						floorplan_image_el.classList.add('extension-floorplanner-floorplan-item-icon');
						floorplan_image_el.src = details.svg_image_url;
						floorplan_image_el.alt = details.name + ' thumbnail image';
						floorplan_el.appendChild(floorplan_image_el);
						*/
						let floorplan_image_el = document.createElement('div');
						floorplan_image_el.classList.add('extension-floorplanner-floorplan-item-icon');
			
						//if(current_filename != null && current_filename != details.name){
							//console.log("stripping current-svg from icon");
							//details.svg_data = details.svg_data.replace(' class="extension-floorplanner-current-svg"','');
						//}
						if(floorplanner_started){
							//details.svg_data = details.svg_data.replace(' class="extension-floorplanner-current-svg"','');
						}
						
						floorplan_image_el.innerHTML = details.svg_data.replace(' class="extension-floorplanner-current-svg"','');
						floorplan_el.appendChild(floorplan_image_el);
						
						let floorplan_name_el = document.createElement('span');
						floorplan_name_el.classList.add('extension-floorplanner-floorplan-item-name');
						floorplan_name_el.textContent = details.name;
						floorplan_el.appendChild(floorplan_name_el);
						
						console.log("floorplanner_started: ", floorplanner_started);
						
						if(floorplanner_started){
							
							floorplan_el.addEventListener("mouseover", throttle(function (event) {
								if(manual_bg_upload == false && typeof floorplans[key].name == 'string'){
									if(floorplans[key].name != current_filename){
									
								    var preface = '<?xml version="1.0" standalone="no"?>\r\n';
								    var svgBlob = new Blob([preface, details.svg_data], {type:"image/svg+xml;charset=utf-8"});
								    var svgUrl = URL.createObjectURL(svgBlob);
									
										bg_image_el.style.backgroundImage = "url(" + svgUrl + ")";
										bg_image_el.classList.remove('extension-floorplanner-slow-fade-out');
										setTimeout(() => {
											bg_image_el.classList.add('extension-floorplanner-slow-fade-out');
										},1);
									}
									else{
										bg_image_el.style.backgroundImage = "none";
									}
								}
							}, 30));
						
			
							floorplan_el.addEventListener("click", () => {
								console.log("floorplan icon clicked. key: ", key);
								console.log("floorplans x: ", floorplans[key]);
								console.log("current_filename: ", current_filename);
								console.log("unsaved: ", unsaved);
								//var safe_to_save = false;
							
								console.log("types: ", typeof floorplans[key].name, typeof floorplans[key].floorplan);
								if(typeof floorplans[key].name == 'string' && typeof floorplans[key].floorplan == 'string'){
									console.log("types are both string, ok");
									if(floorplans[key].name != current_filename){
										
										if(unsaved){
											if(confirm("Should the changes you have made be saved first?")){
												save_to_floorplans();
											}
										}
										console.log("calling load_from_floorplans");
										load_from_floorplans(details);
									}
									else{
										if(unsaved){
											if(confirm("Are you sure you want to revert to the old version of the floorplan? This will undo any changes you have made.")){
												load_from_floorplans(details);
											}
										}
										else{
											load_from_floorplans(details);
										}
									}
								}
								else{
									console.error("missing attribute(s) in floorplan(s): ", floorplans[key],floorplans);
								}
								bg_image_el.style.backgroundImage = 'none';
						  });
						}
						else{
							floorplan_el.addEventListener("click", () => {
								if(typeof floorplans[key].name == 'string'){
							    //var preface = '<?xml version="1.0" standalone="no"?>\r\n';
							    //var svgBlob = new Blob([preface, details.svg_data], {type:"image/svg+xml;charset=utf-8"});
							    //var svgUrl = URL.createObjectURL(svgBlob);
									
									//bg_image_el.style.backgroundImage = "url(" + svgUrl + ")";
									bg_image_el.innerHTML = details.svg_data;
									let bg_svg = bg_image_el.querySelector('svg');
									if(bg_svg){
										console.log("adding extension-floorplanner-current-svg to bg svg");
										bg_svg.classList.add('extension-floorplanner-current-svg');
									}
									bg_image_el.classList.remove('extension-floorplanner-slow-fade-out');
									
									current_filename = floorplans[key].name;
									document.getElementById('extension-floorplanner-current-filename').textContent = current_filename;
									localStorage.setItem('extension-floorplanner-current-filename', JSON.stringify(current_filename));
									
									zoom_maker('zoomreset',0,0);
									bg_image_el.style.backgroundImage = 'none';
									generate_floorplans_list();
								}
							});
							
							if(typeof floorplans[key].name == 'string' && typeof current_filename == 'string'){
								if(floorplans[key].name == current_filename){
									floorplan_el.classList.add('extension-floorplanner-floorplan-icon-current');
							    //var preface = '<?xml version="1.0" standalone="no"?>\r\n';
							    //var svgBlob = new Blob([preface, details.svg_data], {type:"image/svg+xml;charset=utf-8"});
							    //var svgUrl = URL.createObjectURL(svgBlob);
								
									//bg_image_el.style.backgroundImage = "url(" + svgUrl + ")";
									bg_image_el.innerHTML = details.svg_data;
									let bg_svg = bg_image_el.querySelector('svg');
									if(bg_svg){
										console.log("adding extension-floorplanner-current-svg to bg svg");
										bg_svg.classList.add('extension-floorplanner-current-svg');
									}
									//bg_image_el.classList.remove('extension-floorplanner-slow-fade-out');
									
									document.getElementById('extension-floorplanner-current-filename').textContent = current_filename;
								}
							}
						}
						
			
						floorplans_list_el.appendChild(floorplan_el);
					}
				}
				else{
					console.error("spotted floorplan without index");
				}
			}
		}
		slist(floorplans_list_el);
	}
	
	
	function slist (target) {
	  target.classList.add("extension-floorplanner-slist");
	  let items = target.getElementsByTagName("li"), current = null;

	  for (let i of items) {
	    i.draggable = true;
    
	    i.ondragstart = e => {
	      current = i;
	      for (let it of items) {
	        if (it != current) { it.classList.add("extension-floorplanner-slist-hint"); }
	      }
	    };
    
	    i.ondragenter = e => {
	      if (i != current) { i.classList.add("extension-floorplanner-slist-active"); }
	    };

	    i.ondragleave = () => i.classList.remove("extension-floorplanner-slist-active");

	    i.ondragend = () => {
				console.log("dragEnd");
				var icon_index=0;
				for (let it of items) {
	        it.classList.remove("extension-floorplanner-slist-hint");
	        it.classList.remove("extension-floorplanner-slist-active");
	    	}
				update_floorplans_index();
			};
 
	    i.ondragover = e => e.preventDefault();
 
	    i.ondrop = e => {
	      e.preventDefault();
	      if (i != current) {
	        let currentpos = 0, droppedpos = 0;
	        for (let it=0; it<items.length; it++) {
	          if (current == items[it]) { currentpos = it; }
	          if (i == items[it]) { droppedpos = it; }
	        }
	        if (currentpos < droppedpos) {
	          i.parentNode.insertBefore(current, i.nextSibling);
	        } else {
	          i.parentNode.insertBefore(current, i);
	        }
	      }
	    };
	  }
	}
	
	
	function update_floorplans_index(){
		console.log("in update_floorplans_index");
		let floorplans_icons_els = floorplans_list_el.getElementsByTagName("li");
		var icon_index=0;
		for (let it of floorplans_icons_els) {
			let floorplan_name = it.querySelector('.extension-floorplanner-floorplan-item-name').textContent;
			if(floorplan_name){
				if(typeof floorplans[floorplan_name] != 'undefined'){
					console.log("setting floorplans index");
					floorplans[floorplan_name].index = icon_index;
				}
			}
			icon_index++;
  	}
		localStorage.setItem('extension-floorplanner-floorplans', JSON.stringify(floorplans));
	}
	
	
	
	function load_from_floorplans(details){
		console.log("in load_from_floorplans. details: ", details);
		if(typeof details == 'object'){
			clear_floorplan(true);
			//zoom_maker('zoomreset',0,0);
			//let moisturized = JSON.parse(details.floorplan);
			//console.log("moisturized: ", moisturized );
			HISTORY = [details.floorplan];
			console.log("history: ", HISTORY);
			HISTORY.index = 1;
			current_filename = details.name;
			document.getElementById('extension-floorplanner-current-filename').textContent = details.name;
    	localStorage.setItem('extension-floorplanner-current-filename', JSON.stringify(current_filename));
			//floorplanLoad(0);
	    //floorplanSave();
		
			//localStorage.setItem('extension-floorplanner-history', JSON.stringify([moisturized]));
			localStorage.setItem('extension-floorplanner-history', JSON.stringify([details.floorplan]));
		
	    floorplanLoad(0, "boot");
	    floorplanSave("boot");
			generate_object_list();
		}
	}
	
	
	function bye_binder(){
		//console.log("in bye_binder. binder: ", binder);
		//console.log("bye_binder: typeof binder: ", typeof binder);
		if (typeof (binder) != 'undefined') {
			//console.log("bye_binder: typeof binder.remove: ", typeof binder.remove);
			
			if(typeof binder.graph != 'undefined'){
				//binder.graph.remove();
			}
			if(typeof binder.remove != 'undefined'){
				binder.remove();
			}
			
			binder = (function () { return; })();

		}
		
		if (typeof (binder) != 'undefined') {
			console.error("bye_binder: failed. binder still exists: ", binder);
		}
	}
	
	
	function save_object(){
		console.log("in save_object");
		fonc_button('select_mode');
		document.querySelector('#extension-floorplanner-boxinfo').innerHTML='Selection mode';
		document.querySelector('#extension-floorplanner-objBoundingBox').style.display='none';
		document.querySelector('#extension-floorplanner-panel').style.display='block';
		if(typeof binder != 'undefined' && typeof binder.graph != 'undefined') binder.graph.remove(); // superfluous..
		bye_binder();
		floorplanner_debug();
	}


	/*
	function get_object_icon(object_name){
		console.log('in get_object_icon. object_name: ', object_name);
		let object_button_el = document.querySelector('#extension-floorplanner-energy_list #extension-floorplanner-' + object_name);
		if(object_button_el){
			return object_button_el.textContent[0];
		}
		return '?';
	}
	*/

	function generate_object_list(){
		return;
		if(!floorplanner_started){return}
		object_list_el = document.getElementById('extension-floorplanner-object_list');
		object_list_el.innerHTML = '';
		for (const [key, details] of Object.entries(OBJDATA)) {
		  console.log(`generate_object_list: ${key}: ${details}`);
			console.log("generate_object_list: details: ", details);
			if(typeof details.type == 'string'){
				let object_el = document.createElement('div');
				object_el.classList.add('extension-floorplanner-object-item');
				/*
				let object_image_el = document.createElement('img');
				object_image_el.classList.add('extension-floorplanner-floorplan-item-icon');
				object_image_el.src = details.svg_image_url;
				object_image_el.alt = details.name + ' thumbnail image';
				object_el.appendChild(object_image_el);
				*/
				let object_image_el = document.createElement('div');
				object_image_el.classList.add('extension-floorplanner-object-item-icon');
			
				//object_image_el.innerHTML = details.svg_data;
				//object_el.appendChild(object_image_el);
				
				let object_name_el = document.createElement('span');
				object_name_el.classList.add('extension-floorplanner-object-item-name');
				let object_icon = '??';//get_object_icon(details.type);
				
				let object_button_el = document.querySelector('#extension-floorplanner-energy_list #extension-floorplanner-' + details.type);
				if(object_button_el){
					console.log("found the furniture button for ", details.type);
					
					object_icon = object_button_el.textContent; //[0];
					console.log("object_icon: ", object_icon);
					object_name_el.textContent = object_icon;
					object_el.appendChild(object_name_el);
			
					object_el.addEventListener("click", () => {
						console.log("object icon clicked. key,details: ", key, details);
						root_el.classList.remove('extension-floorplanner-do-not-pulsate');

						objTarget = details;
						mode = 'bind_mode';
						force_obj_edit(details);
					
						console.log('hacky binder: ', binder);
						console.log('hacky objTarget: ', objTarget);
				  });
					if(object_icon != '??'){
						object_list_el.appendChild(object_el);
					}
					
				}
				else{
					console.log("Warning, could not find the furniture button for: ", details.type);
				}
				
			}
			
		}
	}

	

	//let element = document.getElementById('extension-floorplanner-lin');
	let scale = 1.0;
	//let half_scale = 1.0;
	
	linElement.addEventListener("wheel", throttle(function (event) { _MOUSEWHEEL(event); }, 50));
	
	function _MOUSEWHEEL(ev){
	  // This is crucial. Without it, the browser will do a full page zoom
	  ev.preventDefault();

		//console.log("ev.deltaY: ", ev.deltaY);

	  // This is an empirically determined heuristic.
	  // Unfortunately I don't know of any way to do this better.
	  // Typical deltaY values from a trackpad pinch are under 1.0
	  // Typical deltaY values from a mouse wheel are more than 100.
		const absolute_deltaY = Math.abs(ev.deltaY);
	  let isPinch = absolute_deltaY < 50;

		console.log("mousewheel deltaY: ", ev.deltaY);
		console.log("zoom: ",zoom);
		if(absolute_deltaY < 10){
	    if (ev.deltaY > 0) {
	        zoom_maker('zoomin', 20 * absolute_deltaY);
	    } else {
	        zoom_maker('zoomout', 20 * absolute_deltaY);
	    }
		}
		else{
	    if (ev.deltaY > 0) {
	        zoom_maker('zoomin', 200);
	    } else {
	        zoom_maker('zoomout', 200);
	    }
		}
   
	}

	//
	// Let's get this party started
	//
	
	
	
	function clear_selection(){
	 if (window.getSelection) {window.getSelection().removeAllRanges();}
	 else if (document.selection) {document.selection.empty();}
	}
	
	
	function force_obj_edit(obj_target){
		console.log("in force_obj_edit. objTarget: ", objTarget);
		
		var objTarget = obj_target;
		
    if (objTarget.params.bindBox) { // OBJ -> BOUNDINGBOX TOOL
			bye_binder();
			console.warn("select_mode:  OBJTARGET HAS BINDBOX -> setting binder as obj2D boundingbox");
      if (typeof (binder) == 'undefined') {
        binder = new floorplanEditor.obj2D("free", "boundingBox", "", objTarget.bbox.origin, objTarget.angle, 0, objTarget.size*0.5, "normal", objTarget.thick*0.5, objTarget.realBbox);
        binder.update();
        binder.obj = objTarget;
        binder.type = 'boundingBox';
        binder.oldX = binder.x;
        binder.oldY = binder.y;
        document.querySelector('#extension-floorplanner-boxbind').append(binder.graph);
        if (!objTarget.params.move) cursor('trash'); // LIKE MEASURE ON PLAN
        if (objTarget.params.move) {
					console.log("this objTarget.params.move is true, setting move cursor");
					cursor('move');
				}
			}
			
	    if (typeof (binder) != 'undefined' && binder.type == 'boundingBox') {
	      //var moveObj = Math.abs(binder.oldX - binder.x) + Math.abs(binder.oldY - binder.y);
	      
				objTarget = binder.obj;
	      /*
				if (!objTarget.params.move) {
	        // TO REMOVE MEASURE ON PLAN
	        objTarget.graph.remove();
	        OBJDATA.splice(OBJDATA.indexOf(objTarget), 1);
	        document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Measurement deleted';
	      }
				*/
	      //if (moveObj < 1 && objTarget.params.move) {
	        if (!objTarget.params.resize) document.querySelector('#extension-floorplanner-objBoundingBoxScale').style.display='none';
	        else document.querySelector('#extension-floorplanner-objBoundingBoxScale').style.display='block';
	        if (!objTarget.params.rotate) document.querySelector('#extension-floorplanner-objBoundingBoxRotation').style.display='none';
	        else document.querySelector('#extension-floorplanner-objBoundingBoxRotation').style.display='block';
	        document.querySelector('#extension-floorplanner-panel').style.display='none'
	        //console.log(objTarget.params.resizeLimit.width.min)
	        document.querySelector('#extension-floorplanner-objBoundingBox').style.display='block'
	        document.querySelector('#extension-floorplanner-lin').style.cursor ='default';
	        document.querySelector('#extension-floorplanner-boxinfo').innerHTML = 'Modify the object';
	        //console.log(objTarget)
					if(objTarget.params.resizeLimit){
						console.log("object has resize limit: ", objTarget.params.resizeLimit);
					
	          document.getElementById('extension-floorplanner-bboxWidth').setAttribute('min', objTarget.params.resizeLimit.width.min);
	          document.getElementById('extension-floorplanner-bboxWidth').setAttribute('max', objTarget.params.resizeLimit.width.max);
	          //document.getElementById('extension-floorplanner-bboxWidthScale').textContent = objTarget.params.resizeLimit.width.min + "-" + objTarget.params.resizeLimit.height.max;
						document.getElementById('extension-floorplanner-bboxWidthScale-min').textContent = objTarget.params.resizeLimit.width.min;
	          document.getElementById('extension-floorplanner-bboxWidthScale-max').textContent = objTarget.params.resizeLimit.width.max;
						document.getElementById('extension-floorplanner-bboxHeight').setAttribute('min', objTarget.params.resizeLimit.height.min);
	          document.getElementById('extension-floorplanner-bboxHeight').setAttribute('max', objTarget.params.resizeLimit.height.max);
	          //document.getElementById('extension-floorplanner-bboxHeightScale').textContent = objTarget.params.resizeLimit.height.min + "-" + objTarget.params.resizeLimit.height.max;
						document.getElementById('extension-floorplanner-bboxHeightScale-min').textContent = objTarget.params.resizeLimit.height.min;
						document.getElementById('extension-floorplanner-bboxHeightScale-max').textContent = objTarget.params.resizeLimit.height.max;
					}
        
	        document.querySelector('#extension-floorplanner-stepsCounter').style.display='none';
	        if (objTarget.class == 'stair') {
	          document.getElementById("extension-floorplanner-bboxStepsVal").textContent = objTarget.value;
	          document.querySelector('#extension-floorplanner-stepsCounter').style.display='block';
	        }
	        document.getElementById("extension-floorplanner-bboxWidth").value = objTarget.width * 100;
	        document.getElementById("extension-floorplanner-bboxWidthVal").textContent = objTarget.width * 100;
	        document.getElementById("extension-floorplanner-bboxHeight").value = objTarget.height * 100;
	        document.getElementById("extension-floorplanner-bboxHeightVal").textContent = objTarget.height * 100;
	        document.getElementById("extension-floorplanner-bboxRotation").value = objTarget.angle;
	        document.getElementById("extension-floorplanner-bboxRotationVal").textContent = objTarget.angle;
	        mode = 'edit_boundingBox_mode';
				/*
	      }
	      else {
					console.error("failed to force edit. objTarget: ", objTarget);
	        mode = "select_mode";
	        action = 0;
	        if(typeof binder.graph != 'undefined') binder.graph.remove();
	        //delete binder;
					bye_binder();
	      }
				*/
	    }
			
    }
	}




	
	document.getElementById('extension-floorplanner-upload-background-image').addEventListener('change', readFileURL, true);
	function readFileURL(){
	   var file = document.getElementById("extension-floorplanner-upload-background-image").files[0];
	   var reader = new FileReader();
	   reader.onloadend = function(){
			 manual_bg_upload = true;
	     bg_image_el.style.backgroundImage = "url(" + reader.result + ")";   
			 bg_image_el.classList.remove('extension-floorplanner-slow-fade-out');
			 //bg_image_el.style.opacity = '.3';
	   }
	   if(file){
	      reader.readAsDataURL(file);
	   }else{
	   }
	}
	
	
	
	
	
	
	window.addEventListener("load", function () {
		
    document.getElementById('extension-floorplanner-moveBox').style.transform = "translateX(-215px)";
		setTimeout(()=>{
			document.getElementById('extension-floorplanner-zoomBox').style.transform = "translateX(-165px)";
		},300);
    setTimeout(()=>{
			document.getElementById('extension-floorplanner-zoomBox2').style.transform = "translateX(-165px)";
		},300);
		
		if(Object.keys(floorplans).length == 0 || currently_editing == true){
			start_floorplanner();
		}
	});
		
		
		
	function start_floorplanner(){
		console.log("STARTING FLOORPLANNER");
		floorplanner_started = true;
		localStorage.setItem('extension-floorplanner-currently-editing',true);

		//document.querySelector('#extension-floorplanner-recover').innerHTML = "<p>Select a plan type.</p>";
    
		hide_submenus();
		bg_image_el.innerHTML = '';
		generate_floorplans_list();
		root_el.classList.remove('extension-floorplanner-view-mode');
    if (localStorage.getItem('extension-floorplanner-history')) {
			setTimeout(() => {
				initHistory('recovery');
			},500);
    }
		else if (localStorage.getItem('extension-floorplanner-floorplans')) {
			let temp_floorplans = JSON.parse(localStorage.getItem('extension-floorplanner-floorplans'));
			console.log("start_floorplanner: temp_floorplans: ", temp_floorplans);
			
			if(typeof temp_floorplans == 'object' && temp_floorplans != null){
				floorplans = temp_floorplans;
				const floorplans_length = Object.keys(temp_floorplans).length;
				if(floorplans_length){
					console.log("start_floorplanner: floorplans_length: ", floorplans_length);
					console.log("start_floorplanner: current_filename: ", current_filename);
					if(current_filename != null && typeof floorplans[current_filename] != 'undefined'){
						let details = floorplans[current_filename];
						if(typeof details != 'undefined'){
							console.log("start_floorplanner: current_filename details: ", details);
							if(typeof details.name != 'undefined'){
								//current_filename = details.name;
								load_from_floorplans(details);
							}
							else{
								console.log("details did not have name?: ", details);
								//myModal.style.display='block';
							}
						}
						else{
							console.log("page load: details was undefined: ", floorplans_length);
							myModal.style.display='block';
						}
					}
					
				}
				else{
					console.log("floorplans_length failed: ", floorplans_length);
					myModal.style.display='block';
				}
			}
			else{
				console.log("temp_floorplans was not an object: ", temp_floorplans);
				myModal.style.display='block';
			}
			
		}
		else{
			myModal.style.display='block';
		}
		bg_image_el.style.backgroundImage = "none";
	}	
			
	
	function stop_floorplanner(){
		floorplanner_started = false;
		localStorage.setItem('extension-floorplanner-currently-editing',false);
		
		if(Object.keys(floorplans).length == 0){
			save_to_floorplans();
		}
		
		if(Object.keys(floorplans).length > 0){
			floorplanner_started = false;
			hide_submenus();
			clear_floorplan(true,false); // force clear, but don't reset the local storage
			bg_image_el.style.backgroundImage = "none";
			root_el.classList.add('extension-floorplanner-view-mode');
			myModal.style.display='none';
		}
		else{
			alert("Please create and save at least one floorplan");
		}
		floorplanner_started = false;
		generate_floorplans_list();
		
	}
	
	
	function floorplanner_debug(){
		console.error("\n\nDEBUG:");
		console.log("HISTORY:", HISTORY);
		console.log("HISTORY.index: ", HISTORY.index);
		console.log("OBJDATA:", OBJDATA);
		console.log("WALLS:", WALLS);
		console.log("ROOM:", ROOM);
		console.log("current_filename:", current_filename);
		console.log("floorplans:", floorplans);
	}
	
	
	
	
	
	
	
	
	// Unicode lookup  https://symbl.cc/en/unicode/table/#arrows
	// Make SVG path relative https://svg-path.com/
 	
	
</script>

</html>